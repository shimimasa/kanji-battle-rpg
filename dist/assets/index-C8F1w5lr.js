var hs=Object.defineProperty;var Et=e=>{throw TypeError(e)};var ds=(e,t,s)=>t in e?hs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var Tt=(e,t,s)=>ds(e,typeof t!="symbol"?t+"":t,s),at=(e,t,s)=>t.has(e)||Et("Cannot "+s);var M=(e,t,s)=>(at(e,t,"read from private field"),s?s.call(e):t.get(e)),xe=(e,t,s)=>t.has(e)?Et("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),ae=(e,t,s,n)=>(at(e,t,"write to private field"),n?n.call(e,s):t.set(e,s),s),ot=(e,t,s)=>(at(e,t,"access private method"),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function s(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=s(i);fetch(i.href,a)}})();const u={turn:"player",inputEnabled:!0,message:"",comboCount:0,timeRemaining:60,recentKanjiIds:[],currentKanjiIndex:0,mistakesThisStage:0,comboTimer:0,COMBO_TIMER_MAX:300},r={currentStageId:null,gameMode:"challenge",playerName:"",playerStats:{hp:100,maxHp:100,level:1,exp:0,attack:10,healCount:3,nextLevelExp:100,skillPoints:0,enemiesDefeated:0,stagesCleared:0,totalCorrect:0,totalIncorrect:0,comboCount:0,weaknessHits:0,healsSuccessful:0,skillPointsUsed:0,bossesDefeated:0,playtimeSeconds:0},enemies:[],currentEnemyIndex:0,currentEnemy:null,kanjiPool:[],currentKanji:{text:"",readings:[],meaning:""},showHint:!1,correctKanjiList:[],wrongKanjiList:[],unlockedAchievements:new Set};function gs(){r.playerStats.enemiesDefeated++,Ne(),console.log(`📊 倒した敵の数: ${r.playerStats.enemiesDefeated}`)}function us(){r.playerStats.stagesCleared++,Ne(),console.log(`📊 クリアしたステージ数: ${r.playerStats.stagesCleared}`)}function fs(e){r.unlockedAchievements.has(e)||(r.unlockedAchievements.add(e),Ne(),console.log(`🏆 実績解除: ${e}`))}function Ft(e){return r.unlockedAchievements.has(e)}function ms(e){r.playerStats.exp+=e;const t=ps();return Ne(),t}function ps(){const e=r.playerStats;if(e.exp>=e.nextLevelExp){const t=e.level;return e.exp-=e.nextLevelExp,e.level++,e.skillPoints+=1,e.maxHp+=10,e.hp=e.maxHp,e.attack+=2,e.nextLevelExp=Math.floor(e.nextLevelExp*1.2)+20,e.healCount=3,{leveledUp:!0,oldLevel:t,newLevel:e.level}}return{leveledUp:!1}}function Ne(){try{const e={playerName:r.playerName,playerStats:r.playerStats,unlockedAchievements:Array.from(r.unlockedAchievements),saveDate:new Date().toISOString()};localStorage.setItem("kanjiGameSave",JSON.stringify(e)),console.log("💾 ゲームデータを保存しました")}catch(e){console.error("❌ ゲームデータの保存に失敗しました:",e)}}function ys(){try{const e=localStorage.getItem("kanjiGameSave");if(!e)return console.log("💾 セーブデータが見つかりません。新規ゲームを開始します。"),!1;const t=JSON.parse(e);return t.playerName&&(r.playerName=t.playerName),t.playerStats&&Object.assign(r.playerStats,t.playerStats),t.unlockedAchievements&&Array.isArray(t.unlockedAchievements)&&(r.unlockedAchievements=new Set(t.unlockedAchievements)),console.log("💾 ゲームデータを読み込みました"),console.log(`📊 レベル: ${r.playerStats.level}, 倒した敵: ${r.playerStats.enemiesDefeated}, クリアしたステージ: ${r.playerStats.stagesCleared}`),console.log(`🏆 解除済み実績数: ${r.unlockedAchievements.size}`),!0}catch(e){return console.error("❌ ゲームデータの読み込みに失敗しました:",e),!1}}function Ss(){localStorage.removeItem("kanjiGameSave"),console.log("💾 セーブデータを削除しました")}function Lt(e){r.playerName=e.trim(),Ne()}function Ie(e){r.currentStageId=e,r.currentEnemyIndex=0,r.currentEnemy=null,r.enemies=[],r.kanjiPool=[]}ys();const Ve=new Map;function ie(e,t){Ve.has(e)||Ve.set(e,new Set),Ve.get(e).add(t)}function f(e,t){const s=Ve.get(e);if(s)for(const n of s)try{n(t)}catch(i){console.error(`イベント "${e}" のハンドラでエラー発生:`,i)}}function vs(e){console.log("プレイヤーが移動しました:",e)}ie("player:move",vs);f("player:move",{x:10,y:20});ie("changeScreen",e=>{Array.isArray(e)?window.switchScreen(e[0],e[1]):e&&typeof e=="object"&&"name"in e?window.switchScreen(e.name,e.props):window.switchScreen(e)});function ks(e){window.fsm&&typeof window.fsm.update=="function"&&window.fsm.update(e)}function xs(e=null){window.fsm&&typeof window.fsm.render=="function"&&window.fsm.render(e)}const v={},bs={logo:"/assets/images/logo.png",buttonNormal:"/assets/images/button_normal.png",buttonClick:"/assets/images/button_click.png",buttonSelect:"/assets/images/button_select.png",buttonInactive:"/assets/images/button_not_act.png",iconAttack:"/assets/images/icon_attack.png",iconHeal:"/assets/images/icon_heal.png",iconExp:"/assets/images/icon_exp.png",iconHint:"/assets/images/icon_hint.png",iconSetting:"/assets/images/icon_setting.png",markerPref:"/assets/images/stage.select/marker_pref.png",markerLocked:"/assets/images/stage.select/marker_locked.png",markerCleared:"/assets/images/stage.select/marker_cleared.png",panelStone:"/assets/images/ui/panel_stone.png",buttonStoneNormal:"/assets/images/ui/button_stone_normal.png",buttonStoneHover:"/assets/images/ui/button_stone_hover.png",buttonStonePressed:"/assets/images/ui/button_stone_pressed.png",iconOnyomi:"/assets/images/ui/icon_onyomi.png",iconKunyomi:"/assets/images/ui/icon_kunyomi.png",iconLogAttack:"/assets/images/ui/icon_log_attack.png",iconLogHeal:"/assets/images/ui/icon_log_heal.png",iconBookClosed:"/assets/images/ui/icon_book_closed.png",panelPlayer:"/assets/images/ui/panel_player.png",panelEnemy:"/assets/images/ui/panel_enemy.png",stageSelect0:"/assets/images/stage.select/stage.select.png",stageSelect:"/assets/images/stage.select/stage.select.png",stageSelect1:"/assets/images/stage.select/stage.select.1.png",stageSelect2:"/assets/images/stage.select/stage.select.2.png",stageSelect3:"/assets/images/stage.select/stage.select.3.png",stageSelect4:"/assets/images/stage.select/stage.select.4.png",stageSelect5:"/assets/images/stage.select/stage.select.5.png",stageSelect6:"/assets/images/stage.select/stage.select.6.png",japanMap:"/assets/images/stage.select/日本地図.png",worldMap:"/assets/images/stage.select/世界地図.png",woodenSign:"/assets/images/wooden_sign.png",regionMarker:"/assets/images/region_marker.png",titleBackground:"/assets/images/title_background.png",region1Boundary:"/assets/images/regions/hokkaido_boundary.png",region2Boundary:"/assets/images/regions/tohoku_boundary.png",region3Boundary:"/assets/images/regions/kanto_boundary.png",region4Boundary:"/assets/images/regions/chubu_boundary.png",region5Boundary:"/assets/images/regions/kinki_boundary.png",region6Boundary:"/assets/images/regions/chugoku_boundary.png",stageSelect12:"/assets/images/stage.select/stage.select12.png",stageSelect13:"/assets/images/stage.select/stage.select13.png",stageSelect14:"/assets/images/stage.select/stage.select14.png",stageSelect15:"/assets/images/stage.select/stage.select15.png"};async function ws(){const e=Object.entries(bs).map(([t,s])=>(["panelStone","panelPlayer","panelEnemy","iconOnyomi","iconKunyomi"].includes(t)?qe(s):Ts(s)).then(a=>{v[t]=a}).catch(()=>console.warn(`⚠️ ${s} の読み込み失敗`)));await Promise.all(e)}async function Cs(e){const t=`bg_${e}`;if(v[t])return v[t];const s=Date.now();let n="",i=1;const a=e.match(/_area(\d+)$/);a&&a[1]&&(i=parseInt(a[1])%2===0?2:1),e.startsWith("Asie_")?n="asia":e.startsWith("Europe_")?n="europe":e.startsWith("America_")?n="america":e.startsWith("Africa_")?n="africa":n=e.split("_")[0];const o=[`/assets/images/backgrounds/${e}.png?v=${s}`,`/assets/images/backgrounds/${n}_area${i}.png?v=${s}`,`/assets/images/backgrounds/${n}_area1.png?v=${s}`,`/assets/images/stage.select/stage.select${Bs(e)}.png?v=${s}`];for(const l of o)try{console.log(`背景画像を試行: ${l}`);const c=await qe(l);return v[t]=c,console.log(`✅ 背景画像ロード成功: ${l}`),c}catch{console.log(`背景画像ロード失敗: ${l}`)}try{const l=`/assets/images/stage.select/stage.select.png?v=${s}`;console.log(`デフォルト背景画像を試行: ${l}`);const c=await qe(l);return v[t]=c,c}catch{return console.error(`すべての背景画像読み込みに失敗: ${e}`),null}}async function Es(e){if(v[e.id])return v[e.id];const t=e.name||e.id||"モンスター";console.log(`${e.id} (${t}) の画像をロード中...`);const s={1:"grade1-hokkaido",2:"grade2-touhoku",3:"grade3-kantou",4:"grade4-chuubu",5:"grade5-kinki",6:"grade6-chuugoku",7:"proverbs",8:"proverbs",9:"proverbs",10:"proverbs"},n=s[e.grade]||s[1],i=e.id;console.log(`敵ID: ${i}, フォルダ: ${n}, 学年: ${e.grade}`);const a=[];i.startsWith("PRV-")?a.push(`/assets/images/proverbs/full/${i}.webp`,`/image‐pipeline/output/proverbs/full/${i}.webp`,`/image‐pipeline/proverb/proverb_${i.replace("PRV-E","")}.png`):a.push(`/assets/images/monsters/full/${n}/${i}.webp`,`/assets/images/enemy/${i.split("-")[1].replace("E","")}_${t}.png`,`/assets/images/monsters/full/grade1-hokkaido/HKD-${i.split("-")[1]}.webp`,`/assets/images/enemy/${i.split("-")[1].replace("E","")}_${t.split("の")[0]}.png`);for(const d of a)try{console.log(`画像を試行: ${d}`);const m=await qe(d);return console.log(`✅ 画像ロード成功: ${d}`),v[i]=m,m}catch{console.log(`画像ロード失敗: ${d}`)}console.log(`代替画像を生成: ${i}`);const o=document.createElement("canvas");o.width=240,o.height=180;const l=o.getContext("2d",{alpha:!0});l.clearRect(0,0,o.width,o.height),l.fillStyle="#6b8e23",l.fillRect(40,30,160,120),l.strokeStyle="white",l.lineWidth=3,l.strokeRect(40,30,160,120),l.fillStyle="white",l.font="bold 24px sans-serif",l.textAlign="center",l.fillText(t,o.width/2,o.height/2);const c=new Image,h=new Promise(d=>{c.onload=()=>{d(c)}});c.src=o.toDataURL("image/png");const g=await h;return v[i]=g,g}function Ts(e){return new Promise((t,s)=>{const n=new Image;n.crossOrigin="Anonymous",n.onload=()=>t(n),n.onerror=i=>s(new Error(`画像の読み込みに失敗: ${e}`)),n.src=e})}function qe(e){return new Promise((t,s)=>{const n=new Image;n.crossOrigin="Anonymous",n.onload=()=>{const i=document.createElement("canvas");i.width=n.width,i.height=n.height;const a=i.getContext("2d",{willReadFrequently:!0});a.drawImage(n,0,0);const o=a.getImageData(0,0,i.width,i.height),l=o.data,c=240,h=15;for(let d=0;d<l.length;d+=4){const m=l[d],y=l[d+1],p=l[d+2];m>c&&y>c&&p>c&&Math.abs(m-y)<h&&Math.abs(y-p)<h&&Math.abs(p-m)<h&&(l[d+3]=0)}a.putImageData(o,0,0);const g=new Image;g.onload=()=>t(g),g.src=i.toDataURL("image/png")},n.onerror=i=>s(new Error(`画像の読み込みに失敗: ${e}`)),n.src=e})}function Is(e,t,s,n,i,a=""){if(e.save(),v&&v.panelStone)e.drawImage(v.panelStone,0,0,16,16,t,s,16,16),e.drawImage(v.panelStone,v.panelStone.width-16,0,16,16,t+n-16,s,16,16),e.drawImage(v.panelStone,0,v.panelStone.height-16,16,16,t,s+i-16,16,16),e.drawImage(v.panelStone,v.panelStone.width-16,v.panelStone.height-16,16,16,t+n-16,s+i-16,16,16),e.drawImage(v.panelStone,16,0,v.panelStone.width-16*2,16,t+16,s,n-16*2,16),e.drawImage(v.panelStone,16,v.panelStone.height-16,v.panelStone.width-16*2,16,t+16,s+i-16,n-16*2,16),e.drawImage(v.panelStone,0,16,16,v.panelStone.height-16*2,t,s+16,16,i-16*2),e.drawImage(v.panelStone,v.panelStone.width-16,16,16,v.panelStone.height-16*2,t+n-16,s+16,16,i-16*2),e.drawImage(v.panelStone,16,16,v.panelStone.width-16*2,v.panelStone.height-16*2,t+16,s+16,n-16*2,i-16*2);else{e.fillStyle="rgba(50, 50, 60, 0.8)",e.fillRect(t,s,n,i),e.strokeStyle="rgba(255, 255, 255, 0.2)",e.lineWidth=1;for(let o=1;o<3;o++)e.beginPath(),e.moveTo(t,s+i*o/3),e.lineTo(t+n,s+i*o/3),e.stroke();e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=2,e.strokeRect(t,s,n,i)}a&&(e.fillStyle="white",e.font='18px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.textBaseline="top",e.fillText(a,t+n/2,s+10)),e.restore()}function Bs(e){return e.startsWith("Asie_")?12:e.startsWith("Europe_")?13:e.startsWith("America_")?14:e.startsWith("Africa_")?15:{hokkaido_area1:1,tohoku_area1:2,tohoku_area2:2,tohoku_area3:2,tohoku_area4:2,tohoku_area5:2,tohoku_area6:2,kanto_area1:3,kanto_area2:3,kanto_area3:3,kanto_area4:3,kanto_area5:3,kanto_area6:3,kanto_area7:3,chubu_area1:4,chubu_area2:4,chubu_area3:4,chubu_area4:4,chubu_area5:4,chubu_area6:4,chubu_area7:4,chubu_area8:4,chubu_area9:4,kinki_area1:5,kinki_area2:5,kinki_area3:5,kinki_area4:5,kinki_area5:5,kinki_area6:5,kinki_area7:5,chugoku_area1:6,chugoku_area2:6,chugoku_area3:6,chugoku_area4:6,chugoku_area5:6}[e]||""}let W=[],ve=[],ne=[],pt={},L={};async function Ms(){try{console.log("外部JSONファイルの読み込みを開始します...");const t=[1,2,3,4,5,6].map(c=>fetch(`/data/kanji_g${c}_proto.json`).then(h=>{if(!h.ok)throw new Error(`漢字データ g${c} の読み込みに失敗: ${h.statusText}`);return h.json()}));ne=(await Promise.all(t)).flat().map(c=>({...c,incorrectCount:c.incorrectCount??0})),console.log("漢字データ読み込み完了"),L={};for(const c of ne){const h=c.grade||1;L[h]||(L[h]=[]),L[h].push(c)}console.log("漢字データを学年別に整理しました:",Object.keys(L).map(c=>`${c}年生: ${L[c].length}件`));try{const c=await fetch("/data/kanji_g7_proto.json").catch(()=>null);if(c&&c.ok){const m=await c.json();L[7]=m,console.log(`漢検4級（7年生相当）の漢字データ: ${m.length}件`)}const h=await fetch("/data/kanji_g8_proto.json").catch(()=>null);if(h&&h.ok){const m=await h.json();L[8]=m,console.log(`漢検3級（8年生相当）の漢字データ: ${m.length}件`)}const g=await fetch("/data/kanji_g9_proto.json").catch(()=>null);if(g&&g.ok){const m=await g.json();L[9]=m,console.log(`漢検準2級（9年生相当）の漢字データ: ${m.length}件`)}const d=await fetch("/data/kanji_g10_proto.json").catch(()=>null);if(d&&d.ok){const m=await d.json();L[10]=m,console.log(`漢検2級（10年生相当）の漢字データ: ${m.length}件`)}}catch(c){console.warn("中学生用漢字データの読み込みに一部失敗しました:",c)}L[7]||(console.log("漢検4級の漢字データが見つからないため、小学6年生の漢字を代用します"),L[7]=L[6]||[]),L[8]||(console.log("漢検3級の漢字データが見つからないため、小学6年生の漢字を代用します"),L[8]=L[6]||[]),L[9]||(console.log("漢検準2級の漢字データが見つからないため、小学6年生の漢字を代用します"),L[9]=L[6]||[]),L[10]||(console.log("漢検2級の漢字データが見つからないため、小学6年生の漢字を代用します"),L[10]=L[6]||[]);const i=await fetch("/data/enemies_proto.json");if(!i.ok)throw new Error(`敵データの読み込みに失敗: ${i.statusText}`);ve=await i.json(),console.log("敵データ読み込み完了");const o=await fetch("/data/stages_proto.json");if(!o.ok)throw new Error(`ステージデータの読み込みに失敗: ${o.statusText}`);W=await o.json(),console.log("ステージデータ読み込み完了");const l={};for(const c of ne){const h=Array.isArray(c.stageId)?c.stageId:[c.stageId];for(const g of h)l[g]||(l[g]=[]),l[g].push(c)}return _s(l),{kanjiData:ne,enemyData:ve,stageData:W}}catch(e){return console.error("ゲームデータの読み込み中にエラーが発生しました:",e),null}}function kt(e){const t=W.find(n=>n.stageId===e);if(!t||!t.enemyIdList)return[];let s=ve.filter(n=>t.enemyIdList.includes(n.id));if(s.length===0){console.warn(`⚠️ ステージ ${e} の敵が見つかりません。IDマッピングを試みます。`);const i={tohoku_area1:"AOM",tohoku_area2:"IWT",tohoku_area3:"AKT",tohoku_area4:"MYG",tohoku_area5:"YMG",tohoku_area6:"HKS",kanto_area1:"TOC",kanto_area2:"GNM",kanto_area3:"IBK",kanto_area4:"SIT",kanto_area5:"TB",kanto_area6:"TKY",kanto_area7:"KNG",chubu_area1:"NGT",chubu_area2:"TYM",chubu_area3:"ISK",chubu_area4:"HKI",chubu_area5:"NGN",chubu_area6:"GF",kinki_area1:"ME",kinki_area2:"SG",kinki_area3:"OSK",kinki_area4:"KYT",kinki_area5:"HYG",kinki_area6:"NR",kinki_area7:"WKY",chuugoku_area1:"TTR",chuugoku_area2:"OKY",chuugoku_area3:"SMN",chuugoku_area4:"HRS",chuugoku_area5:"YMGC"}[e];i&&(s=ve.filter(a=>a.id.startsWith(i)),console.log(`${i} で始まる敵を ${s.length} 件見つけました。`))}return s.length===0&&(console.warn("代替として北海道の敵を使用します。"),s=ve.filter(n=>n.id.startsWith("HKD-E")).slice(0,10)),s}function _s(e){pt=e}function Rt(e){var s;const t=e.toLowerCase();if(t.startsWith("asie_"))return console.log("4級（grade 7）の漢字プールを使用します"),Re(7);if(t.startsWith("europe_"))return console.log("3級（grade 8）の漢字プールを使用します"),Re(8);if(t.startsWith("america_"))return console.log("準2級（grade 9）の漢字プールを使用します"),Re(9);if(t.startsWith("africa_"))return console.log("2級（grade 10）の漢字プールを使用します"),Re(10);if(!pt[t]){console.log(`stageKanjiMap[${t}] が見つかりません。正規化されたID: ${t}`);const n=Ps(t);return n?(console.log(`代替として学年${n}の漢字 ${((s=L[n])==null?void 0:s.length)||0}件を使用します。`),L[n]||[]):[]}return pt[t]}function Ps(e){return e.startsWith("hokkaido_")?1:e.startsWith("tohoku_")?2:e.startsWith("kanto_")?3:e.startsWith("chubu_")?4:e.startsWith("kinki_")?5:e.startsWith("chugoku_")?6:e.startsWith("asie_")?7:e.startsWith("europe_")?8:e.startsWith("america_")?9:e.startsWith("africa_")?10:null}function Re(e){return L[e]&&L[e].length>0?L[e]:(console.warn(`学年${e}の漢字データがありません。代替として小学6年生の漢字を使用します。`),L[6]||ne.filter(t=>t.grade===6)||[])}function he(e){const t=ne.find(s=>s.id===e);return t||(console.warn(`kanjiData に ID=${e} のデータが見つかりません`),null)}function re(e){const t=ve.find(s=>s.id===e);return t||(console.warn(`enemyData に ID=${e} のデータが見つかりません`),null)}function $t(){return ve.map(e=>e.id)}const _e={apiKey:"AIzaSyCB45IBM6ktHqDgz6YxKG4D2Dp0V8sayts",authDomain:"kanjibattlerpg-proto.firebaseapp.com",projectId:"kanjibattlerpg-proto",storageBucket:"kanjibattlerpg-proto.firebasestorage.app",messagingSenderId:"92199045966",appId:"1:92199045966:web:767334da845831378fac1f"};let $e=null,fe=null,X=null;function As(){try{if(typeof firebase>"u")return console.error("Firebase SDK が読み込まれていません"),!1;if(!firebase.apps.length){if(!(_e!=null&&_e.apiKey)||_e.apiKey==="XXXXXXXXXXXXXXX")return alert(`⚠ Firebase の API キーが未設定です。
src/firebaseConfig.js を正しく記入してください。`),!1;firebase.initializeApp(_e),console.log("Firebase.initializeApp() 実行済み")}return $e=firebase.auth(),fe=firebase.firestore(),fe.enablePersistence({synchronizeTabs:!0}).catch(e=>console.warn("Firestore persistence error:",e)),console.log("Firebase Auth / Firestore を取得しました"),!0}catch(e){return console.error("Error initializing Firebase services:",e),alert("Firebase 初期化に失敗しました。ネット接続と API キーを確認してください。"),!1}}async function Fs(){return $e?X?(console.log("User already available (cached in controller):",X.uid),X):$e.currentUser?(X=$e.currentUser,console.log("User already signed in (from auth.currentUser):",X.uid),await It(),X):new Promise((e,t)=>{console.log("Attempting anonymous sign-in..."),$e.signInAnonymously().then(async s=>{X=s.user,console.log("New anonymous user signed in:",X.uid),await It(),e(X)}).catch(s=>{console.error("Error signing in anonymously:",s),X=null,t(s)})}):(console.error("Auth service not initialized."),null)}function tt(){return X}async function xt(e,t="ななしのごんべえ"){if(!fe||!e||!t||t.trim()==="")return console.error("initializeNewPlayerData: Firestore service, UID, or playerName is missing or invalid."),alert("プレイヤーデータの初期化に失敗しました (情報不足)。"),null;console.log(`Initializing new player data in Firestore for UID: ${e} with name: ${t}`);const s=fe.collection("users").doc(e).collection("profile").doc("playerStats"),n={name:t.trim(),createdAt:firebase.firestore.FieldValue.serverTimestamp(),level:1,currentExp:0,maxHp:100,attack:10,nextLevelExp:100};try{return await s.set(n),console.log("New player data initialized and set in Firestore:",n),r&&r.playerStats?(r.playerName=n.name,r.playerStats.level=n.level,r.playerStats.exp=n.currentExp,r.playerStats.maxHp=n.maxHp,r.playerStats.attack=n.attack,r.playerStats.nextLevelExp=n.nextLevelExp,r.playerStats.healCount=3,console.log("Local gameState updated after new player data initialization.")):console.warn("initializeNewPlayerData: gameState or gameState.playerStats not available to update locally."),n}catch(i){return console.error("Error initializing new player data in Firestore:",i),alert("プレイヤーデータの初期化中にエラーが発生しました。"),null}}async function It(){if(!fe||!X||!X.uid){console.warn("Cannot load player data: Firestore or User not signed in."),Object.assign(r.playerStats,{level:1,exp:0,maxHp:100,attack:10,nextLevelExp:100,healCount:3}),r.playerName="ゲスト";return}const e=fe.collection("users").doc(X.uid).collection("profile").doc("playerStats");try{console.log(`Loading player data for UID: ${X.uid}`);const t=await e.get();if(t.exists){const s=t.data();console.log("Player data loaded from Firestore:",s),r.playerStats.level=s.level||1,r.playerStats.exp=s.currentExp||0,r.playerStats.maxHp=s.maxHp||100,r.playerStats.attack=s.attack||10,r.playerStats.nextLevelExp=s.nextLevelExp||calculateNextLevelExp(r.playerStats.level),r.playerName=s.name||"ななし",console.log("gameState updated from Firestore:",r.playerStats,r.playerName)}else{console.log("No player data found for this user. Initializing new data.");const s=await xt(X.uid,r.playerName||"ななしのごんべえ");s&&(r.playerStats.level=s.level,r.playerStats.exp=s.currentExp,r.playerStats.maxHp=s.maxHp,r.playerStats.attack=s.attack,r.playerStats.nextLevelExp=s.nextLevelExp,r.playerName=s.name)}}catch(t){console.error("Error loading player data from Firestore:",t),r.playerStats.maxHp||(Object.assign(r.playerStats,{level:1,exp:0,maxHp:100,attack:10,nextLevelExp:100,healCount:3}),r.playerName="ゲスト(エラー)")}}async function Ls(){if(!fe||!X||!X.uid)return console.warn("Cannot load stage clear status: User not signed in."),r.stageProgress={},null;const e=fe.collection("users").doc(X.uid).collection("progress");try{const t=await e.get(),s={};return t.forEach(n=>{s[n.id]=n.data()}),console.log("All stage clear status loaded from Firestore:",s),r.stageProgress=s,s}catch(t){return console.error("Error loading all stage clear status:",t),r.stageProgress={},null}}var D,te,q,le,Be,Ht,Dt;const De=class De{constructor(){xe(this,Be);xe(this,D,null);xe(this,te,1);xe(this,q,.7);xe(this,le,.7);this.loadVolumeSettings()}setMasterVolume(t){ae(this,te,Math.max(0,Math.min(1,t))),M(this,D)&&(M(this,D).volume=M(this,te)*M(this,q))}getMasterVolume(){return M(this,te)}playBGM(t,s=!0){var a,o;const n=De.FILES.bgm[t];if(!n)return console.warn(`BGM "${t}" は定義されていません`);if(((o=(a=M(this,D))==null?void 0:a.dataset)==null?void 0:o.key)===t)return;M(this,D)&&(M(this,D).pause(),M(this,D).currentTime=0,ae(this,D,null));const i=new Audio(n);i.dataset.key=t,i.loop=s,i.volume=M(this,te)*M(this,q),i.play().catch(console.error),ae(this,D,i)}async fadeToBGM(t,s=1){var n,i;((i=(n=M(this,D))==null?void 0:n.dataset)==null?void 0:i.key)!==t&&(await this.stopBGM(s),this.playBGM(t),await ot(this,Be,Dt).call(this,M(this,D),s))}async stopBGM(t=0){M(this,D)&&(await ot(this,Be,Ht).call(this,M(this,D),t),M(this,D).pause(),M(this,D).currentTime=0,ae(this,D,null))}playSE(t){const s=De.FILES.se[t];if(!s)return console.warn(`SE "${t}" は定義されていません`);const n=new Audio(s);n.volume=M(this,te)*M(this,le),n.play().catch(console.error)}setMasterVolume(t){ae(this,te,Math.max(0,Math.min(1,t))),M(this,D)&&(M(this,D).volume=M(this,te)*M(this,q))}setBGMVolume(t){ae(this,q,Math.max(0,Math.min(1,t))),M(this,D)&&(M(this,D).volume=M(this,te)*M(this,q)),localStorage.setItem("bgmVolume",M(this,q).toString()),console.log("BGM音量設定:",M(this,q))}getBGMVolume(){return M(this,q)}setSEVolume(t){ae(this,le,Math.max(0,Math.min(1,t))),localStorage.setItem("seVolume",M(this,le).toString()),console.log("SE音量設定:",M(this,le))}getSEVolume(){return M(this,le)}loadVolumeSettings(){const t=localStorage.getItem("bgmVolume"),s=localStorage.getItem("seVolume");t!==null&&ae(this,q,parseFloat(t)),s!==null&&ae(this,le,parseFloat(s)),console.log("音量設定読み込み - BGM:",M(this,q),"SE:",M(this,le))}};D=new WeakMap,te=new WeakMap,q=new WeakMap,le=new WeakMap,Be=new WeakSet,Ht=function(t,s){return new Promise(n=>{if(s<=0)return n();let i=s,a=t.volume;const o=()=>{if(i-=.016,t.volume=Math.max(0,i/s*a),i<=0)return n();requestAnimationFrame(o)};o()})},Dt=function(t,s){return new Promise(n=>{if(s<=0)return n();let i=0;t.volume=0;const a=M(this,te)*M(this,q),o=()=>{if(i+=.016,t.volume=Math.min(a,i/s*a),i>=s)return n();requestAnimationFrame(o)};o()})},Tt(De,"FILES",{bgm:{title:"/assets/audio/bgm_title.mp3",battle:"/assets/audio/bgm_battle.mp3",victory:"/assets/audio/bgm_victory.mp3",hokkaido:"/assets/audio/北海道.mp3",tohoku_a:"/assets/audio/東北A.mp3",tohoku_b:"/assets/audio/東北B.mp3",kanto_a:"/assets/audio/関東A.mp3",kanto_b:"/assets/audio/関東B.mp3",chubu_a:"/assets/audio/中部A.mp3",chubu_b:"/assets/audio/中部B.mp3",kinki_a:"/assets/audio/近畿A.mp3",kinki_b:"/assets/audio/近畿B.mp3",chugoku_a:"/assets/audio/中国A.mp3",chugoku_b:"/assets/audio/中国B.mp3",asia_a:"/assets/audio/アジアA.mp3",asia_b:"/assets/audio/アジアB.mp3",europe_a:"/assets/audio/ヨーロッパA.mp3",europe_b:"/assets/audio/ヨーロッパB.mp3",america_a:"/assets/audio/アメリカA.mp3",america_a2:"/assets/audio/アメリカA2.mp3",africa_a:"/assets/audio/アフリカ大陸A.mp3",africa_b:"/assets/audio/アフリカ大陸B.mp3",boss:"/assets/audio/boss.mp3"},se:{appear:"/assets/audio/se_appear.mp3",attack:"/assets/audio/se_attack.mp3",damage:"/assets/audio/se_damage.mp3",heal:"/assets/audio/se_heal.mp3",correct:"/assets/audio/se_correct.mp3",wrong:"/assets/audio/se_wrong.mp3",decide:"/assets/audio/se_decide.mp3",defeat:"/assets/audio/se_defeat.mp3"}});let yt=De;const Rs="progress";function $s(){var e;return(e=firebase.apps)!=null&&e.length?firebase.firestore():(console.warn("DataSync: Firebase App is not initialized yet"),null)}const Bt={kanjiDex:"krb_kanji_dex",monsterDex:"krb_monster_dex",reviewQueue:"krb_review_queue"},We={_ref(){const e=tt();if(!e)return null;const t=$s();return t?t.collection("users").doc(e.uid).collection(Rs).doc("state"):null},async initialize(){const e=this._ref();e&&e.onSnapshot(t=>{const s=t.data()||{};Object.entries(Bt).forEach(([n,i])=>{s[n]!==void 0&&localStorage.setItem(i,JSON.stringify(s[n]))})})},async syncAll(){const e=this._ref();if(!e)return;const t={};Object.entries(Bt).forEach(([s,n])=>{const i=localStorage.getItem(n);t[s]=i?JSON.parse(i):null});try{await e.set(t,{merge:!0})}catch(s){console.warn("DataSync.syncAll error:",s)}}},ue=(()=>{const e="krb_review_queue";let t=[];const s=()=>{try{const a=localStorage.getItem(e);t=a?JSON.parse(a):[]}catch(a){console.error("ReviewQueue の読み込みに失敗しました:",a),t=[]}},n=()=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(a){console.error("ReviewQueue の保存に失敗しました:",a)}We.syncAll()};s();const i=(a,o)=>{const l=Math.max(0,Math.min(5,o)),c=a+(.1-(5-l)*(.08+(5-l)*.02));return Math.max(1.3,c)};return{add(a){t.some(o=>o.id===a)||(t.push({id:a,repetition:0,interval:0,eFactor:2.5,nextReviewAt:Date.now()}),n())},updateReview(a,o){const l=t.find(c=>c.id===a);l&&(o<3?(l.repetition=0,l.interval=1):(l.repetition++,l.repetition===1?l.interval=1:l.repetition===2?l.interval=6:l.interval=Math.round(l.interval*l.eFactor),l.eFactor=i(l.eFactor,o)),l.nextReviewAt=Date.now()+l.interval*24*60*60*1e3,n())},getDueReviews(){const a=Date.now();return t.filter(o=>o!=null&&typeof o.nextReviewAt=="number"&&o.nextReviewAt<=a)},popBatch(a=5){const o=this.getDueReviews().slice(0,a);return o.forEach(l=>{const c=t.findIndex(h=>h.id===l.id);c>=0&&t.splice(c,1)}),n(),o.map(l=>l.id)},size(){return this.getDueReviews().length}}})();class Hs{constructor(t,s){this.states=s,this.currentState=null,this.change(t)}change(t,s){console.log(`FSM: 状態遷移 ${this.currentState?Object.keys(this.states).find(a=>this.states[a]===this.currentState):"null"} → ${t}`,s);const n=this.states[t];if(!n)throw new Error(`FSM: 状態 "${t}" が見つかりません`);const i=document.getElementById("uiOverlay");i&&Array.from(i.children).forEach(o=>{o.id!=="kanjiInput"&&i.removeChild(o)}),this.currentState&&typeof this.currentState.exit=="function"&&this.currentState.exit(),this.currentState=n,typeof this.currentState.enter=="function"&&this.currentState.enter(s)}update(t){this.currentState&&typeof this.currentState.update=="function"&&this.currentState.update(t)}}function Z(e,t,s,n,i,a,o="#2980b9"){e.fillStyle=o,e.fillRect(t,s,n,i),e.fillStyle="white",e.font='18px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.textBaseline="middle",e.fillText(a,t+n/2,s+i/2)}function C(e,t,s){if(!s)return!1;const n=s.width??s.w,i=s.height??s.h;return e>=s.x&&e<=s.x+n&&t>=s.y&&t<=s.y+i}function Ds(e,t,s){const n=e.createLinearGradient(0,0,0,s);n.addColorStop(0,"#2c3e50"),n.addColorStop(.5,"#34495e"),n.addColorStop(1,"#2c3e50"),e.fillStyle=n,e.fillRect(0,0,t,s),e.fillStyle="rgba(52, 152, 219, 0.1)";for(let i=0;i<t;i+=50)for(let a=0;a<s;a+=50)e.fillRect(i,a,2,2)}const js="krb_kanji_dex";function St(){try{const e=localStorage.getItem(js),t=e?JSON.parse(e):[],s=Array.isArray(t)?t.filter(i=>i!=null):[],n=new Set(s);return console.log("【図鑑】データをロードしました。収集数:",n.size),n.size>0&&console.log("【図鑑】収集済み漢字ID:",[...n]),n}catch(e){return console.error("kanjiDex: 図鑑のロードに失敗しました",e),new Set}}const jt="krb_monster_dex",Nt="krb_seen_monsters";function st(){try{const e=localStorage.getItem(jt),t=e?JSON.parse(e):[];if(!Array.isArray(t))return new Set;const s=t.filter(n=>typeof n=="string");return new Set(s)}catch(e){return console.error("monsterDex: 図鑑のロードに失敗しました",e),new Set}}function bt(){try{const e=localStorage.getItem(Nt),t=e?JSON.parse(e):[];if(!Array.isArray(t))return new Set;const s=t.filter(n=>typeof n=="string");return new Set(s)}catch(e){return console.error("monsterDex: 確認済みモンスターのロードに失敗しました",e),new Set}}function Ns(e){try{localStorage.setItem(jt,JSON.stringify([...e])),We.syncAll()}catch(t){console.error("monsterDex: 図鑑の保存に失敗しました",t)}}function Ws(e){try{localStorage.setItem(Nt,JSON.stringify([...e])),We.syncAll()}catch(t){console.error("monsterDex: 確認済みモンスターの保存に失敗しました",t)}}function Gs(e){const t=st();t.has(e)||(t.add(e),Ns(t))}function Xs(e){const t=bt();t.has(e)||(t.add(e),Ws(t))}function Ys(e){const t=st(),s=bt();return t.has(e)&&!s.has(e)}let Pe=null;async function Os(){if(Pe)return Pe;try{const e=await fetch("/data/achievements.json");if(!e.ok)throw new Error(`実績データの読み込みに失敗: ${e.statusText}`);return Pe=await e.json(),console.log(`📋 実績データを読み込みました: ${Pe.length}件`),Pe}catch(e){return console.error("❌ 実績データの読み込みエラー:",e),[]}}function Us(e,t){const{condition:s}=e,{type:n,value:i}=s;switch(n){case"enemiesDefeated":return t.enemiesDefeated>=i;case"levelReached":return t.level>=i;case"stagesCleared":return t.stagesCleared>=i;case"kanjiCollected":return St().size>=i;case"monstersCollected":return st().size>=i;case"totalCorrect":return t.totalCorrect>=i;case"skillPointsUsed":return t.skillPointsUsed>=i;case"perfectStage":return r.justClearedPerfectly?(r.justClearedPerfectly=!1,!0):!1;case"bossesDefeated":return t.bossesDefeated>=i;case"playtimeMinutes":return t.playtimeSeconds/60>=i;case"weaknessHits":return t.weaknessHits>=i;case"healsSuccessful":return t.healsSuccessful>=i;case"regionCleared":{const a=W.filter(o=>o.region===i);return a.length===0?!1:a.every(o=>{var l,c;return(c=(l=r.stageProgress)==null?void 0:l[o.stageId])==null?void 0:c.cleared})}case"gradeCompleted":{const a=ne.filter(l=>l.grade===i);if(a.length===0)return!1;const o=St();return a.every(l=>o.has(l.id))}default:return!1}}async function Ge(){try{const e=await Os();if(e.length===0){console.warn("⚠️ 実績データが読み込まれていません");return}const{playerStats:t,unlockedAchievements:s}=r,n=[];for(const i of e){const{id:a,title:o,description:l}=i;Ft(a)||Us(i,t)&&(fs(a),n.push(i),console.log(`🏆 実績解除: ${o} - ${l}`),f("achievementUnlocked",{id:a,title:o,description:l,achievement:i}))}n.length>0&&(console.log(`✨ ${n.length}個の新しい実績を解除しました!`),n.length>1&&f("multipleAchievementsUnlocked",n))}catch(e){console.error("❌ 実績チェック中にエラーが発生しました:",e)}}u.timeRemaining=60;const Ks=5,ce={back:{x:20,y:20,w:100,h:30,label:"タイトルへ"},stage:{x:140,y:20,w:120,h:30,label:"ステージ選択"},attack:{x:230,y:380,w:110,h:50,label:"こうげき"},heal:{x:350,y:380,w:110,h:50,label:"かいふく"},hint:{x:470,y:380,w:110,h:50,label:"ヒント"}},zs=10,Wt=15,Gt=30,Mt=2,R={canvas:null,ctx:null,inputEl:null,victoryCallback:null,stageBgImage:null,_keydownHandler:null,_clickHandler:null,_wheelHandler:null,_mousemoveHandler:null,logOffset:0,timerId:null,mouseX:0,mouseY:0,isAnimatingExp:!1,expAnimQueue:[],levelUpMessage:"",stageClearPending:!1,flashEffect:{active:!1,timer:0,duration:15,color:"rgba(255, 0, 0, 0.5)"},readingHighlight:{active:!1,timer:0,duration:60,type:null},comboAnimation:{active:!1,timer:0,duration:30,scale:1,comboCount:0},playerExpDisplay:0,playerExpTarget:0,playerExpAnimating:!1,expAnimSpeed:1,lastIncorrectAnswer:null,kanjiBoxEffect:{active:!1,timer:0,duration:0,color:"rgba(46, 204, 113, 0.8)",originalSize:{width:180,height:180},currentSize:{width:180,height:180},maxScale:1.1,pulsePhase:0},levelUpEffect:{active:!1,timer:0,duration:120,overlayOpacity:.5,pulsateSpeed:.05},typewriterEffect:{active:!1,targetMessage:"",displayedChars:0,messageIndex:-1,charInterval:2,charTimer:0,soundInterval:3},expParticles:{active:!1,particles:[],maxParticles:15,sourceX:0,sourceY:0,targetX:0,targetY:0,expAmount:0},shakeEffect:{active:!1,timer:0,duration:0,intensity:0},isPrevKanjiPanelOpen:!1,lastAnsweredKanji:null,pressedButtons:new Set,startKanjiBoxEffect(e="rgba(46, 204, 113, 0.8)",t=15){this.kanjiBoxEffect.active=!0,this.kanjiBoxEffect.timer=t,this.kanjiBoxEffect.duration=t,this.kanjiBoxEffect.color=e,this.kanjiBoxEffect.pulsePhase=0,console.log("漢字ボックスエフェクト開始:",e,t)},startShakeEffect(e=15,t=5){this.shakeEffect.active=!0,this.shakeEffect.timer=e,this.shakeEffect.duration=e,this.shakeEffect.intensity=t,console.log("シェイクエフェクト開始:",e,t)},enter(e,t){try{if(console.log("🧪 battleScreen.enter() 実行",{canvasEl:e,gameStateId:r.currentStageId}),!r.currentStageId){alert("ステージIDが未設定です。タイトルに戻ります。"),f("changeScreen","title");return}if(f("playBGM","battle"),r.playerStats.hp=r.playerStats.maxHp,u.turn="player",u.inputEnabled=!0,u.comboCount=0,u.message="",u.enemyAction=null,u.enemyActionTimer=0,this.isAnimatingExp=!1,this.expAnimQueue=[],this.levelUpMessage="",r.gameMode==="challenge"&&(u.timeRemaining=60,this.timerId=setInterval(()=>{u.timeRemaining--,u.timeRemaining<=0&&(clearInterval(this.timerId),this.timerId=null,f("changeScreen","gameOver"))},1e3)),e||(console.log("⚠️ canvasEl引数がありません。DOMから取得します。"),e=document.getElementById("gameCanvas")),!e)throw new Error("キャンバス要素が見つかりません");if(this.canvas=e,this.ctx=this.canvas.getContext("2d"),!this.ctx)throw new Error("Canvas 2Dコンテキストの取得に失敗しました");this.inputEl=document.getElementById("kanjiInput"),this.inputEl?(this.inputEl.style.display="block",this.inputEl.placeholder="よみを にゅうりょく",this._keydownHandler=a=>{if(a.key==="Enter"&&(a.preventDefault(),u.turn==="player"&&u.inputEnabled)){const o=u.lastCommandMode||"attack";setTimeout(()=>{try{o==="attack"?typeof Ae=="function"?Ae():(console.error("onAttack関数が定義されていません"),u.inputEnabled=!0):o==="heal"?typeof Fe=="function"?Fe():(console.error("onHeal関数が定義されていません"),u.inputEnabled=!0):typeof Le=="function"?Le():(console.error("onHint関数が定義されていません"),u.inputEnabled=!0)}catch(l){console.error("処理中にエラーが発生しました:",l),u.inputEnabled=!0,this.inputEl&&(this.inputEl.value="")}},0)}},this.inputEl.addEventListener("keydown",this._keydownHandler)):console.error("kanjiInput要素が見つかりません"),this.victoryCallback=t,r.correctKanjiList=[],r.wrongKanjiList=[],u.log=[];try{this.stageBgImage=v[`bg_${r.currentStageId}`]||null,console.log(`🖼️ 背景画像取得: ${r.currentStageId}`,this.stageBgImage?"成功":"失敗")}catch(a){console.warn("背景画像が見つかりませんでした:",a),this.stageBgImage=null}if(r.enemies=kt(r.currentStageId),r.kanjiPool=Rt(r.currentStageId),u.kanjiPool_onyomi=r.kanjiPool.filter(a=>a.onyomi&&(Array.isArray(a.onyomi)&&a.onyomi.length>0||typeof a.onyomi=="string"&&a.onyomi.trim()!=="")),u.kanjiPool_kunyomi=r.kanjiPool.filter(a=>a.kunyomi&&(Array.isArray(a.kunyomi)&&a.kunyomi.length>0||typeof a.kunyomi=="string"&&a.kunyomi.trim()!=="")),!r.kanjiPool.length){alert(`このステージに紐づく漢字データがありません。
ステージ選択へ戻ります。`),f("changeScreen","stageSelect");return}r.currentEnemyIndex=0,u.recentKanjiIds=[],u.shuffledKanjiList=[...r.kanjiPool].sort(()=>Math.random()-.5),u.currentKanjiIndex=0;for(const a of r.enemies)a.img=v[a.id]||null,a.hp=a.maxHp;u.playerHpDisplay=r.playerStats.hp,u.playerHpTarget=r.playerStats.hp,u.playerHpAnimating=!1,u.lastAnswered=null,Xt(),Te(),this.logOffset=0,this.registerHandlers(),this.comboAnimation.active=!1,this.comboAnimation.timer=0,this.comboAnimation.scale=1,this.comboAnimation.comboCount=0;const s=r.playerStats,n=Ot(s.level),i=Math.max(0,s.exp-n);this.playerExpDisplay=i,this.playerExpTarget=i,this.playerExpAnimating=!1,r.hintLevel=0,console.log("✅ battleScreen.enter() 完了")}catch(s){console.error("❌ battleScreen.enter() でエラー発生:",s),alert(`ゲーム画面の初期化に失敗しました: ${s.message}
ステージ選択に戻ります。`),f("changeScreen","stageSelect")}},update(e){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.stageBgImage)this.ctx.drawImage(this.stageBgImage,0,0,this.canvas.width,this.canvas.height);else{const S=this.ctx.createLinearGradient(0,0,0,this.canvas.height);S.addColorStop(0,"#1e3c72"),S.addColorStop(1,"#2a5298"),this.ctx.fillStyle=S,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}[ce.back,ce.stage].forEach(S=>{const x=C(this.mouseX,this.mouseY,S);this.drawRichButton(this.ctx,S.x,S.y,S.w,S.h,S.label,"#34495e",x)});const t=r.currentEnemy,s=480,n=80,i=240,a=120;let o=0,l=0,c=0,h=1;if(u.enemyAction==="damage"&&u.enemyActionTimer>0)o=(Math.random()-.5)*20,l=(Math.random()-.5)*10,u.enemyActionTimer--,u.enemyActionTimer===0&&(u.enemyAction=null);else if(u.enemyAction==="attack"&&u.enemyActionTimer>0){const x=Wt/2,B=u.enemyActionTimer;o=-((x-Math.abs(B-x))/x)*30,u.enemyActionTimer--,u.enemyActionTimer===0&&(u.enemyAction=null)}if(u.enemyAction==="defeat"&&u.enemyActionTimer>0){const S=Gt,x=u.enemyActionTimer,B=(S-x)/S;c=B*(Math.PI/2),h=1-B,u.enemyActionTimer--,u.enemyActionTimer===0&&(u.enemyAction=null)}if(this.ctx.save(),this.ctx.globalAlpha=h,this.ctx.translate(s+i/2+o,n+a/2+l),this.ctx.rotate(c),t&&t.isBoss&&t.shieldHp>0){const S=Math.max(i,a)*.6,x=.3+(Math.sin(Date.now()/300)+1)*.1,B=this.ctx.createRadialGradient(0,0,S*.7,0,0,S);B.addColorStop(0,"rgba(100, 180, 255, 0)"),B.addColorStop(.7,`rgba(100, 180, 255, ${x*.5})`),B.addColorStop(1,`rgba(120, 210, 255, ${x})`),this.ctx.fillStyle=B,this.ctx.beginPath(),this.ctx.arc(0,0,S,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle=`rgba(200, 230, 255, ${x+.2})`,this.ctx.lineWidth=2,this.ctx.stroke()}t&&t.img?this.ctx.drawImage(t.img,-i/2,-a/2,i,a):(this.ctx.fillStyle="#6b8e23",this.ctx.fillRect(-i/2,-a/2,i,a),this.ctx.fillStyle="white",this.ctx.font="bold 20px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(t?t.name:"モンスター",0,0)),this.ctx.restore();const g=this.canvas.width/2,d=200,m=180,y=160;if(r.currentEnemy&&r.currentEnemy.weakness){const x=`弱点は${r.currentEnemy.weakness==="onyomi"?"音読み":"訓読み"}！`;this.drawTextWithOutline(x,g,d-y/2-20,"#f39c12","black",'bold 20px "UDデジタル教科書体",sans-serif',"center","bottom",3)}if((u.comboCount>=2&&u.comboCount>0||this.comboAnimation.active)&&this.drawComboIndicator(this.ctx),r.hintLevel>0){let S="",x="yellow";switch(r.hintLevel){case 1:S=`ヒント（基本）: 画数は${r.currentKanji.strokes}`,x="#3498db";break;case 2:const ke=r.currentKanji.id%2===0,ge=ke?r.currentKanji.onyomi:r.currentKanji.kunyomi;if(ge&&ge.length>0){const it=ge[0].substring(0,1)+"○○";S=`ヒント（読み）: ${ke?"音読み":"訓読み"}は「${it}」から始まる`}else S=`ヒント（読み）: ${ke?"訓読み":"音読み"}で読むことが多い`;x="#f39c12";break;case 3:S=`ヒント（意味）: ${r.currentKanji.meaning}`,x="#e74c3c";break}const B=160,H=this.ctx.measureText(S).width+40,z=30,_=g-H/2,O=d+B/2+10;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(_,O,H,z),this.ctx.strokeStyle=x,this.ctx.lineWidth=2,this.ctx.strokeRect(_,O,H,z);const J=["💡","💡💡","💡💡💡"][r.hintLevel-1];this.ctx.font="14px sans-serif",this.ctx.fillStyle=x,this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(J,_+10,O+z/2),this.drawTextWithOutline(S,_+40,O+z/2,x,"black",'16px "UDデジタル教科書体",sans-serif',"left","middle",1)}if(u.lastAnswered){this.drawPanelBackground(this.ctx,20,70,140,180,"stone"),this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.font='bold 14px "UDデジタル教科書体",sans-serif',this.ctx.fillText("1つまえの漢字",20+140/2,85),this.ctx.font="42px serif",this.ctx.fillText(u.lastAnswered.text,20+140/2,125),this.ctx.font='12px "UDデジタル教科書体",sans-serif';const z=u.lastAnswered.kunyomi.join("、");this.readingHighlight.active&&this.readingHighlight.type==="kunyomi"?this.ctx.fillStyle="yellow":this.ctx.fillStyle="white",this.ctx.textAlign="left",this.ctx.fillText(`訓読み: ${z}`,30,155);const _=u.lastAnswered.onyomi.join("、");this.readingHighlight.active&&this.readingHighlight.type==="onyomi"?this.ctx.fillStyle="yellow":this.ctx.fillStyle="white",this.ctx.fillText(`音読み: ${_}`,30,175),this.ctx.fillStyle="white",this.ctx.fillText(`画数: ${u.lastAnswered.strokes}`,30,195),this.lastIncorrectAnswer&&(this.ctx.fillStyle="rgba(231, 76, 60, 0.2)",this.ctx.fillRect(30,210,120,22),this.ctx.strokeStyle="rgba(231, 76, 60, 0.8)",this.ctx.lineWidth=1,this.ctx.strokeRect(30,210,120,22),this.ctx.fillStyle="#e74c3c",this.ctx.font='bold 12px "UDデジタル教科書体",sans-serif',this.ctx.textAlign="center",this.ctx.fillText(`あなたの答え: ${this.lastIncorrectAnswer}`,20+140/2,225))}if(!this.isAnimatingExp&&this.expAnimQueue.length>0){this.isAnimatingExp=!0;const S=this.expAnimQueue.shift(),x=ms(S);x.leveledUp&&(f("playSE","levelUp"),this.levelUpMessage=`レベルが ${x.newLevel} にあがった！`,this.startLevelUpEffect(120),Ge().catch(B=>{console.error("実績チェック中にエラーが発生しました:",B)}),u.playerHpTarget=r.playerStats.hp,u.playerHpAnimating=!0),this.isAnimatingExp=!1}if(u.playerHpAnimating){const S=u.playerHpDisplay,x=u.playerHpTarget,B=x-S;Math.abs(B)<=Mt?(u.playerHpDisplay=x,u.playerHpAnimating=!1):u.playerHpDisplay+=Math.sign(B)*Mt}if(this.playerExpAnimating){const S=this.playerExpDisplay,x=this.playerExpTarget,B=x-S;Math.abs(B)<=this.expAnimSpeed?(this.playerExpDisplay=x,this.playerExpAnimating=!1):this.playerExpDisplay+=Math.sign(B)*this.expAnimSpeed}this.drawPlayerStatusPanel(this.ctx),this.drawEnemyStatusPanel(this.ctx),Object.entries(ce).forEach(([S,x])=>{if(S==="back"||S==="stage")return;let B="#2980b9";S==="attack"?B="#e74c3c":S==="heal"?B="#27ae60":S==="hint"&&(B="#f39c12");const H=C(this.mouseX,this.mouseY,x);this.drawRichButton(this.ctx,x.x,x.y,x.w,x.h,x.label,B,H);const _={attack:v.iconAttack,heal:v.iconHeal,hint:v.iconHint}[S],O=8,Q=H?1.05:1;let J=x.x,Ye=x.y,ke=x.w,ge=x.h;if(H){const rs=x.x+x.w/2,cs=x.y+x.h/2;ke=x.w*Q,ge=x.h*Q,J=rs-ke/2,Ye=cs-ge/2}const Oe=ge-O*2;_&&this.ctx.drawImage(_,J+O,Ye+O,Oe,Oe);const it=J+O+(_?Oe+O:0),ls=Ye+ge/2;this.drawTextWithOutline(x.label,it,ls,"white","black",'16px "UDデジタル教科書体",sans-serif',"left","middle",1)}),this.inputEl&&(this.inputEl.style.display="block",this.inputEl.style.position="fixed",this.inputEl.style.left="50%",this.inputEl.style.transform="translateX(-50%)",window.innerWidth<=768?(this.inputEl.style.bottom="25vh",this.inputEl.style.top="auto",this.inputEl.style.width="70vw",this.inputEl.style.maxWidth="280px",this.inputEl.style.fontSize="16px"):(this.inputEl.style.top="320px",this.inputEl.style.bottom="auto",this.inputEl.style.width="280px",this.inputEl.style.fontSize="20px"),this.inputEl.style.padding="8px 12px",this.inputEl.style.textAlign="center",this.inputEl.style.zIndex="1000",this.inputEl.style.backgroundColor="white",this.inputEl.style.border="2px solid #ccc",this.inputEl.style.borderRadius="5px",this.inputEl.style.boxSizing="border-box");const p=this.canvas.width-380,k=450,w=360,E=130;this.drawPanelBackground(this.ctx,p,k,w,E,"stone"),this.drawTextWithOutline("バトルログ",p+w/2,k+8,"white","black",'bold 14px "UDデジタル教科書体", sans-serif',"center","top",1);const b=5,T=u.log.length,A=Math.max(0,T-b);this.logOffset=Math.min(Math.max(0,this.logOffset),A);const G=Math.max(0,T-b-this.logOffset);let F=u.log.slice(G,G+b);if(this.ctx.font='14px "UDデジタル教科書体", sans-serif',this.ctx.textAlign="left",this.ctx.textBaseline="top",this.typewriterEffect.active){if(this.typewriterEffect.charTimer--,this.typewriterEffect.charTimer<=0){if(this.typewriterEffect.displayedChars++,this.typewriterEffect.charTimer=this.typewriterEffect.charInterval,this.typewriterEffect.displayedChars%this.typewriterEffect.soundInterval===0)try{f("playSE","decide",.1)}catch(S){console.warn("タイプ音の再生に失敗しました:",S)}this.typewriterEffect.displayedChars>=this.typewriterEffect.targetMessage.length&&(this.typewriterEffect.active=!1)}if(this.typewriterEffect.messageIndex>=0&&this.typewriterEffect.messageIndex<F.length){const S=this.typewriterEffect.targetMessage.substring(0,this.typewriterEffect.displayedChars);F[this.typewriterEffect.messageIndex]=S}}if(F.forEach((S,x)=>{const B=this.getMessageColor(S),H=p+8,z=k+28+x*20,_=16,O=4;let Q=0,J=null;S.includes("ダメージ")||S.includes("こうげき")?J=v.iconAttack:S.includes("せいかい！")||S.includes("弱点にヒット")||S.includes("ボーナス")?(J=v.iconAttack,this.ctx.save(),this.ctx.fillStyle="#2ecc71",this.ctx.font=`${_}px sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("✓",H+_/2,z+10),this.ctx.restore(),Q=_+O):S.includes("かいふく")?J=v.iconHeal:S.includes("をたおした")||S.includes("あらわれた")?J=v.iconAttack:S.includes("経験値")||S.includes("レベル")?(this.ctx.save(),this.ctx.fillStyle="#f1c40f",this.ctx.font=`${_}px sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("★",H+_/2,z+10),this.ctx.restore(),Q=_+O):S.includes("ヒント")&&(J=v.iconHint),J&&!S.includes("せいかい！")&&!S.includes("弱点にヒット")&&!S.includes("ボーナス")&&!S.includes("経験値")&&!S.includes("レベル")&&(this.ctx.save(),S.includes("ダメージ")||S.includes("こうげき")?this.ctx.filter="hue-rotate(0deg) saturate(1.2)":S.includes("かいふく")?this.ctx.filter="hue-rotate(90deg) saturate(1.5)":S.includes("ヒント")&&(this.ctx.filter="hue-rotate(45deg) saturate(1.3)"),this.ctx.drawImage(J,H,z+2,_,_),this.ctx.restore(),Q=_+O),this.drawTextWithOutline(S,H+Q,z,B,"black",'14px "UDデジタル教科書体", sans-serif',"left","top",1)}),T>b&&this.drawTextWithOutline("↑↓ スクロール可能 ↑↓",p+w/2,k+E-18,"rgba(255, 255, 255, 0.7)","black",'10px "UDデジタル教科書体", sans-serif',"center","top",1),this.levelUpMessage)if(this.levelUpEffect.active){this.ctx.save(),this.ctx.fillStyle=`rgba(0, 0, 0, ${this.levelUpEffect.overlayOpacity})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.levelUpEffect.timer--,this.levelUpEffect.timer<=0&&(this.levelUpEffect.active=!1,this.levelUpMessage="");const S=1+.2*Math.sin(Date.now()*this.levelUpEffect.pulsateSpeed),x=this.canvas.width/2,B=this.canvas.height/2,H=this.ctx.createLinearGradient(x-200,B,x+200,B);H.addColorStop(0,"#f39c12"),H.addColorStop(.5,"#f1c40f"),H.addColorStop(1,"#f39c12"),this.ctx.font=`bold ${38*S}px "UDデジタル教科書体", sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.lineWidth=6,this.ctx.strokeStyle="black",this.ctx.strokeText(this.levelUpMessage,x,B),this.ctx.fillStyle=H,this.ctx.fillText(this.levelUpMessage,x,B),this.ctx.save(),this.ctx.globalAlpha=.6+.4*Math.sin(Date.now()*.003),this.ctx.translate(x,B);for(let _=0;_<12;_++)this.ctx.rotate(Math.PI/6),this.ctx.beginPath(),this.ctx.moveTo(0,-20),this.ctx.lineTo(0,-150*S),this.ctx.strokeStyle="rgba(255, 215, 0, 0.3)",this.ctx.lineWidth=10,this.ctx.stroke();this.ctx.restore();const z="攻撃力アップ！ HP最大値アップ！";this.ctx.font='20px "UDデジタル教科書体", sans-serif',this.ctx.fillStyle="white",this.ctx.fillText(z,x,B+60),this.ctx.restore()}else{this.ctx.save(),this.ctx.fillStyle="yellow",this.ctx.font='32px "UDデジタル教科書体", sans-serif',this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.strokeStyle="black",this.ctx.lineWidth=2;const S=this.canvas.width/2,x=this.canvas.height/2;this.ctx.strokeText(this.levelUpMessage,S,x),this.ctx.fillText(this.levelUpMessage,S,x),this.ctx.restore()}if(r.gameMode==="challenge"&&this.drawTextWithOutline(`残り時間: ${u.timeRemaining}`,this.canvas.width/2,30,"yellow","black",'24px "UDデジタル教科書体", sans-serif',"center"),this.flashEffect.active){this.flashEffect.timer--;const S=this.flashEffect.timer/this.flashEffect.duration;this.ctx.save(),this.ctx.globalAlpha=S*.5,this.ctx.fillStyle=this.flashEffect.color,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.flashEffect.timer<=0&&(this.flashEffect.active=!1)}if(this.readingHighlight.active&&(this.readingHighlight.timer--,this.readingHighlight.timer<=0&&(this.readingHighlight.active=!1,this.readingHighlight.type=null)),this.stageClearPending&&!this.isAnimatingExp&&this.expAnimQueue.length===0&&(this.stageClearPending=!1,this.victoryCallback&&this.victoryCallback()),this.comboAnimation.active){this.comboAnimation.timer--;const S=this.comboAnimation.timer/this.comboAnimation.duration;this.comboAnimation.scale=1+(1-S)*.5,this.comboAnimation.timer<=0&&(this.comboAnimation.active=!1,this.comboAnimation.scale=1)}this.kanjiBoxEffect.active&&(this.kanjiBoxEffect.timer--,this.kanjiBoxEffect.timer<=0&&(this.kanjiBoxEffect.active=!1)),this.shakeEffect.active&&(this.shakeEffect.timer--,this.shakeEffect.timer<=0&&(this.shakeEffect.active=!1)),this.expParticles.active&&this.updateAndDrawExpParticles(),u.comboCount>0&&u.comboTimer>0&&(u.comboTimer--,u.comboTimer<=0&&(console.log("⏰ コンボタイマー終了：コンボがリセットされました"),u.comboCount=0,u.comboTimer=0)),u.comboCount<0&&(u.comboCount=0),this.canvas.width/2-90,this.canvas.width/2-90,this.canvas.width/2;let $=0,I=0;if(this.shakeEffect&&this.shakeEffect.active){this.shakeEffect.timer--;const S=this.shakeEffect.intensity*(this.shakeEffect.timer/this.shakeEffect.duration);$=(Math.random()*2-1)*S,I=(Math.random()*2-1)*S,this.shakeEffect.timer<=0&&(this.shakeEffect.active=!1)}let N=1;if(this.kanjiBoxEffect&&this.kanjiBoxEffect.active){this.kanjiBoxEffect.timer--,this.kanjiBoxEffect.pulsePhase+=.2;const S=1-this.kanjiBoxEffect.timer/this.kanjiBoxEffect.duration,x=Math.sin(this.kanjiBoxEffect.pulsePhase)*.5+.5;N=1+(this.kanjiBoxEffect.maxScale-1)*x*(1-S),this.kanjiBoxEffect.color,this.kanjiBoxEffect.timer<=0&&(this.kanjiBoxEffect.active=!1)}const P=m*N,Y=y*N,K=g-P/2+$,se=d-Y/2+I;Is(this.ctx,K,se,P,Y),r.currentKanji&&(this.ctx.font=`${80*N}px serif`,this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.shadowColor="rgba(0, 0, 0, 0.7)",this.ctx.shadowBlur=5,this.ctx.shadowOffsetX=3*N,this.ctx.shadowOffsetY=3*N,this.ctx.fillText(r.currentKanji.text,K+P/2,se+Y/2),this.ctx.shadowColor="transparent",this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0)},drawRichButton(e,t,s,n,i,a,o="#2980b9",l=!1,c=!1){const h=c?2:0,g=l?4:c?1:3,d=s+g-h;e.fillStyle=`rgba(0, 0, 0, ${c?.2:.3})`,e.fillRect(t+g,d+g,n,i),c&&this.darkenColor(o,10),e.save();const m=l?1.05:1,y=l?this.lightenColor(o,15):o;if(l){const E=t+n/2,b=s+i/2,T=n*m,A=i*m;t=E-T/2,s=b-A/2,n=T,i=A}const p=e.createLinearGradient(t,s,t,s+i);p.addColorStop(0,this.lightenColor(y,20)),p.addColorStop(1,this.darkenColor(y,20)),e.fillStyle=p,e.fillRect(t,s,n,i),e.strokeStyle=this.darkenColor(y,30),e.lineWidth=l?3:2,e.strokeRect(t,s,n,i);const k=e.createLinearGradient(t,s,t,s+i*.3),w=l?.4:.3;k.addColorStop(0,`rgba(255, 255, 255, ${w})`),k.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=k,e.fillRect(t,s,n,i*.3),l&&(e.strokeStyle="rgba(255, 255, 255, 0.6)",e.lineWidth=1,e.strokeRect(t+1,s+1,n-2,i-2)),e.restore()},lightenColor(e,t){const s=parseInt(e.replace("#",""),16),n=Math.round(2.55*t),i=(s>>16)+n,a=(s>>8&255)+n,o=(s&255)+n;return"#"+(16777216+(i<255?i<1?0:i:255)*65536+(a<255?a<1?0:a:255)*256+(o<255?o<1?0:o:255)).toString(16).slice(1)},darkenColor(e,t){const s=parseInt(e.replace("#",""),16),n=Math.round(2.55*t),i=(s>>16)-n,a=(s>>8&255)-n,o=(s&255)-n;return"#"+(16777216+(i>255?255:i<0?0:i)*65536+(a>255?255:a<0?0:a)*256+(o>255?255:o<0?0:o)).toString(16).slice(1)},drawPanelBackground(e,t,s,n,i,a="default"){e.save();let o="rgba(0, 0, 0, 0.7)";if(a==="stone"?o="rgba(50, 50, 60, 0.8)":a==="paper"&&(o="rgba(245, 235, 215, 0.9)"),e.fillStyle=o,e.fillRect(t,s,n,i),e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=2,e.strokeRect(t,s,n,i),a==="stone"){e.strokeStyle="rgba(255, 255, 255, 0.2)",e.lineWidth=1;for(let l=1;l<3;l++)e.beginPath(),e.moveTo(t,s+i*l/3),e.lineTo(t+n,s+i*l/3),e.stroke()}e.restore()},startFlashEffect(e="rgba(255, 0, 0, 0.5)",t=15){this.flashEffect.active=!0,this.flashEffect.timer=t,this.flashEffect.duration=t,this.flashEffect.color=e},drawTextWithOutline(e,t,s,n,i,a,o="left",l="top",c=2){this.ctx.save(),this.ctx.font=a,this.ctx.textAlign=o,this.ctx.textBaseline=l,this.ctx.strokeStyle=i,this.ctx.lineWidth=c,this.ctx.strokeText(e,t,s),this.ctx.fillStyle=n,this.ctx.fillText(e,t,s),this.ctx.restore()},getMessageColor(e){return e.includes("せいかい！")||e.includes("弱点にヒット！")||e.includes("大ダメージ！")||e.includes("れんぞくせいかいボーナス！")||e.includes("かいふくせいこう！")||e.includes("シールドにヒビが入った！")||e.includes("ボスの防御が崩れた！")||e.includes("をたおした！")||e.includes("の経験値を獲得した！")?"#2ecc71":e.includes("弱点にヒット！")||e.includes("れんぞくせいかいボーナス！")?"#f1c40f":e.includes("こうげきしっぱい！")||e.includes("かいふくしっぱい！")||e.includes("のこうげき！")||e.includes("のダメージ！")?"#ff6b9d":e.includes("のダメージ！")?"#e74c3c":"white"},drawPlayerStatusPanel(e){v.panelPlayer&&e.drawImage(v.panelPlayer,20,450,260,130);const a=55,o=20+a,l=472,c=260-a*2;this.drawTextWithOutline(r.playerName,o,l,"#5C4033","#F5DEB3",'bold 16px "UDデジタル教科書体", sans-serif',"left","top",2),this.drawTextWithOutline(`Lv.${r.playerStats.level}`,o+c,l,"#DAA520","#654321",'bold 16px "UDデジタル教科書体", sans-serif',"right","top",2);const h=l+25,g=18;e.fillStyle="rgba(0, 0, 0, 0.2)",e.fillRect(o,h,c,g);const d=r.playerStats.hp/r.playerStats.maxHp;e.fillStyle=d>.5?"#2ecc71":d>.2?"#f39c12":"#e74c3c",e.fillRect(o,h,c*d,g),this.drawTextWithOutline(`${r.playerStats.hp} / ${r.playerStats.maxHp}`,o+c/2,h+g/2,"white","black",'12px "UDデジタル教科書体", sans-serif',"center","middle",2),this.drawTextWithOutline(`ATK: ${r.playerStats.attack}`,o,h+g+18,"#5C4033","#F5DEB3",'14px "UDデジタル教科書体", sans-serif',"left","top",2)},drawEnemyStatusPanel(e){if(v.panelEnemy&&e.drawImage(v.panelEnemy,500,10,280,120),!r.currentEnemy)return;const a=35,o=500+a,l=280-a*2,c=40,h=75,g=22,d=`Lv.${r.currentEnemy.level||1}`;if(this.drawTextWithOutline(d,o+l,c,"#FFD700","#000000",'bold 18px "UDデジタル教科書体", sans-serif',"right","top",3),r.currentEnemy.weakness){const y=e.measureText(d),p=20,w=o+l-y.width-8-p,E=c,b=r.currentEnemy.weakness==="onyomi"?v.iconOnyomi:v.iconKunyomi;b&&e.drawImage(b,w,E,p,p)}this.drawTextWithOutline(r.currentEnemy.name,o,c,"#FF6347","#000000",'bold 18px "UDデジタル教科書体", sans-serif',"left","top",3),e.fillStyle="rgba(0, 0, 0, 0.6)",e.fillRect(o,h,l,g);const m=r.currentEnemy.hp/r.currentEnemy.maxHp;e.fillStyle="#e74c3c",e.fillRect(o,h,l*m,g),this.drawTextWithOutline(`${r.currentEnemy.hp}/${r.currentEnemy.maxHp}`,o+l/2,h+g/2,"white","black",'14px "UDデジタル教科書体", sans-serif',"center","middle",2)},exit(){this.inputEl&&(this.inputEl.style.display="none",this.inputEl.removeEventListener("keydown",this._keydownHandler)),this._clickHandler&&this.unregisterHandlers(),this.timerId&&(clearInterval(this.timerId),this.timerId=null),this.canvas=this.ctx=this.inputEl=null},registerHandlers(){this._clickHandler=e=>{this.handleClick(e)},this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this._mousemoveHandler=e=>{const t=this.canvas.getBoundingClientRect(),s=this.canvas.width/t.width,n=this.canvas.height/t.height;this.mouseX=(e.clientX-t.left)*s,this.mouseY=(e.clientY-t.top)*n},this.canvas.addEventListener("mousemove",this._mousemoveHandler),this._wheelHandler=e=>{const t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,n=e.clientY-t.top,i=this.canvas.width-330,a=450;if(s>=i&&s<=i+310&&n>=a&&n<=a+130){e.preventDefault();const c=5,h=u.log.length,g=Math.max(0,h-c);e.deltaY<0?this.logOffset=Math.min(this.logOffset+1,g):this.logOffset=Math.max(0,this.logOffset-1)}},this.canvas.addEventListener("wheel",this._wheelHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler),this.canvas.removeEventListener("mousemove",this._mousemoveHandler),this.canvas.removeEventListener("wheel",this._wheelHandler)},handleClick(e){e.preventDefault();let t,s;e.changedTouches?(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY):(t=e.clientX,s=e.clientY);const n=this.canvas.getBoundingClientRect(),i=this.canvas.width/n.width,a=this.canvas.height/n.height,o=(t-n.left)*i,l=(s-n.top)*a;return C(o,l,ce.back)?(f("changeScreen","title"),!0):C(o,l,ce.stage)?(f("changeScreen","stageSelect"),!0):C(o,l,ce.attack)?(e.preventDefault(),e.stopPropagation(),Ae(),u.lastCommandMode="attack",!0):C(o,l,ce.heal)?(e.preventDefault(),e.stopPropagation(),Fe(),u.lastCommandMode="heal",!0):C(o,l,ce.hint)?(e.preventDefault(),e.stopPropagation(),Le(),u.lastCommandMode="hint",!0):!1},startReadingHighlight(e,t=60){this.readingHighlight.active=!0,this.readingHighlight.timer=t,this.readingHighlight.duration=t,this.readingHighlight.type=e},drawComboIndicator(e){const t=this.comboAnimation.active?this.comboAnimation.comboCount:u.comboCount;if(console.log("🔢 コンボ表示:",{comboCount:t,battleStateCombo:u.comboCount,animationActive:this.comboAnimation.active}),t<2)return;const s=this.canvas.width/2,n=200,a=s+180/2+40,o=n;e.save(),this.comboAnimation.active&&(e.translate(a,o),e.scale(this.comboAnimation.scale,this.comboAnimation.scale),e.translate(-a,-o));let l="#3498db";t>=10?l="#e74c3c":t>=5?l="#f39c12":t>=3&&(l="#2ecc71"),e.fillStyle="rgba(0, 0, 0, 0.6)",e.beginPath(),e.arc(a,o,35,0,Math.PI*2),e.fill(),e.strokeStyle=l,e.lineWidth=3,e.beginPath(),e.arc(a,o,35,0,Math.PI*2),e.stroke(),this.drawTextWithOutline(`${t}`,a,o-5,l,"black",'bold 28px "UDデジタル教科書体", sans-serif',"center","middle"),this.drawTextWithOutline("コンボ",a,o+20,"white","black",'bold 14px "UDデジタル教科書体", sans-serif',"center","middle"),e.restore()},startComboAnimation(e){this.comboAnimation.active=!0,this.comboAnimation.timer=this.comboAnimation.duration,this.comboAnimation.scale=1.5,this.comboAnimation.comboCount=e},startExpParticleEffect(e,t,s,n,i){this.expParticles={active:!0,particles:[],maxParticles:15,sourceX:e,sourceY:t,targetX:s,targetY:n,expAmount:i};for(let a=0;a<this.expParticles.maxParticles;a++){const o=Math.PI*2*a/this.expParticles.maxParticles+Math.random()*.5,l=2+Math.random()*3,c=a*3;this.expParticles.particles.push({x:e,y:t,vx:Math.cos(o)*l,vy:Math.sin(o)*l,life:0,maxLife:60+Math.random()*30,size:3+Math.random()*4,delay:c,phase:"spread",alpha:1,color:`hsl(${45+Math.random()*30}, 100%, ${60+Math.random()*20}%)`})}},startLevelUpEffect(e=120){if(this.levelUpEffect.active=!0,this.levelUpEffect.timer=e,this.levelUpEffect.duration=e,this.canvas){const n=this.canvas.style.transform||"",i=()=>{const c=(Math.random()-.5)*5,h=(Math.random()-.5)*5;this.canvas.style.transform=`${n} translate(${c}px, ${h}px)`};let a=0;const o=50,l=setInterval(()=>{i(),a+=o,a>=500&&(clearInterval(l),this.canvas.style.transform=n)},o)}},startTypewriterEffect(e){const t=u.log.length;if(t===0)return;const s=5,n=Math.max(0,t-s-this.logOffset),i=t-1-n;i>=0&&i<s&&(this.typewriterEffect.active=!0,this.typewriterEffect.targetMessage=e,this.typewriterEffect.displayedChars=0,this.typewriterEffect.messageIndex=i,this.typewriterEffect.charTimer=this.typewriterEffect.charInterval)},drawSimpleIcon(e,t,s,n,i,a){e.save(),e.fillStyle=a,e.font=`${i}px sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(s+i/2,n+i/2,i/2+2,0,Math.PI*2),e.fill(),e.fillStyle=a,e.fillText(t,s+i/2,n+i/2),e.restore()},startTypewriterEffect(e){const t=u.log.length;if(t===0)return;const s=5,n=Math.max(0,t-s-this.logOffset),i=t-1-n;i>=0&&i<s&&(this.typewriterEffect.active=!0,this.typewriterEffect.targetMessage=e,this.typewriterEffect.displayedChars=0,this.typewriterEffect.messageIndex=i,this.typewriterEffect.charTimer=this.typewriterEffect.charInterval)},drawOnyomiIcon(e,t,s,n){this.drawSimpleIcon(e,"🔴",t,s,n,"red")},drawKunyomiIcon(e,t,s,n){this.drawSimpleIcon(e,"🌿",t,s,n,"blue")},drawOnyomiIcon(e,t,s,n){e.save(),e.fillStyle="rgba(231, 76, 60, 0.2)",e.beginPath(),e.arc(t+n/2,s+n/2,n/2,0,Math.PI*2),e.fill();const i=t+n/2,a=s+n/2;e.strokeStyle="#e74c3c",e.lineWidth=2,e.lineCap="round",e.beginPath(),e.arc(i,a,n*.15,-Math.PI/3,Math.PI/3),e.stroke(),e.beginPath(),e.arc(i,a,n*.25,-Math.PI/4,Math.PI/4),e.stroke(),e.beginPath(),e.arc(i,a,n*.35,-Math.PI/6,Math.PI/6),e.stroke(),e.fillStyle="#e74c3c",e.beginPath(),e.arc(i,a,n*.08,0,Math.PI*2),e.fill(),e.restore()},drawKunyomiIcon(e,t,s,n){e.save(),e.fillStyle="rgba(46, 204, 113, 0.2)",e.beginPath(),e.arc(t+n/2,s+n/2,n/2,0,Math.PI*2),e.fill();const i=t+n/2,a=s+n/2;e.fillStyle="#27ae60",e.beginPath(),e.moveTo(i,a-n*.3),e.quadraticCurveTo(i+n*.25,a-n*.1,i+n*.15,a+n*.2),e.quadraticCurveTo(i,a+n*.3,i-n*.15,a+n*.2),e.quadraticCurveTo(i-n*.25,a-n*.1,i,a-n*.3),e.fill(),e.strokeStyle="#1e8449",e.lineWidth=1.5,e.lineCap="round",e.beginPath(),e.moveTo(i,a-n*.25),e.lineTo(i,a+n*.25),e.stroke(),e.beginPath(),e.moveTo(i,a-n*.1),e.lineTo(i-n*.12,a+n*.1),e.moveTo(i,a-n*.1),e.lineTo(i+n*.12,a+n*.1),e.stroke(),e.restore()},updateAndDrawExpParticles(){if(!this.ctx){console.warn("描画コンテキストがnullです。パーティクル更新をスキップします。"),this.expParticles.active=!1;return}const e=this.expParticles.particles;let t=0;for(let s=e.length-1;s>=0;s--){const n=e[s];if(n.delay>0){n.delay--,t++;continue}if(n.life++,n.phase==="spread")n.x+=n.vx,n.y+=n.vy,n.life>20&&(n.phase="converge");else if(n.phase==="converge"){const a=this.expParticles.targetX-n.x,o=this.expParticles.targetY-n.y,l=Math.sqrt(a*a+o*o);if(l<5){n.phase="arrived",this.expAnimQueue||(this.expAnimQueue=[]),this.expAnimQueue.push(Math.floor(this.expParticles.expAmount/this.expParticles.maxParticles)),this.createExpImpactEffect(n.x,n.y),e.splice(s,1);continue}else{const c=Math.min(8,l*.1);n.vx=a/l*c,n.vy=o/l*c,n.x+=n.vx,n.y+=n.vy}}if(n.life>n.maxLife){e.splice(s,1);continue}const i=n.life/n.maxLife;i>.8&&(n.alpha=1-(i-.8)/.2),this.drawExpParticle(n),t++}t===0&&(this.expParticles.active=!1)},drawExpParticle(e){if(!this.ctx){console.warn("描画コンテキストがnullです。パーティクル描画をスキップします。");return}this.ctx.save(),this.ctx.globalAlpha=e.alpha;const t=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,e.size*2);t.addColorStop(0,e.color),t.addColorStop(.5,e.color.replace(")",", 0.5)").replace("hsl","hsla")),t.addColorStop(1,"rgba(255, 255, 255, 0)"),this.ctx.fillStyle=t,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="rgba(255, 255, 255, 0.8)",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size*.3,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()},createExpImpactEffect(e,t){if(!this.ctx){console.warn("描画コンテキストがnullです。エフェクト描画をスキップします。");return}this.ctx.save();for(let n=0;n<6;n++){const i=Math.PI*2*n/6,a=8+Math.random()*4;this.ctx.strokeStyle="rgba(255, 215, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(e+Math.cos(i)*a,t+Math.sin(i)*a),this.ctx.stroke()}const s=this.ctx.createRadialGradient(e,t,0,e,t,12);s.addColorStop(0,"rgba(255, 255, 255, 0.9)"),s.addColorStop(.5,"rgba(255, 215, 0, 0.6)"),s.addColorStop(1,"rgba(255, 215, 0, 0)"),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e,t,12,0,Math.PI*2),this.ctx.fill(),this.ctx.restore(),f("playSE","expGain")},handleAttack(){typeof Ae=="function"?Ae():console.error("onAttack関数が定義されていません")},handleHeal(){typeof Fe=="function"?Fe():console.error("onHeal関数が定義されていません")},handleHint(){typeof Le=="function"?Le():console.error("onHint関数が定義されていません")},drawIconWithText(e,t,s,n,i,a="white"){t&&e.drawImage(t,n,i,this.UI_CONSTANTS.ICON_SIZE,this.UI_CONSTANTS.ICON_SIZE);const o=n+this.UI_CONSTANTS.ICON_SIZE+this.UI_CONSTANTS.ICON_MARGIN;this.drawTextWithOutline(s,o,i+this.UI_CONSTANTS.ICON_SIZE/2,a,"black")},drawWeaknessIndicator(e,t,s,n){const a={onyomi:{icon:v.iconOnyomi},kunyomi:{icon:v.iconKunyomi}}[t];if(!a||!a.icon)return;const o=32;e.drawImage(a.icon,s-o/2,n-o/2,o,o)},drawExpBarWithPercentage(e,t,s,n,i,a,o){Zs(e,t,s,n,i,a,o);const l=Math.floor(a/o*100),c=`${l}%`;e.font='10px "UDデジタル教科書体", sans-serif',e.textAlign="center";const h=l>50?"black":"white";this.drawTextWithOutline(c,t+n/2,s+i/2,h,h==="black"?"white":"black",'10px "UDデジタル教科書体", sans-serif',"center","middle",1)},getResponsiveLayout(){const e=this.canvas,t=e.width<600||e.height<400,s=e.width<800||e.height<600;return{panelScale:t?.8:s?.9:1,fontSize:t?12:s?14:16,buttonSize:t?.8:1,spacing:t?8:12}},drawResponsivePanel(e,t,s,n,i){const a=this.getResponsiveLayout(),o=t*a.panelScale,l=s*a.panelScale,c=n*a.panelScale,h=i*a.panelScale;return{x:o,y:l,w:c,h}},drawComboIndicatorWithTimer(e){if(!(u.comboCount<2)&&(this.drawComboIndicator(e),u.comboTimer>0)){const t=this.canvas.width/2,s=200,i=t+180/2+40,a=s,o=u.comboTimer/300,l=60,c=4;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(i-l/2,a+45,l,c);const h=o>.3?"#2ecc71":"#e74c3c";e.fillStyle=h,e.fillRect(i-l/2,a+45,l*o,c)}},ACCESSIBLE_COLORS:{success:"#2ecc71",warning:"#f39c12",danger:"#e74c3c",info:"#3498db",successPattern:"✓",warningPattern:"⚠",dangerPattern:"✗",infoPattern:"ℹ"},drawStatusWithPattern(e,t,s,n){const i=this.ACCESSIBLE_COLORS[t];i&&(e.fillStyle=i,e.fillRect(s,n,20,20),e.fillStyle="white",e.font="16px sans-serif",e.textAlign="center",e.fillText(this.ACCESSIBLE_COLORS[t+"Pattern"],s+10,n+15))},UI_CONSTANTS:{ICON_SIZE:16,ICON_MARGIN:8,TEXT_PADDING:12,SECTION_SPACING:20},startShakeEffect(e=15,t=5){this.shakeEffect.active=!0,this.shakeEffect.timer=e,this.shakeEffect.duration=e,this.shakeEffect.intensity=t,console.log("シェイクエフェクト開始:",e,t)},handleMouseDown(e){const t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,n=e.clientY-t.top;Object.entries(ce).forEach(([i,a])=>{C(s,n,a)&&this.pressedButtons.add(i)})},handleMouseUp(e){this.pressedButtons&&this.pressedButtons.clear()},registerHandlers(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseUp.bind(this))},unregisterHandlers(){this.canvas.removeEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.removeEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.removeEventListener("mouseleave",this.handleMouseUp.bind(this))}};function Xt(){const e=r.enemies[r.currentEnemyIndex];r.currentEnemy=e,Yt(e.name,e.hp,e.maxHp),u.log=[],de(`${e.name} があらわれた！`),f("playSE","appear"),r.hintLevel=0}function Ae(){if(console.log("🗡 onAttack() called — turn:",u.turn,"inputEnabled:",u.inputEnabled),u.turn!=="player"||!u.inputEnabled)return;u.inputEnabled=!1;const e=R.inputEl;if(!e)return;const t=e.value.trim(),s=Je(t),n=r.currentKanji.onyomi.join("、"),i=r.currentKanji.kunyomi.join("、"),a=`正しいよみ: 音「${n}」訓「${i}」`;if(wt(r.currentKanji).includes(s)){console.log("正解！エフェクト開始"),R.startKanjiBoxEffect("rgba(241, 196, 15, 0.8)",20),R.lastAnsweredKanji={...r.currentKanji},R.lastIncorrectAnswer=null,e.style.borderColor="green",e.style.backgroundColor="rgba(0, 255, 0, 0.1)",setTimeout(()=>{e.style.borderColor="#ccc",e.style.backgroundColor="white"},500),u.lastAnswered={...r.currentKanji},r.correctKanjiList.push({...r.currentKanji}),f("playSE","correct"),f("addToKanjiDex",r.currentKanji.id),r.playerStats.totalCorrect++,r.playerStats.comboCount++;const c=ne.find(w=>w.id===r.currentKanji.id);c&&(c.correctCount=(c.correctCount||0)+1,console.log(`📈 漢字ID:${r.currentKanji.id} の正解カウント: ${c.correctCount}`)),r.gameMode==="challenge"&&(u.timeRemaining+=5),u.comboCount++,u.comboCount>=2&&R.startComboAnimation(u.comboCount);let h=r.playerStats.attack,g=Math.random()*.2-.1,d=Math.round(h*(1+g)),m=null,y=!1;const p=r.currentKanji.kunyomi.includes(s),k=r.currentKanji.onyomi.includes(s);if(p&&!k?m="kunyomi":k&&!p?m="onyomi":p&&k&&(m=r.currentEnemy.weakness),m&&r.currentEnemy.weakness===m&&(y=!0,d=Math.floor(d*1.5),u.log.push("弱点にヒット！大ダメージ！"),r.playerStats.weaknessHits++,console.log(`🎯 弱点ヒット! 敵の弱点: ${r.currentEnemy.weakness}, プレイヤーの読み: ${m}`)),u.comboCount===5&&(d=Math.floor(d*1.5),u.log.push("れんぞくせいかいボーナス！"),u.comboCount=0),r.currentEnemy.isBoss)if(r.currentEnemy.shieldHp>0)if(y){r.currentEnemy.shieldHp--,u.log.push(`せいかい！${a}`),u.log.push("シールドにヒビが入った！"),r.currentEnemy.shieldHp===0&&u.log.push("ボスの防御が崩れた！"),d=0,u.lastCommandMode="attack",u.turn="enemy",u.inputEnabled=!1,setTimeout(()=>{Ze(),setTimeout(()=>{Te(),u.turn="player",u.inputEnabled=!0},1500)},1e3),e.value="";return}else d=1,u.log.push(`せいかい！${a}、しかし${r.currentEnemy.name}の防御は固い！`);else u.log.push(`せいかい！${a}、${r.currentEnemy.name}に${d}のダメージ！`);else u.log.push(`せいかい！${a}、${r.currentEnemy.name}に${d}のダメージ！`);if(d>0&&(r.currentEnemy.hp=Math.max(0,r.currentEnemy.hp-d)),u.enemyAction="damage",u.enemyActionTimer=zs,Yt(r.currentEnemy.name,r.currentEnemy.hp,r.currentEnemy.maxHp),r.currentEnemy.hp===0){u.log.push(`${r.playerName}は${r.currentEnemy.name}をたおした！`),f("playSE","defeat"),u.enemyAction="defeat",u.enemyActionTimer=Gt,r.currentEnemy.isBoss&&r.playerStats.bossesDefeated++,Gs(r.currentEnemy.id),gs(),Ge().catch($=>{console.error("実績チェック中にエラーが発生しました:",$)});const w=r.currentEnemy.exp||30,E=480+240/2,b=80+120/2,T=20,G=R.canvas.height-120+25+35,F=T+140;R.startExpParticleEffect(E,b,F,G,w),u.log.push(`${w}の経験値を獲得した！`),r.currentEnemyIndex<r.enemies.length-1?setTimeout(()=>{const $=R.inputEl;$&&($.value=""),r.currentEnemyIndex++,Xt(),Te(),u.turn="player",u.inputEnabled=!0,r.hintLevel=0},500):setTimeout(()=>{const $=R.inputEl;$&&($.value=""),R.stageClearPending=!0},500);return}else u.lastCommandMode="attack",u.turn="enemy",u.inputEnabled=!1,setTimeout(()=>{Ze(),setTimeout(()=>{Te(),u.turn="player",u.inputEnabled=!0},1500)},1e3)}else{e.style.borderColor="red",e.style.backgroundColor="rgba(255, 0, 0, 0.1)",setTimeout(()=>{e.style.borderColor="#ccc",e.style.backgroundColor="white"},500),R.lastIncorrectAnswer=s,u.lastAnswered={...r.currentKanji},r.wrongKanjiList.push({...r.currentKanji}),f("addToReview",r.currentKanji.id),f("playSE","wrong"),de(`こうげきしっぱい！${a}`),r.playerStats.totalIncorrect++,u.mistakesThisStage++,r.playerStats.comboCount=0;const c=ne.find(p=>p.id===r.currentKanji.id);c&&(c.incorrectCount=(c.incorrectCount||0)+1,console.log(`📉 漢字ID:${r.currentKanji.id} の不正解カウント: ${c.incorrectCount}`)),u.comboCount=0,u.comboTimer=0,console.log("❌ 不正解によりコンボがリセットされました");const h=r.currentKanji.onyomi||[],g=r.currentKanji.kunyomi||[];let d=1/0,m=1/0;for(const p of h){const k=_t(s,p);d=Math.min(d,k)}for(const p of g){const k=_t(s,p);m=Math.min(m,k)}let y;d<m?y="onyomi":y="kunyomi",R.startReadingHighlight(y),u.turn="enemy",u.inputEnabled=!1,console.log("🔄 敵のターンに移行します"),setTimeout(()=>{console.log("👹 敵の攻撃を開始"),Ze(),setTimeout(()=>{console.log("📝 次の漢字を出題"),Te(),setTimeout(()=>{console.log("🎮 プレイヤーターンに戻ります"),u.turn="player",u.inputEnabled=!0},500)},1500)},1e3)}e.value=""}function _t(e,t){const s=e.trim().toLowerCase(),n=t.trim().toLowerCase(),i=[];for(let a=0;a<=n.length;a++)i[a]=[a];for(let a=0;a<=s.length;a++)i[0][a]=a;for(let a=1;a<=n.length;a++)for(let o=1;o<=s.length;o++)n.charAt(a-1)===s.charAt(o-1)?i[a][o]=i[a-1][o-1]:i[a][o]=Math.min(i[a-1][o-1]+1,i[a][o-1]+1,i[a-1][o]+1);return i[n.length][s.length]}function Fe(){if(console.log("💚 onHeal() called — turn:",u.turn,"inputEnabled:",u.inputEnabled),u.turn!=="player"||!u.inputEnabled)return;if(r.playerStats.healCount<=0){alert("回復はもう使えません！");return}u.inputEnabled=!1;const e=R.inputEl;if(!e)return;const t=e.value.trim(),s=Je(t),n=r.currentKanji.onyomi.join("、"),i=r.currentKanji.kunyomi.join("、"),a=`正しいよみ: 音「${n}」訓「${i}」`;if(wt(r.currentKanji).includes(s))R.lastIncorrectAnswer=null,u.lastAnswered={...r.currentKanji},u.comboCount++,r.correctKanjiList.push({...r.currentKanji}),f("playSE","correct"),f("addToKanjiDex",r.currentKanji.id),r.playerStats.totalCorrect++,r.playerStats.comboCount++,r.playerStats.hp,f("playSE","heal"),r.playerStats.hp=Math.min(r.playerStats.maxHp,r.playerStats.hp+30),u.playerHpTarget=r.playerStats.hp,u.playerHpAnimating=!0,u.log.push(`かいふくせいこう！${a}`),r.playerStats.healsSuccessful++,r.gameMode==="challenge"&&(u.timeRemaining+=5);else if(R.lastIncorrectAnswer=s,u.lastAnswered={...r.currentKanji},r.wrongKanjiList.push({...r.currentKanji}),f("addToReview",r.currentKanji.id),f("playSE","wrong"),de(`かいふくしっぱい！${a}`),r.playerStats.totalIncorrect++,u.mistakesThisStage++,r.playerStats.comboCount=0,r.gameMode==="challenge"){const c=r.currentEnemy.atk||5;if(r.playerStats.hp=Math.max(0,r.playerStats.hp-c),r.playerStats.hp===0)return setTimeout(()=>f("changeScreen","gameOver"),500)}e.value="",u.turn="enemy",setTimeout(()=>{Ze(),Te(),setTimeout(()=>{u.turn="player",u.inputEnabled=!0},500)},1e3)}function Le(){switch(r.hintLevel=(r.hintLevel+1)%4,r.hintLevel){case 0:de("ヒントを非表示にした");break;case 1:de(`ヒント（基本）: 画数は${r.currentKanji.strokes}`);break;case 2:const e=Math.random()>.5,t=e?r.currentKanji.onyomi:r.currentKanji.kunyomi;if(t&&t.length>0){const n=t[0].substring(0,1)+"○○";de(`ヒント（読み）: ${e?"音読み":"訓読み"}は「${n}」から始まる`)}else de(`ヒント（読み）: ${e?"訓読み":"音読み"}で読むことが多い`);break;case 3:de(`ヒント（意味）: ${r.currentKanji.meaning}`);break}}function Ze(){u.enemyAction="attack",u.enemyActionTimer=Wt;const e=r.currentEnemy.atk||5;if(u.log.push(`${r.currentEnemy.name} のこうげき！${r.playerName}に${e}のダメージ！`),r.playerStats.hp=Math.max(0,r.playerStats.hp-e),u.playerHpTarget=r.playerStats.hp,u.playerHpAnimating=!0,R.startFlashEffect("rgba(255, 0, 0, 0.5)",15),f("playSE","damage"),r.playerStats.hp<=0)return R.timerId&&(clearInterval(R.timerId),R.timerId=null),setTimeout(()=>f("changeScreen","gameOver"),1500)}function Te(){r.hintLevel=0,console.log("🎯 pickNextKanji() 開始 (属性システム対応)");const e=r.currentEnemy;if(!e||!e.weakness)return console.warn("⚠️ 敵の弱点情報が見つかりません。通常の選択方法を使用します。"),Ue(r.kanjiPool,"全体プール");console.log(`🎯 敵の弱点: ${e.weakness}`);const t=e.weakness==="onyomi"?u.kanjiPool_onyomi:u.kanjiPool_kunyomi,s=e.weakness==="onyomi"?u.kanjiPool_kunyomi:u.kanjiPool_onyomi;console.log(`📋 第一候補プール: ${t.length}件`),console.log(`📋 フォールバックプール: ${s.length}件`);const n=Ue(t,"第一候補");if(n)return console.log("✅ 第一候補プールから問題を選択しました"),n;console.log("⚠️ 第一候補プールが尽きました。フォールバックプールを使用します。");const i=Ue(s,"フォールバック");return i?(console.log("✅ フォールバックプールから問題を選択しました"),i):(console.warn("⚠️ 全てのプールが尽きました。全体プールから強制選択します。"),Ue(r.kanjiPool,"最終フォールバック"))}function Ue(e,t){if(!e||e.length===0)return console.warn(`⚠️ ${t}が空です`),!1;let s=e.filter(a=>!u.recentKanjiIds.includes(a.id));s.length===0&&(console.warn(`⚠️ ${t}の全ての漢字が直近に出題済みです。全範囲から選択します。`),s=e);const n=s[Math.floor(Math.random()*s.length)];if(!n)return console.error(`❌ ${t}から漢字を選択できませんでした`),!1;u.recentKanjiIds.push(n.id),u.recentKanjiIds.length>Ks&&u.recentKanjiIds.shift();const i=a=>a?Array.isArray(a)?a.map(o=>Je(o.trim())).filter(Boolean):typeof a=="string"?a.split(" ").map(o=>Je(o.trim())).filter(Boolean):[]:[];return r.currentKanji={id:n.id,text:n.kanji,kunyomi:i(n.kunyomi),onyomi:i(n.onyomi),weakness:n.weakness,readings:wt(n),meaning:n.meaning,strokes:n.strokes},r.showHint=!1,de(`「${r.currentKanji.text}」をよもう！`),console.log(`✅ ${t}から選択: ${n.kanji} (ID: ${n.id})`),console.log("📝 直近リスト:",u.recentKanjiIds),!0}function Yt(e,t,s){const n=R.ctx,i=R.canvas;if(!n||!i)return;n.clearRect(0,0,i.width,50),n.fillStyle="white",n.font='20px "UDデジタル教科書体",sans-serif',n.fillText(`${e} HP: ${t}／${s}`,20,30);const a=200,o=t/s;n.fillStyle="red",n.fillRect(20,35,a*o,10),n.strokeStyle="white",n.strokeRect(20,35,a,10)}const Vs=e=>String.fromCharCode(e.charCodeAt(0)-96),He=e=>e.replace(/[\u30a1-\u30f6]/g,Vs).trim();function wt(e){const t=new Set;return e.kunyomi&&(Array.isArray(e.kunyomi)?e.kunyomi.forEach(s=>{s&&typeof s=="string"&&t.add(He(s.trim()))}):typeof e.kunyomi=="string"&&e.kunyomi.split(" ").forEach(s=>{s&&t.add(He(s.trim()))})),e.onyomi&&(Array.isArray(e.onyomi)?e.onyomi.forEach(s=>{s&&typeof s=="string"&&t.add(He(s.trim()))}):typeof e.onyomi=="string"&&e.onyomi.split(" ").forEach(s=>{s&&t.add(He(s.trim()))})),[...t].filter(Boolean)}function Je(e){if(!e)return"";let t=e.trim().replace(/\s+/g,"");return t=He(t),t}function Zs(e,t,s,n,i,a,o){if(e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(t,s,n,i),o>0){const l=Math.min(a/o,1),c=e.createLinearGradient(t,s,t,s+i);if(c.addColorStop(0,"#f1c40f"),c.addColorStop(1,"#f39c12"),e.fillStyle=c,e.fillRect(t,s,n*l,i),R.playerExpAnimating){const g=t+n*l-5,d=e.createLinearGradient(g,s,g+5,s);d.addColorStop(0,"rgba(255, 255, 255, 0.1)"),d.addColorStop(.5,"rgba(255, 255, 255, 0.8)"),d.addColorStop(1,"rgba(255, 255, 255, 0.1)"),e.fillStyle=d,e.fillRect(g,s,5,i),e.fillStyle="rgba(255, 255, 255, 0.7)";for(let m=0;m<3;m++){const y=t+Math.random()*(n*l),p=s+Math.random()*i,k=1+Math.random()*2;e.fillRect(y,p,k,k)}}}e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=1,e.strokeRect(t,s,n,i),e.strokeStyle="rgba(255, 255, 255, 0.2)",e.beginPath();for(let l=1;l<5;l++){const c=t+n*l/5;e.moveTo(c,s),e.lineTo(c,s+i)}e.stroke()}function Ot(e){if(!Number.isInteger(e)||e<1||e===1)return 100;const t=Ot(e-1);return Math.floor(t*1.2)+20}function de(e){u.log.push(e),R.startTypewriterEffect(e)}function Pt(e){return{enter(t){const s=e==="default"?r.currentStageId:e;console.log(`🎮 battleStateFactory.enter() - ステージ: ${s}`,{props:t}),kt(s),Rt(s),r.currentStageId=s,Ie(s);let n=t;if((!n||typeof n!="object"||!n.getContext)&&(console.log("引数からキャンバスを取得できません。DOMから取得します。"),n=document.getElementById("gameCanvas")),!n){console.error("gameCanvas要素が見つかりません"),alert("ゲーム画面が見つかりません。ステージ選択に戻ります。"),f("changeScreen","stageSelect");return}console.log("🖼️ キャンバス要素を取得しました:",n),R.enter(n,()=>{localStorage.setItem(`clear_${s}`,"1"),r.currentStageId,r.correctKanjiList,r.wrongKanjiList,r.playerStats.hp,f("changeScreen","resultWin")})},update(t){R.update(t)},exit(){R.exit()}}}const Ke=[{label:"1年",grade:1},{label:"2年",grade:2},{label:"3年",grade:2},{label:"4年",grade:4},{label:"5年",grade:5},{label:"6年",grade:6},{label:"総復習",grade:0}],qs={enter(e){this.canvas=e||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),r.currentGrade==null&&(r.currentGrade=1),this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler)},update(e){const{ctx:t,canvas:s}=this,n=s.width,i=s.height,a=Ke.length,o=n/a,l=50;t.clearRect(0,0,n,i),t.textAlign="center",t.textBaseline="middle",t.font="16px sans-serif",Ke.forEach((c,h)=>{const g=h*o;t.fillStyle=c.grade===r.currentGrade?"#ddd":"#ccc",t.fillRect(g,0,o,l),t.fillStyle="#000",t.fillText(c.label,g+o/2,l/2);const d=this.getClearRate(c.grade)+"%",m=4;t.font="12px sans-serif";const p=t.measureText(d).width+m*2,k=20,w=g+o-p-8,E=8;t.fillStyle="#f00",t.fillRect(w,E,p,k),t.fillStyle="#fff",t.fillText(d,w+p/2,E+k/2),t.font="16px sans-serif"})},exit(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas=null,this.ctx=null},handleClick(e){const t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,n=Math.floor(s/(this.canvas.width/Ke.length)),i=Ke[n];i&&(r.currentGrade=i.grade,f("changeScreen","stageSelect"))},getClearRate(e){var o;const s=((o=window.fsm)!=null&&o.states?Object.keys(window.fsm.states):[]).filter(l=>l!=="stageSelect"),n=e===0?s:s.filter(l=>l.startsWith(`${e}_`)),i=n.length;if(i===0)return 0;const a=n.filter(l=>localStorage.getItem(`clear_${l}`)).length;return Math.round(a/i*100)}},lt=[{grade:1,name:"北海道",x:665,y:170,color:"#4A90E2"},{grade:2,name:"東北",x:615,y:220,color:"#7ED321"},{grade:3,name:"関東",x:595,y:290,color:"#F5A623"},{grade:4,name:"中部",x:535,y:315,color:"#BD10E0"},{grade:5,name:"近畿",x:475,y:355,color:"#B8E986"},{grade:6,name:"中国",x:415,y:375,color:"#50E3C2"}],be={x:10,y:540,width:120,height:40,text:"タイトルへ"},Js={canvas:null,ctx:null,animationTime:0,hoveredMarker:null,isZooming:!1,zoomProgress:0,zoomTarget:null,zoomStartTime:0,zoomDuration:800,camera:{x:0,y:0,scale:1,targetX:0,targetY:0,targetScale:1},enter(e){this.canvas=e||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.animationTime=0,this.hoveredMarker=null,this.isZooming=!1,this.zoomProgress=0,this.zoomTarget=null,this.camera={x:0,y:0,scale:1,targetX:0,targetY:0,targetScale:1},this._clickHandler=this.handleClick.bind(this),this._mouseMoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mouseMoveHandler)},calculateRegionProgress(e){const t=W.filter(n=>n.grade===e);if(t.length===0)return 0;const s=t.filter(n=>{var o;const i=localStorage.getItem(`clear_${n.stageId}`),a=r.stageProgress&&((o=r.stageProgress[n.stageId])==null?void 0:o.cleared);return i||a});return Math.round(s.length/t.length*100)},getNextRegion(){for(let e=1;e<=6;e++)if(this.calculateRegionProgress(e)<100)return e;return null},startZoomAnimation(e){this.isZooming=!0,this.zoomProgress=0,this.zoomTarget=e,this.zoomStartTime=this.animationTime;const t=this.canvas.width/2,s=this.canvas.height/2;let n=2.2;e.grade===1?n=2.5:e.grade===4&&(n=2),this.camera.targetX=t-e.x*n,this.camera.targetY=s-e.y*n,this.camera.targetScale=n,f("playSE","decide")},updateZoomAnimation(e){if(!this.isZooming)return;const t=this.animationTime-this.zoomStartTime;this.zoomProgress=Math.min(t/this.zoomDuration,1);const s=this.zoomProgress<.5?4*this.zoomProgress*this.zoomProgress*this.zoomProgress:1-Math.pow(-2*this.zoomProgress+2,3)/2,n=.15;this.camera.x=this.camera.x+(this.camera.targetX-this.camera.x)*s*n,this.camera.y=this.camera.y+(this.camera.targetY-this.camera.y)*s*n,this.camera.scale=this.camera.scale+(this.camera.targetScale-this.camera.scale)*s*n,this.zoomProgress>=1&&(this.camera.x=this.camera.targetX,this.camera.y=this.camera.targetY,this.camera.scale=this.camera.targetScale,this.isZooming=!1,r.currentGrade=this.zoomTarget.grade,setTimeout(()=>{f("changeScreen","stageSelect")},200))},update(e){this.animationTime+=e,this.updateZoomAnimation(e),this.ctx.save(),this.ctx.translate(this.camera.x,this.camera.y),this.ctx.scale(this.camera.scale,this.camera.scale),this.ctx.fillStyle="#87CEEB",this.ctx.fillRect(-this.camera.x/this.camera.scale,-this.camera.y/this.camera.scale,this.canvas.width/this.camera.scale,this.canvas.height/this.camera.scale),this.drawJapanMap(),this.drawTitle(),this.drawRegionMarkers(),this.ctx.restore(),this.isZooming||Z(this.ctx,be.x,be.y,be.width,be.height,be.text),this.hoveredMarker&&!this.isZooming&&this.drawMarkerTooltip(this.hoveredMarker)},drawJapanMap(){const e=v.stageSelect0||v.stageSelect;if(e){const t=this.canvas.width*.3,s=100,n=this.canvas.width*.65,i=this.canvas.height-200;this.ctx.drawImage(e,t,s,n,i),this.ctx.save(),this.ctx.globalAlpha=.3,this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.ctx.fillRect(t+5,s+5,n,i),this.ctx.restore()}else console.warn("日本地図画像が見つかりません。シンプルな代替地図を表示します。"),this.drawFallbackJapanMap()},drawFallbackJapanMap(){const e=this.canvas.width*.3,t=100,s=this.canvas.width*.65,n=this.canvas.height-200;this.ctx.fillStyle="#4682B4",this.ctx.fillRect(e,t,s,n),this.ctx.fillStyle="#228B22",this.ctx.strokeStyle="#006400",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.ellipse(e+s*.5,t+n*.6,s*.35,n*.15,-.2,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(e+s*.7,t+n*.25,s*.15,n*.12,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(e+s*.25,t+n*.85,s*.12,n*.08,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(e+s*.4,t+n*.75,s*.08,n*.05,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.strokeStyle="#2F4F4F",this.ctx.lineWidth=3,this.ctx.strokeRect(e,t,s,n)},drawTitle(){const e=this.canvas.width/2;if(v.woodenSign)this.ctx.drawImage(v.woodenSign,e-200,10,400,80);else{this.ctx.fillStyle="#8B4513",this.ctx.fillRect(e-200,20,400,60),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=2;for(let t=0;t<5;t++)this.ctx.beginPath(),this.ctx.moveTo(e-190,30+t*10),this.ctx.lineTo(e+190,30+t*10),this.ctx.stroke();this.ctx.strokeStyle="#4A4A4A",this.ctx.lineWidth=3,this.ctx.strokeRect(e-200,20,400,60)}this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,this.ctx.textAlign="center",this.ctx.font="bold 28px serif",this.ctx.strokeText("挑戦する地方を選ぼう",e,55),this.ctx.fillText("挑戦する地方を選ぼう",e,55)},drawRegionMarkers(){const e=this.getNextRegion();this.hoveredMarker&&this.drawRegionBoundaryHighlight(this.hoveredMarker),lt.forEach(t=>{const s=this.hoveredMarker===t,n=e===t.grade;let a=1+Math.sin(this.animationTime*.003)*.1;s&&(a=1.4+Math.sin(this.animationTime*.01)*.1);const o=this.calculateRegionProgress(t.grade),l=s?5:3;if(this.ctx.fillStyle=`rgba(0, 0, 0, ${s?.4:.3})`,this.ctx.beginPath(),this.ctx.ellipse(t.x+l,t.y+l,25*a,25*a,0,0,2*Math.PI),this.ctx.fill(),s){const c=40*a,h=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,c);h.addColorStop(0,`${t.color}40`),h.addColorStop(.7,`${t.color}20`),h.addColorStop(1,"transparent"),this.ctx.fillStyle=h,this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y,c,c,0,0,2*Math.PI),this.ctx.fill()}if(v.regionMarker){const c=50*a;this.ctx.drawImage(v.regionMarker,t.x-c/2,t.y-c/2,c,c)}else this.ctx.fillStyle=s?this.lightenColor(t.color,30):t.color,this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y,25*a,25*a,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y,18*a,18*a,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=s?this.lightenColor(t.color,30):t.color,this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y,8*a,8*a,0,0,2*Math.PI),this.ctx.fill();if(this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,this.ctx.textAlign="center",this.ctx.font=`bold ${16*a}px sans-serif`,this.ctx.strokeText(t.grade.toString(),t.x,t.y+5),this.ctx.fillText(t.grade.toString(),t.x,t.y+5),this.drawProgressBar(t.x,t.y+40*a,o,s),this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=1,this.ctx.textAlign="center",this.ctx.font=`bold ${12*(s?1.1:1)}px sans-serif`,this.ctx.strokeText(`${o}%`,t.x,t.y+65*a),this.ctx.fillText(`${o}%`,t.x,t.y+65*a),n&&this.drawNextIndicator(t.x,t.y),s){this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y,35*a,35*a,0,0,2*Math.PI),this.ctx.stroke();for(let c=0;c<12;c++){const h=(this.animationTime*.003+c*Math.PI/6)%(2*Math.PI),g=45+Math.sin(this.animationTime*.005+c)*5,d=t.x+Math.cos(h)*g,m=t.y+Math.sin(h)*g,y=.5+.5*Math.sin(this.animationTime*.008+c);this.ctx.fillStyle=`rgba(255, 215, 0, ${y})`,this.ctx.beginPath(),this.ctx.ellipse(d,m,4,4,0,0,2*Math.PI),this.ctx.fill()}}})},drawRegionBoundaryHighlight(e){const t=`region${e.grade}Boundary`,s=v[t];if(s){const n=this.canvas.width*.3,i=100,a=this.canvas.width*.65,o=this.canvas.height-200,l=.4+.3*Math.sin(this.animationTime*.008);this.ctx.save(),this.ctx.globalAlpha=l,this.ctx.globalCompositeOperation="multiply",this.ctx.fillStyle=e.color,this.ctx.fillRect(n,i,a,o),this.ctx.globalCompositeOperation="source-over",this.ctx.globalAlpha=l*1.5,this.ctx.drawImage(s,n,i,a,o),this.ctx.restore(),this.drawBoundaryGlowEffect(n,i,a,o,e.color)}else this.drawFallbackRegionHighlight(e)},drawBoundaryGlowEffect(e,t,s,n,i){this.ctx.save();const a=.3+.4*Math.sin(this.animationTime*.01);this.ctx.strokeStyle=i,this.ctx.lineWidth=4,this.ctx.globalAlpha=a,this.ctx.shadowColor=i,this.ctx.shadowBlur=15,this.ctx.strokeRect(e,t,s,n),this.ctx.restore()},drawFallbackRegionHighlight(e){const t=this.canvas.width*.3,s=100,n=this.canvas.width*.65,i=this.canvas.height-200,a=.2+.2*Math.sin(this.animationTime*.008);switch(this.ctx.save(),this.ctx.globalAlpha=a,this.ctx.fillStyle=e.color,e.grade){case 1:this.ctx.fillRect(t+n*.6,s,n*.4,i*.4);break;case 2:this.ctx.fillRect(t+n*.5,s+i*.3,n*.3,i*.3);break;case 3:this.ctx.fillRect(t+n*.45,s+i*.45,n*.25,i*.25);break;case 4:this.ctx.fillRect(t+n*.3,s+i*.4,n*.3,i*.3);break;case 5:this.ctx.fillRect(t+n*.25,s+i*.5,n*.25,i*.25);break;case 6:this.ctx.fillRect(t+n*.1,s+i*.55,n*.3,i*.25);break}this.ctx.restore()},lightenColor(e,t){const s=parseInt(e.replace("#",""),16),n=Math.round(2.55*t),i=(s>>16)+n,a=(s>>8&255)+n,o=(s&255)+n;return"#"+(16777216+(i<255?i<1?0:i:255)*65536+(a<255?a<1?0:a:255)*256+(o<255?o<1?0:o:255)).toString(16).slice(1)},drawProgressBar(e,t,s,n=!1){const i=n?70:60,a=n?10:8,o=e-i/2,l=t-a/2;this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(o,l,i,a);const c=i*s/100;s===100?this.ctx.fillStyle=n?"#FFED4E":"#FFD700":s>=75?this.ctx.fillStyle=n?"#4ADE80":"#32CD32":s>=50?this.ctx.fillStyle=n?"#FBBF24":"#FFA500":s>=25?this.ctx.fillStyle=n?"#FB7185":"#FF6347":this.ctx.fillStyle=n?"#F87171":"#FF4500",this.ctx.fillRect(o,l,c,a),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=n?2:1,this.ctx.strokeRect(o,l,i,a)},drawNextIndicator(e,t){const s=.5+.5*Math.sin(this.animationTime*.008);this.ctx.fillStyle=`rgba(255, 69, 0, ${s})`,this.ctx.fillRect(e+35,t-20,50,20),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(e+35,t-20,50,20),this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=1,this.ctx.textAlign="center",this.ctx.font="bold 10px sans-serif",this.ctx.strokeText("NEXT!",e+60,t-7),this.ctx.fillText("NEXT!",e+60,t-7);const n=Math.sin(this.animationTime*.01)*3;this.ctx.fillStyle=`rgba(255, 215, 0, ${s})`,this.ctx.beginPath(),this.ctx.moveTo(e+30+n,t-10),this.ctx.lineTo(e+25+n,t-15),this.ctx.lineTo(e+25+n,t-5),this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=1,this.ctx.stroke()},drawMarkerTooltip(e){const t=this.calculateRegionProgress(e.grade),s=W.filter(d=>d.grade===e.grade),n=s.filter(d=>{var p;const m=localStorage.getItem(`clear_${d.stageId}`),y=r.stageProgress&&((p=r.stageProgress[d.stageId])==null?void 0:p.cleared);return m||y}),i=e.x*this.camera.scale+this.camera.x,a=e.y*this.camera.scale+this.camera.y,o=i+40,l=a-50,c=200,h=90,g=this.ctx.createLinearGradient(o,l,o,l+h);g.addColorStop(0,"rgba(0, 0, 0, 0.95)"),g.addColorStop(1,"rgba(20, 20, 20, 0.95)"),this.ctx.fillStyle=g,this.ctx.fillRect(o,l,c,h),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(o,l,c,h),this.ctx.strokeStyle="rgba(255, 215, 0, 0.5)",this.ctx.lineWidth=1,this.ctx.strokeRect(o+2,l+2,c-4,h-4),this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.font="bold 16px sans-serif",this.ctx.fillText(`${e.grade}年生 ${e.name}地方`,o+10,l+25),this.ctx.font="14px sans-serif",this.ctx.fillStyle=t===100?"#FFD700":"#FFFFFF",this.ctx.fillText(`進捗: ${t}%`,o+10,l+50),this.ctx.fillStyle="#CCCCCC",this.ctx.font="12px sans-serif",this.ctx.fillText(`${n.length} / ${s.length} ステージクリア`,o+10,l+70)},handleMouseMove(e){if(this.isZooming)return;const t=this.canvas.getBoundingClientRect(),s=this.canvas.width/t.width,n=this.canvas.height/t.height,i=(e.clientX-t.left)*s,a=(e.clientY-t.top)*n,o=(i-this.camera.x)/this.camera.scale,l=(a-this.camera.y)/this.camera.scale,c=this.hoveredMarker;this.hoveredMarker=null;for(const h of lt)if(Math.sqrt((o-h.x)**2+(l-h.y)**2)<=35){this.hoveredMarker=h,this.canvas.style.cursor="pointer",c!==h&&f("playSE","hover");break}this.hoveredMarker||(this.canvas.style.cursor="default")},exit(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler),this.canvas.removeEventListener("mousemove",this._mouseMoveHandler),this.canvas.style.cursor="default"},handleClick(e){if(this.isZooming)return;e.preventDefault();let t,s;e.changedTouches?(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY):(t=e.clientX,s=e.clientY);const n=this.canvas.getBoundingClientRect(),i=this.canvas.width/n.width,a=this.canvas.height/n.height,o=(t-n.left)*i,l=(s-n.top)*a,c=(o-this.camera.x)/this.camera.scale,h=(l-this.camera.y)/this.camera.scale;for(const g of lt)if(Math.sqrt((c-g.x)**2+(h-g.y)**2)<=35){this.startZoomAnimation(g);return}if(C(o,l,be)){f("playSE","decide"),f("changeScreen","title");return}},render(){this.update(0)}},we=32,Qs={enter(e,t={}){this.canvas=e||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const{grade:s,region:n}=t;s!=null&&(r.currentGrade=s),n!=null&&(r.currentRegion=n),this.stages=W.filter(i=>i.grade===r.currentGrade&&i.region===r.currentRegion),this._click=this.handleClick.bind(this),this.canvas.addEventListener("click",this._click),this._key=this.handleKeydown.bind(this),window.addEventListener("keydown",this._key)},update(e){const{ctx:t,canvas:s,stages:n}=this;t.clearRect(0,0,s.width,s.height),n.forEach(i=>{const{pos:a}=i;v.markerPref?t.drawImage(v.markerPref,a.x,a.y,we,we):(t.fillStyle="#f00",t.fillRect(a.x,a.y,we,we))})},exit(){this.canvas.removeEventListener("click",this._click),window.removeEventListener("keydown",this._key),this.canvas=null,this.ctx=null,this.stages=[]},handleClick(e){const t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,n=e.clientY-t.top;for(const i of this.stages){const{pos:a,stageId:o}=i;if(s>=a.x&&s<=a.x+we&&n>=a.y&&n<=a.y+we){r.currentStageId=o,f("changeScreen","battle");return}}},handleKeydown(e){e.key==="Escape"&&f("changeScreen","regionSelect")}},en=()=>{let e=document.getElementById("uiOverlay");return e||(e=document.createElement("div"),e.id="uiOverlay",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.pointerEvents="none",document.body.appendChild(e)),e},j={width:160,height:40,gap:20,y:540},Ut=j.width*4+j.gap*3,Xe=(800-Ut)/2,rt={x:Xe,y:j.y,width:j.width,height:j.height,text:"もどる",icon:"⬅️"},ct={x:Xe+(j.width+j.gap)*1,y:j.y,width:j.width,height:j.height,text:"復習",icon:"📖"},ht={x:Xe+(j.width+j.gap)*2,y:j.y,width:j.width,height:j.height,text:"漢字図鑑",icon:"📚"},dt={x:Xe+(j.width+j.gap)*3,y:j.y,width:j.width,height:j.height,text:"モンスター",icon:"👾"},oe=32,ze=[{label:"1年",grade:1},{label:"2年",grade:2},{label:"3年",grade:3},{label:"4年",grade:4},{label:"5年",grade:5},{label:"6年",grade:6},{label:"総復習",grade:0}],Kt={canvas:null,ctx:null,stages:[],stageButtons:[],_clickHandler:null,_mousemoveHandler:null,cbToggle:null,fontToggle:null,mouseX:0,mouseY:0,hoveredStage:null,selectedStage:null,animationTime:0,crossfadeState:{active:!1,timer:0,duration:30,oldImage:null,newImage:null,oldGrade:null,newGrade:null},reviewChallengeButton:{x:50,y:200,width:300,height:80,text:"今日の復習に挑戦！"},enter(e){f("playBGM","title"),this.canvas=e&&typeof e.getContext=="function"?e:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),r.currentGrade==null&&(r.currentGrade=0),this.updateStageList(),this._clickHandler=this.handleClick.bind(this),this._mousemoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mousemoveHandler);const t=document.getElementById("btnReview");t&&(t.disabled=ue.size()===0,t.onclick=()=>f("changeScreen","reviewStage"));const s=en(),n=document.createElement("label");n.innerHTML=`
      <input type="checkbox" id="cbMode">
      <span></span>
    `,s.appendChild(n),this.cbToggle=n;const i=document.createElement("label");i.innerHTML=`
      <input type="checkbox" id="bigFont">
      <span>文字サイズ +20%</span>
    `,s.appendChild(i),this.fontToggle=i,this.selectedStage=null},updateStageList(){if(this.selectedStage=null,this.stages=r.currentGrade===0?W:W.filter(l=>l.grade===r.currentGrade),r.currentGrade===0){this.stageButtons=[];return}const e=this.stages.length,t=80,s=this.canvas.width/2;let n,i,a;e>7?(n=40,i=8,a=16):(n=50,i=15,a=20);const o=s-60;this.stageButtons=this.stages.map((l,c)=>({id:l.stageId,text:l.name,x:30,y:t+c*(n+i),width:o,height:n,fontSize:a,stage:l}))},isStageCleared(e){var n;const t=localStorage.getItem(`clear_${e}`),s=r.stageProgress&&((n=r.stageProgress[e])==null?void 0:n.cleared);return t||s},getNextStage(){for(const e of this.stages)if(!this.isStageCleared(e.stageId))return e;return null},selectReviewStage(){const e=W.filter(s=>!this.isStageCleared(s.stageId));if(e.length>0)return e.sort((s,n)=>s.grade-n.grade),e[0];if(ue.size()>0){const s=Array.from(ue.getAll());for(const n of W)if(n.kanjiPoolIdList&&n.kanjiPoolIdList.some(i=>s.includes(i)))return n}const t=Math.floor(Math.random()*W.length);return W[t]},startCrossfade(e,t){const s=e===0?"stageSelect0":`stageSelect${e}`,n=t===0?"stageSelect0":`stageSelect${t}`;this.crossfadeState.active=!0,this.crossfadeState.timer=0,this.crossfadeState.oldImage=v[s]||v.stageSelect0,this.crossfadeState.newImage=v[n]||v.stageSelect0,this.crossfadeState.oldGrade=e,this.crossfadeState.newGrade=t},handleMouseMove(e){const t=this.canvas.getBoundingClientRect(),s=this.canvas.width/t.width,n=this.canvas.height/t.height;if(this.mouseX=(e.clientX-t.left)*s,this.mouseY=(e.clientY-t.top)*n,this.hoveredStage=null,r.currentGrade!==0){if(this.stageButtons){for(const i of this.stageButtons)if(C(this.mouseX,this.mouseY,i)){this.hoveredStage=i.stage;return}}if(r.currentGrade!==0)for(const i of this.stages){const{x:a,y:o}=i.pos;if(this.mouseX>=a&&this.mouseX<=a+oe&&this.mouseY>=o&&this.mouseY<=o+oe){this.hoveredStage=i;return}}}},drawTooltip(e){if(!e)return;const t=this.ctx,s=this.mouseX+20,n=this.mouseY-80,i=200,a=90;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(s,n,i,a),t.strokeStyle="#fff",t.lineWidth=2,t.strokeRect(s,n,i,a),t.fillStyle="#fff",t.font="14px sans-serif",t.textAlign="left",t.textBaseline="top";let o=10;t.fillText(`ステージ: ${e.name}`,s+10,n+o),o+=20,e.recommendedLevel&&(t.fillText(`推奨Lv: ${e.recommendedLevel}`,s+10,n+o),o+=20),t.fillText(`地方: ${e.region}`,s+10,n+o),o+=20;const l=this.isStageCleared(e.stageId);t.fillStyle=l?"#4CAF50":"#FFC107",t.fillText(l?"クリア済み":"未クリア",s+10,n+o)},drawReviewStats(e){this.drawPanelBackground(e,50,320,300,120,"paper");const a=W.length,o=W.filter(p=>this.isStageCleared(p.stageId)).length,l=Math.round(o/a*100),c=ue.size();e.fillStyle="#333",e.font='16px "UDデジタル教科書体", sans-serif',e.textAlign="left",e.textBaseline="top";let h=15;e.fillText("📊 学習状況",65,320+h),h+=25,e.font='14px "UDデジタル教科書体", sans-serif',e.fillText(`ステージクリア率: ${l}% (${o}/${a})`,65,320+h),h+=20,e.fillText(`復習待ち漢字: ${c}個`,65,320+h),h+=20;const g=65,d=320+h,m=270,y=10;e.fillStyle="#ddd",e.fillRect(g,d,m,y),e.fillStyle="#4CAF50",e.fillRect(g,d,m*(l/100),y),e.strokeStyle="#999",e.lineWidth=1,e.strokeRect(g,d,m,y)},drawRichButton(e,t,s,n,i,a,o="#2980b9",l=!1){e.save();const c=l?1.05:1,h=l?this.lightenColor(o,15):o;if(l){const k=t+n/2,w=s+i/2,E=n*c,b=i*c;t=k-E/2,s=w-b/2,n=E,i=b}const g=l?4:3,d=l?.4:.3;e.fillStyle=`rgba(0, 0, 0, ${d})`,e.fillRect(t+g,s+g,n,i);const m=e.createLinearGradient(t,s,t,s+i);m.addColorStop(0,this.lightenColor(h,20)),m.addColorStop(1,this.darkenColor(h,20)),e.fillStyle=m,e.fillRect(t,s,n,i),e.strokeStyle=this.darkenColor(h,30),e.lineWidth=l?3:2,e.strokeRect(t,s,n,i);const y=e.createLinearGradient(t,s,t,s+i*.3),p=l?.4:.3;y.addColorStop(0,`rgba(255, 255, 255, ${p})`),y.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=y,e.fillRect(t,s,n,i*.3),l&&(e.strokeStyle="rgba(255, 255, 255, 0.6)",e.lineWidth=1,e.strokeRect(t+1,s+1,n-2,i-2)),e.fillStyle="white",e.font='18px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.textBaseline="middle",e.fillText(a,t+n/2,s+i/2),e.restore()},drawPanelBackground(e,t,s,n,i,a="default"){e.save();let o="rgba(0, 0, 0, 0.7)";if(a==="stone"?o="rgba(50, 50, 60, 0.8)":a==="paper"&&(o="rgba(245, 235, 215, 0.9)"),e.fillStyle=o,e.fillRect(t,s,n,i),e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=2,e.strokeRect(t,s,n,i),a==="stone"){e.strokeStyle="rgba(255, 255, 255, 0.2)",e.lineWidth=1;for(let l=1;l<3;l++)e.beginPath(),e.moveTo(t,s+i*l/3),e.lineTo(t+n,s+i*l/3),e.stroke()}e.restore()},lightenColor(e,t){const s=parseInt(e.replace("#",""),16),n=Math.round(2.55*t),i=(s>>16)+n,a=(s>>8&255)+n,o=(s&255)+n;return"#"+(16777216+(i<255?i<1?0:i:255)*65536+(a<255?a<1?0:a:255)*256+(o<255?o<1?0:o:255)).toString(16).slice(1)},darkenColor(e,t){const s=parseInt(e.replace("#",""),16),n=Math.round(2.55*t),i=(s>>16)-n,a=(s>>8&255)-n,o=(s&255)-n;return"#"+(16777216+(i>255?255:i<0?0:i)*65536+(a>255?255:a<0?0:a)*256+(o>255?255:o<0?0:o)).toString(16).slice(1)},update(e){const{ctx:t,canvas:s,stages:n}=this,i=s.width,a=s.height;t.clearRect(0,0,i,a),this.animationTime+=e||16,this.crossfadeState.active&&(this.crossfadeState.timer++,this.crossfadeState.timer>=this.crossfadeState.duration&&(this.crossfadeState.active=!1));const o=i/2;if(this.crossfadeState.active){const p=this.crossfadeState.timer/this.crossfadeState.duration,k=1-p,w=p;this.crossfadeState.oldImage&&(t.save(),t.globalAlpha=k,t.drawImage(this.crossfadeState.oldImage,o,0,i/2,a),t.restore()),this.crossfadeState.newImage&&(t.save(),t.globalAlpha=w,t.drawImage(this.crossfadeState.newImage,o,0,i/2,a),t.restore())}else{const p=r.currentGrade??0,k=p===0?"stageSelect0":`stageSelect${p}`,w=v[k]||v.stageSelect0;w&&t.drawImage(w,o,0,i/2,a)}const l=10,c=60,h=i/2-20,g=a-140;this.drawPanelBackground(t,l,c,h,g,"stone");const d=ze.length,m=i/d,y=50;if(t.textAlign="center",t.textBaseline="middle",t.font="16px sans-serif",ze.forEach((p,k)=>{const w=k*m;t.fillStyle=p.grade===r.currentGrade?"#ddd":"#ccc",t.fillRect(w,0,m,y),t.fillStyle="#000",t.fillText(p.label,w+m/2,y/2)}),r.currentGrade===0){t.fillStyle="white",t.font='24px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="top",t.fillText("総復習モード",l+h/2,c+20),t.font='14px "UDデジタル教科書体", sans-serif',t.fillStyle="#ccc",t.fillText("あなたに最適なステージを自動選択します",l+h/2,c+55);const p=this.reviewChallengeButton,k=C(this.mouseX,this.mouseY,p),w=Math.sin(this.animationTime*.003)*.2+.8,E=`hsl(${120+Math.sin(this.animationTime*.002)*30}, 70%, ${50+w*10}%)`;this.drawRichButton(t,p.x,p.y,p.width,p.height,p.text,E,k),t.fillStyle="white",t.font="24px sans-serif",t.textAlign="center",t.fillText("🎯",p.x+30,p.y+p.height/2),this.drawReviewStats(t)}else this.stageButtons&&this.stageButtons.forEach(p=>{const k=p.stage,w=this.isStageCleared(k.stageId),E=this.hoveredStage&&this.hoveredStage.stageId===k.stageId;let b="#2980b9";w&&(b="#27ae60");const T=this.selectedStage&&this.selectedStage.stageId===k.stageId;T&&(b="#FF8C00"),this.drawRichButton(t,p.x,p.y,p.width,p.height,p.text,b,E),t.textAlign="left",t.textBaseline="top",t.font="12px sans-serif",T&&(t.fillStyle="#FFFFFF",t.font="16px sans-serif",t.fillText("✓",p.x+10,p.y+5)),w&&(t.fillStyle="#FFD700",t.font="16px sans-serif",t.fillText("⭐",p.x+p.width-25,p.y+5)),k.recommendedLevel&&(t.fillStyle="#fff",t.font="10px sans-serif",t.fillText(`推奨Lv.${k.recommendedLevel}`,p.x+5,p.y+p.height-15))}),r.currentGrade!==0&&(this.getNextStage(),n.forEach(p=>{const{x:k,y:w}=p.pos,E=this.isStageCleared(p.stageId),b=this.selectedStage&&this.selectedStage.stageId===p.stageId;let T=v.markerPref,A=1,G=1;if(b){const F=Math.sin(this.animationTime*.01)*.5+.5;A=1+F*.3,G=.8+F*.2,t.save(),t.globalAlpha=G,t.filter="hue-rotate(120deg) saturate(2) brightness(1.3)"}else E?(T=v.markerCleared||v.markerPref,t.save(),t.globalAlpha=1,t.filter="hue-rotate(45deg) saturate(1.5) brightness(1.2)"):(t.save(),t.globalAlpha=.7);if(T){const F=oe*A,$=(F-oe)/2,I=(F-oe)/2;t.drawImage(T,k-$,w-I,F,F)}else{t.fillStyle=E?"#FFD700":"#f00";const F=oe*A,$=(F-oe)/2,I=(F-oe)/2;t.fillRect(k-$,w-I,F,F)}t.restore()}));this._drawFooterBar(t,i,a),r.currentGrade!==0&&this.drawTooltip(this.hoveredStage)},_drawFooterBar(e,t,s){const n=Xe-10,i=j.y-10,a=Ut+20,o=j.height+20;e.fillStyle="rgba(0, 0, 0, 0.6)",e.fillRect(n,i,a,o),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=1,e.strokeRect(n,i,a,o);const l=15,c=e.createLinearGradient(n,i,n,i+l);c.addColorStop(0,"rgba(255, 255, 255, 0.2)"),c.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=c,e.fillRect(n,i,a,l);const h=C(this.mouseX,this.mouseY,rt),g=C(this.mouseX,this.mouseY,ct),d=C(this.mouseX,this.mouseY,ht),m=C(this.mouseX,this.mouseY,dt);this._drawRichFooterButton(e,rt,"#808080",h),this._drawRichFooterButton(e,ct,"#2980b9",g),this._drawRichFooterButton(e,ht,"#2980b9",d),this._drawRichFooterButton(e,dt,"#2980b9",m)},_drawRichFooterButton(e,t,s,n){e.save();const i=n?1.02:1,a=n?this.lightenColor(s,15):s;let{x:o,y:l,width:c,height:h}=t;if(n){const w=o+c/2,E=l+h/2,b=c*i,T=h*i;o=w-b/2,l=E-T/2,c=b,h=T}const g=n?3:2,d=n?.4:.3;e.fillStyle=`rgba(0, 0, 0, ${d})`,e.fillRect(o+g,l+g,c,h);const m=e.createLinearGradient(o,l,o,l+h);m.addColorStop(0,this.lightenColor(a,20)),m.addColorStop(1,this.darkenColor(a,20)),e.fillStyle=m,e.fillRect(o,l,c,h),e.strokeStyle=this.darkenColor(a,30),e.lineWidth=n?2:1,e.strokeRect(o,l,c,h);const y=e.createLinearGradient(o,l,o,l+h*.3),p=n?.4:.3;y.addColorStop(0,`rgba(255, 255, 255, ${p})`),y.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=y,e.fillRect(o,l,c*.8,h*.3),n&&(e.strokeStyle="rgba(255, 255, 255, 0.6)",e.lineWidth=1,e.strokeRect(o+1,l+1,c-2,h-2)),e.fillStyle="white",e.textAlign="center",e.textBaseline="middle",t.icon&&(e.font="16px sans-serif",e.fillText(t.icon,o+c*.25,l+h/2)),e.font='14px "UDデジタル教科書体", sans-serif';const k=t.icon?o+c*.65:o+c/2;e.fillText(t.text,k,l+h/2),e.restore()},exit(){this.unregisterHandlers();const e=document.getElementById("bgmVolumeSlider");e&&e.remove();const t=document.getElementById("seVolumeSlider");t&&t.remove(),this.cbToggle&&(this.cbToggle.remove(),this.cbToggle=null),this.fontToggle&&(this.fontToggle.remove(),this.fontToggle=null),this.canvas=null,this.ctx=null,this.backButton=null,this.resetButton=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this._mousemoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mousemoveHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler),this.canvas.removeEventListener("mousemove",this._mousemoveHandler)},handleClick(e){e.preventDefault();let t,s;e.changedTouches?(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY):(t=e.clientX,s=e.clientY);const n=this.canvas.getBoundingClientRect(),i=this.canvas.width/n.width,a=this.canvas.height/n.height,o=(t-n.left)*i,l=(s-n.top)*a,c=ze.length,h=this.canvas.width/c;if(l>=0&&l<=50){const d=Math.floor(o/h),m=ze[d];if(m){const y=r.currentGrade;r.currentGrade=m.grade,this.startCrossfade(y,m.grade),this.updateStageList(),f("playSE","decide")}return}if(r.currentGrade===0){const d=this.reviewChallengeButton;if(C(o,l,d)){const m=this.selectReviewStage();m&&(r.currentStageId=m.stageId,Ie(m.stageId),f("playSE","decide"),f("changeScreen","stageLoading"));return}}else{if(this.stageButtons){for(const d of this.stageButtons)if(C(o,l,d)){f("playSE","decide"),this.selectedStage&&this.selectedStage.stageId===d.stage.stageId?(r.currentStageId=d.id,Ie(d.id),f("changeScreen","stageLoading")):this.selectedStage=d.stage;return}}if(r.currentGrade!==0)for(const d of this.stages){const{x:m,y}=d.pos;if(o>=m&&o<=m+oe&&l>=y&&l<=y+oe){f("playSE","decide"),this.selectedStage&&this.selectedStage.stageId===d.stageId?(r.currentStageId=d.stageId,Ie(d.stageId),f("changeScreen","stageLoading")):this.selectedStage=d;return}}}if(C(o,l,rt)){f("playSE","decide"),f("changeScreen","regionSelect");return}if(C(o,l,ct)){f("playSE","decide"),f("changeScreen","reviewStage");return}if(C(o,l,ht)){f("playSE","decide"),f("changeScreen","kanjiDex");return}if(C(o,l,dt)){f("playSE","decide"),f("changeScreen","monsterDex");return}},render(){this.update(0)}};Kt.render=function(){this.update(0)};const tn={enter(e){f("playBGM","title"),this.canvas=e||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const t=this.canvas.width/2;this.animationTime=0,this.logoFloatSpeed=.02,this.logoFloatAmplitude=8,this.particleTime=0,r.playerName&&r.playerName.trim()!==""?(this.jikkuriButton={x:t-150,y:320,width:300,height:50,text:"つづきから（じっくり）"},this.challengeButton={x:t-150,y:380,width:300,height:50,text:"つづきから（チャレンジ）"},this.settingsButton={x:t-80,y:450,width:160,height:50,text:"せってい"},this.resetButton={x:t-90,y:520,width:180,height:35,text:"はじめから"}):(this.jikkuriButton={x:t-150,y:350,width:300,height:50,text:"じっくりモードで はじめる"},this.challengeButton={x:t-150,y:420,width:300,height:50,text:"チャレンジモードで はじめる"},this.resetButton=null,this.settingsButton={x:t-80,y:490,width:160,height:50,text:"せってい"}),this.registerHandlers()},update(e){this.animationTime+=e||16,this.particleTime+=e||16;const t=this.canvas.width,s=this.canvas.height,n=this.ctx;n.clearRect(0,0,t,s),this._drawFantasyBackground(n,t,s),this._drawAnimatedLogo(n,t,s),r.playerName&&r.playerName.trim()!==""&&this._drawWelcomeMessage(n,t,s),this._drawFantasyButtons(n),this._drawCopyright(n,t,s)},_drawFantasyBackground(e,t,s){const n=e.createLinearGradient(0,0,t,s);n.addColorStop(0,"#2c1810"),n.addColorStop(.25,"#3d2414"),n.addColorStop(.5,"#2c1810"),n.addColorStop(.75,"#3d2414"),n.addColorStop(1,"#2c1810"),e.fillStyle=n,e.fillRect(0,0,t,s);const i=e.createRadialGradient(t*.3,s*.2,0,t*.3,s*.2,t*.4);i.addColorStop(0,"rgba(222, 184, 135, 0.15)"),i.addColorStop(1,"transparent"),e.fillStyle=i,e.fillRect(0,0,t,s);const a=e.createRadialGradient(t*.7,s*.8,0,t*.7,s*.8,t*.5);a.addColorStop(0,"rgba(205, 133, 63, 0.1)"),a.addColorStop(1,"transparent"),e.fillStyle=a,e.fillRect(0,0,t,s),this._drawPaperTexture(e,t,s),this._drawMagicParticles(e,t,s)},_drawPaperTexture(e,t,s){e.save(),e.globalAlpha=.1,e.strokeStyle="rgba(222, 184, 135, 0.3)",e.lineWidth=.5;for(let n=0;n<50;n++){e.beginPath();const i=Math.random()*t,a=Math.random()*s,o=i+(Math.random()-.5)*100,l=a+(Math.random()-.5)*100;e.moveTo(i,a),e.lineTo(o,l),e.stroke()}e.strokeStyle="rgba(139, 69, 19, 0.05)";for(let n=0;n<t+s;n+=6)e.beginPath(),e.moveTo(n,0),e.lineTo(n-s,s),e.stroke(),e.beginPath(),e.moveTo(0,n),e.lineTo(t,n-t),e.stroke();e.restore()},_drawMagicParticles(e,t,s){e.save();for(let n=0;n<20;n++){const i=t*.2+Math.sin(this.particleTime*.001+n)*t*.6,a=s*.3+Math.cos(this.particleTime*8e-4+n*.5)*s*.4,o=2+Math.sin(this.particleTime*.002+n)*1,l=.3+Math.sin(this.particleTime*.003+n)*.2;e.globalAlpha=l;const c=e.createRadialGradient(i,a,0,i,a,o*3);c.addColorStop(0,"rgba(255, 215, 0, 0.8)"),c.addColorStop(.5,"rgba(255, 165, 0, 0.4)"),c.addColorStop(1,"transparent"),e.fillStyle=c,e.beginPath(),e.arc(i,a,o*3,0,Math.PI*2),e.fill()}e.restore()},_drawAnimatedLogo(e,t,s){if(v.logo){const{width:n,height:i}=v.logo;let a=t*.6,o=t*.6/n*i;o>s*.25&&(o=s*.25,a=s*.25/i*n);const l=Math.sin(this.animationTime*this.logoFloatSpeed)*this.logoFloatAmplitude,c=(t-a)/2,h=s*.2-o/2+l;this._drawLogoPedestal(e,c-20,h+o-10,a+40,30),e.save(),e.shadowColor="rgba(255, 215, 0, 0.4)",e.shadowBlur=15,e.shadowOffsetX=0,e.shadowOffsetY=5,e.drawImage(v.logo,c,h,a,o),e.restore()}},_drawLogoPedestal(e,t,s,n,i){e.save();const a=e.createLinearGradient(t,s,t,s+i);a.addColorStop(0,"#8B7355"),a.addColorStop(.3,"#A0522D"),a.addColorStop(.7,"#8B4513"),a.addColorStop(1,"#654321"),e.fillStyle=a,e.fillRect(t,s,n,i),e.strokeStyle="#D2B48C",e.lineWidth=2,e.strokeRect(t,s,n,i),e.strokeStyle="rgba(245, 222, 179, 0.5)",e.lineWidth=1,e.strokeRect(t+2,s+2,n-4,i-4),e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(t+5,s+i,n,8),e.restore()},_drawWelcomeMessage(e,t,s){const n=`ようこそ、${r.playerName}さん！`,i=t/2-200,a=s*.4-20;this._drawScroll(e,i,a,400,40),e.save(),e.fillStyle="#2F1B14",e.font='24px "UDデジタル教科書体", serif',e.textAlign="center",e.textBaseline="middle",e.fillText(n,t/2,s*.4),e.restore()},_drawScroll(e,t,s,n,i){e.save();const a=e.createLinearGradient(t,s,t,s+i);a.addColorStop(0,"#F5DEB3"),a.addColorStop(.5,"#DEB887"),a.addColorStop(1,"#D2B48C"),e.fillStyle=a,e.fillRect(t,s,n,i),e.fillStyle="#8B4513",e.fillRect(t-10,s-5,20,i+10),e.fillRect(t+n-10,s-5,20,i+10),e.strokeStyle="#8B4513",e.lineWidth=2,e.strokeRect(t,s,n,i),e.restore()},_drawFantasyButtons(e){this._drawStyledButton(e,this.jikkuriButton,"primary"),this._drawStyledButton(e,this.challengeButton,"primary"),this._drawStyledButton(e,this.settingsButton,"secondary"),this.resetButton&&(this._drawStyledButton(e,this.resetButton,"danger"),e.save(),e.font='10px "UDデジタル教科書体", sans-serif',e.fillStyle="#CD853F",e.textAlign="center",e.fillText("※データがリセットされます",this.resetButton.x+this.resetButton.width/2,this.resetButton.y+this.resetButton.height+15),e.restore())},_drawStyledButton(e,t,s="primary"){e.save();const{x:n,y:i,width:a,height:o,text:l}=t;let c,h,g;switch(s){case"primary":c=["#CD853F","#8B4513"],h="#D2B48C",g="#FFFFFF";break;case"secondary":c=["#D2B48C","#CD853F"],h="#8B4513",g="#FFFFFF";break;case"danger":c=["#e74c3c","#c0392b"],h="#a93226",g="#FFFFFF";break}e.fillStyle="rgba(0, 0, 0, 0.4)",e.fillRect(n+4,i+4,a,o);const d=e.createLinearGradient(n,i,n,i+o);d.addColorStop(0,c[0]),d.addColorStop(1,c[1]),e.fillStyle=d,e.fillRect(n,i,a,o),e.strokeStyle=h,e.lineWidth=2,e.strokeRect(n,i,a,o),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=1,e.strokeRect(n+2,i+2,a-4,o-4),e.fillStyle=g,e.font='16px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.textBaseline="middle",e.save(),e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillText(l,n+a/2+1,i+o/2+1),e.restore(),e.fillStyle=g,e.fillText(l,n+a/2,i+o/2),e.restore()},_drawCopyright(e,t,s){e.save(),e.font='12px "UDデジタル教科書体", sans-serif',e.fillStyle="#8B7355",e.textAlign="center",e.fillText("© あなたの名前 2025",t/2,s-30),e.restore()},exit(){this.unregisterHandlers(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)},_startGame(e){if(!r.playerName){r.pendingGameMode=e,f("changeScreen","playerNameInput");return}r.gameMode=e,r.currentGrade=0,f("changeScreen","courseSelect")},async _resetGameData(){try{if(!confirm(`【最終確認】レベル、図鑑、ステージの進捗など、全てのセーブデータが完全に削除されます。
この操作は取り消せません。よろしいですか？`)){console.log("データリセット操作がキャンセルされました（第1段階）");return}const t=prompt(`最終確認として、以下の文字を正確に入力してください：

「リセット」

※ひらがな・カタカナは区別されます`);if(t!=="リセット"){t===null?console.log("データリセット操作がキャンセルされました（第2段階）"):(alert("入力された文字が正しくありません。データリセットを中止します。"),console.log("データリセット操作が中止されました（確認ワード不一致）"));return}console.log("データリセット処理を開始します...");try{Ss();const s=tt();s!=null&&s.uid,console.log("データリセット処理が完了しました"),alert(`全てのデータが正常にリセットされました。
タイトル画面をリロードします。`),window.location.reload()}catch(s){console.error("データリセット処理中にエラーが発生しました:",s),alert(`データのリセット中にエラーが発生しました。
一部のデータが削除されていない可能性があります。`)}}catch(e){console.error("データリセット処理でエラーが発生しました:",e),alert("データのリセットに失敗しました。")}},handleClick(e){e.preventDefault();let t,s;e.changedTouches?(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY):(t=e.clientX,s=e.clientY);const n=this.canvas.getBoundingClientRect(),i=this.canvas.width/n.width,a=this.canvas.height/n.height,o=(t-n.left)*i,l=(s-n.top)*a;if(C(o,l,this.jikkuriButton)){f("playSE","decide"),this._startGame("jikkuri");return}if(C(o,l,this.challengeButton)){f("playSE","decide"),this._startGame("challenge");return}if(this.resetButton&&C(o,l,this.resetButton)){f("playSE","decide"),this._resetGameData();return}C(o,l,this.settingsButton)&&(f("playSE","decide"),f("changeScreen","settings"))},render(){this.update(0)}},sn={canvas:null,ctx:null,startButton:null,statusButton:null,achievementsButton:null,settingsButton:null,_clickHandler:null,enter(e){this.canvas=e&&typeof e.getContext=="function"?e:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const t=this.canvas.width/2;this.startButton={x:t-150,y:200,width:300,height:60,text:"冒険を始める"},this.statusButton={x:t-100,y:280,width:200,height:50,text:"ステータス"},this.achievementsButton={x:t-100,y:340,width:200,height:50,text:"トロフィー"},this.settingsButton={x:t-100,y:400,width:200,height:50,text:"設定"},this.registerHandlers()},update(e){const{ctx:t,canvas:s,startButton:n,statusButton:i,achievementsButton:a,settingsButton:o}=this;t.clearRect(0,0,s.width,s.height),t.fillStyle="black",t.fillRect(0,0,s.width,s.height),t.fillStyle="white",t.font='40px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.fillText("メインメニュー",s.width/2,100),r.playerName&&(t.font='20px "UDデジタル教科書体", sans-serif',t.fillText(`ようこそ、${r.playerName} さん`,s.width/2,150));const l=r.playerStats.skillPoints;i.text=l>0?`ステータス (+${l})`:"ステータス";const c=r.unlockedAchievements.size;c>0?a.text=`トロフィー (${c})`:a.text="トロフィー",v.buttonNormal&&(t.drawImage(v.buttonNormal,n.x,n.y,n.width,n.height),t.drawImage(v.buttonNormal,i.x,i.y,i.width,i.height),t.drawImage(v.buttonNormal,a.x,a.y,a.width,a.height),t.drawImage(v.buttonNormal,o.x,o.y,o.width,o.height)),Z(t,n.x,n.y,n.width,n.height,n.text,"#2ecc71");const h=l>0?"#f39c12":"#9b59b6";Z(t,i.x,i.y,i.width,i.height,i.text,h);const g=c>0?"#FFD700":"#8e44ad";Z(t,a.x,a.y,a.width,a.height,a.text,g),Z(t,o.x,o.y,o.width,o.height,o.text,"#3498db")},exit(){this.unregisterHandlers(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)},handleClick(e){e.preventDefault();let t,s;e.changedTouches?(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY):(t=e.clientX,s=e.clientY);const n=this.canvas.getBoundingClientRect(),i=this.canvas.width/n.width,a=this.canvas.height/n.height,o=(t-n.left)*i,l=(s-n.top)*a;if(C(o,l,this.startButton)){r.currentGrade=0,f("changeScreen","stageSelect");return}if(C(o,l,this.statusButton)){f("changeScreen","status");return}if(C(o,l,this.achievementsButton)){f("changeScreen","achievements");return}if(C(o,l,this.settingsButton)){f("changeScreen","settings");return}}},nn={canvas:null,ctx:null,_clickHandler:null,enter(e){this.canvas=e&&typeof e.getContext=="function"?e:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const t=document.getElementById("uiOverlay")||document.body;this.cleanupDOM(),this.createSettingsContainer(t),this.registerHandlers()},createSettingsContainer(e){const t=document.createElement("div");t.id="settingsContainer",t.className="settings-container";const s=document.createElement("h2");s.textContent="設定",s.className="settings-title",t.appendChild(s);const n=this.createAudioPanel();t.appendChild(n);const i=this.createDisplayPanel();t.appendChild(i);const a=this.createButtonSection();t.appendChild(a),e.appendChild(t)},createButtonSection(){const e=document.createElement("div");e.className="settings-button-section";const t=document.createElement("button");t.className="settings-button danger",t.textContent="データリセット（はじめから）",t.addEventListener("click",()=>{f("playSE","decide"),this.resetData()});const s=document.createElement("button");return s.className="settings-button primary",s.textContent="メインメニューへもどる",s.addEventListener("click",()=>{f("playSE","decide"),f("changeScreen","title")}),e.appendChild(t),e.appendChild(s),e},createAudioPanel(){const e=document.createElement("div");e.className="settings-panel";const t=document.createElement("h3");t.className="panel-title",t.textContent="オーディオ設定",e.appendChild(t);const s=document.createElement("div");s.className="setting-group";const n=document.createElement("label");n.className="setting-label",n.textContent="BGM音量";const i=document.createElement("input");i.type="range",i.id="bgmVolumeSlider",i.className="volume-slider",i.min="0",i.max="1",i.step="0.01",i.value="0.7";const a=document.createElement("span");a.className="volume-value",a.textContent="70%",s.appendChild(n),s.appendChild(i),s.appendChild(a),e.appendChild(s);const o=document.createElement("div");o.className="setting-group";const l=document.createElement("label");l.className="setting-label",l.textContent="SE音量";const c=document.createElement("input");c.type="range",c.id="seVolumeSlider",c.className="volume-slider",c.min="0",c.max="1",c.step="0.01",c.value="0.7";const h=document.createElement("span");return h.className="volume-value",h.textContent="70%",o.appendChild(l),o.appendChild(c),o.appendChild(h),e.appendChild(o),this.setupAudioEvents(i,a,c,h),e},createDisplayPanel(){const e=document.createElement("div");e.className="settings-panel";const t=document.createElement("h3");t.className="panel-title",t.textContent="表示・アクセシビリティ",e.appendChild(t);const s=this._createAccessibilityToggleWithTooltip("cbMode","色弱フレンドリーモード","赤と緑の区別がつきやすい配色に変更します。色覚に配慮したカラーパレットを使用し、より快適にゲームをお楽しみいただけます。");e.appendChild(s);const n=this._createAccessibilityToggleWithTooltip("bigFont","文字サイズ +20%","ゲーム内の全ての文字を20%大きく表示します。小さな文字が見づらい場合や、より読みやすい表示をお求めの方におすすめです。");return e.appendChild(n),this.setupAccessibilityEvents(),e},_createAccessibilityToggleWithTooltip(e,t,s){const n=document.createElement("div");n.className="setting-group";const i=document.createElement("label");i.className="toggle-switch";const a=document.createElement("div");a.className="toggle-label-container";const o=document.createElement("span");o.className="toggle-label",o.textContent=t;const l=document.createElement("span");return l.className="tooltip-trigger",l.textContent="？",l.setAttribute("data-tooltip",s),a.appendChild(o),a.appendChild(l),i.innerHTML=`
        <input type="checkbox" id="${e}">
        <span class="slider"></span>
      `,i.appendChild(a),this._setupTooltipEvents(l,s),n.appendChild(i),n},_setupTooltipEvents(e,t){let s=null;e.addEventListener("mouseover",n=>{this._removeActiveTooltip(),s=document.createElement("div"),s.className="settings-tooltip",s.textContent=t;const i=e.getBoundingClientRect();s.style.left=i.left+"px",s.style.top=i.bottom+5+"px",document.body.appendChild(s),setTimeout(()=>{s&&s.classList.add("show")},10)}),e.addEventListener("mouseout",()=>{this._removeActiveTooltip(),s=null}),e.addEventListener("click",n=>{n.preventDefault(),this._removeActiveTooltip()})},_removeActiveTooltip(){document.querySelectorAll(".settings-tooltip").forEach(t=>{t.remove()})},setupAudioEvents(e,t,s,n){f("getBGMVolume",i=>{e.value=i,t.textContent=Math.round(i*100)+"%"}),e.addEventListener("input",i=>{const a=parseFloat(i.target.value);t.textContent=Math.round(a*100)+"%",f("setBGMVolume",a)}),e.addEventListener("change",i=>{f("playSE","decide"),console.log("BGM音量設定完了:",parseFloat(i.target.value))}),f("getSEVolume",i=>{s.value=i,n.textContent=Math.round(i*100)+"%"}),s.addEventListener("input",i=>{const a=parseFloat(i.target.value);n.textContent=Math.round(a*100)+"%",f("setSEVolume",a),f("playSE","decide")}),s.addEventListener("change",i=>{console.log("SE音量設定完了:",parseFloat(i.target.value))})},setupAccessibilityEvents(){const e=()=>{const t=document.getElementById("cbMode"),s=document.getElementById("bigFont");t&&localStorage.setItem("cbMode",t.checked?"1":"0"),s&&localStorage.setItem("bigFont",s.checked?"1":"0"),this.applyAccessibility(),f("playSE","decide")};setTimeout(()=>{const t=document.getElementById("cbMode"),s=document.getElementById("bigFont");t&&(t.checked=localStorage.getItem("cbMode")==="1",t.addEventListener("change",e)),s&&(s.checked=localStorage.getItem("bigFont")==="1",s.addEventListener("change",e)),this.applyAccessibility()},100)},applyAccessibility(){document.body.classList.toggle("cb-mode",localStorage.getItem("cbMode")==="1"),document.body.classList.toggle("big-font",localStorage.getItem("bigFont")==="1")},cleanupDOM(){const e=document.getElementById("settingsContainer");e&&e.remove()},update(e){const{ctx:t,canvas:s}=this;Ds(t,s.width,s.height)},exit(){this.unregisterHandlers(),this.cleanupDOM(),this._removeActiveTooltip(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler)},unregisterHandlers(){this.canvas&&this._clickHandler&&(this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler))},handleClick(e){e.preventDefault()},exit(){this.unregisterHandlers(),this.cleanupDOM(),this._removeActiveTooltip(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler)},unregisterHandlers(){this.canvas&&this._clickHandler&&(this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler))},handleClick(e){e.preventDefault()},createButtonSection(){const e=document.createElement("div");e.className="settings-button-section";const t=document.createElement("div");t.style.position="relative",t.style.display="flex",t.style.alignItems="center",t.style.gap="10px";const s=document.createElement("button");s.className="settings-button danger",s.textContent="データリセット（はじめから）",s.addEventListener("click",()=>{f("playSE","decide"),this.resetData()});const n=document.createElement("span");n.className="tooltip-trigger",n.textContent="？",n.style.flexShrink="0",t.appendChild(s),t.appendChild(n),this._setupTooltipEvents(n,"全てのセーブデータが削除され、元に戻せなくなります。レベル、図鑑、ステージ進捗、設定など、ゲームの全ての記録が完全に消去されます。");const i=document.createElement("button");return i.className="settings-button primary",i.textContent="メインメニューへもどる",i.addEventListener("click",()=>{f("playSE","decide"),f("changeScreen","title")}),e.appendChild(t),e.appendChild(i),e},async resetData(){const e=tt();try{if(!confirm(`【最終確認】レベル、図鑑、ステージの進捗など、全てのセーブデータが完全に削除されます。
この操作は取り消せません。よろしいですか？`)){console.log("データリセット操作がキャンセルされました（第1段階）");return}const s=prompt(`最終確認として、以下の文字を正確に入力してください：

「リセット」

※ひらがな・カタカナは区別されます`);if(s!=="リセット"){s===null?console.log("データリセット操作がキャンセルされました（第2段階）"):(alert("入力された文字が正しくありません。データリセットを中止します。"),console.log("データリセット操作が中止されました（確認ワード不一致）"));return}console.log("データリセット処理を開始します...");const n=this._showLoadingMessage("データを削除中...");try{this._clearLocalStorageData(),e!=null&&e.uid&&await this._clearFirebaseUserData(e.uid),this._resetAccessibilitySettings(),this._resetGameState(),this._hideLoadingMessage(n),console.log("データリセット処理が完了しました"),alert(`全てのデータが正常にリセットされました。
タイトル画面に戻ります。`),f("changeScreen","title")}catch(i){console.error("データリセット処理中にエラーが発生しました:",i),this._hideLoadingMessage(n),alert(`データのリセット中にエラーが発生しました。
一部のデータが削除されていない可能性があります。`)}}catch(t){console.error("データリセット処理でエラーが発生しました:",t),alert("データのリセットに失敗しました。")}},_clearLocalStorageData(){const e=[];for(let t=0;t<localStorage.length;t++){const s=localStorage.key(t);s&&(s.startsWith("game_")||s.startsWith("kanji_")||s.startsWith("user_")||s.startsWith("progress_")||s.startsWith("level_")||s.startsWith("dex_")||s.startsWith("battle_")||s.startsWith("achievement_")||s==="bgmVolume"||s==="seVolume"||s==="cbMode"||s==="bigFont"||s==="lastPlayedStage"||s==="playerStats"||s==="unlockedStages")&&e.push(s)}e.forEach(t=>{localStorage.removeItem(t),console.log(`LocalStorage key removed: ${t}`)}),console.log(`LocalStorage cleaned: ${e.length} keys removed`)},async _clearFirebaseUserData(e){return new Promise(async(t,s)=>{try{console.log(`Firebase user data deletion started for UID: ${e}`),f("deleteUserData",e,async n=>{n&&n.success?(console.log("Firebase user data cleared successfully"),t()):(console.error("Failed to clear Firebase user data:",(n==null?void 0:n.error)||"Unknown error"),s(new Error((n==null?void 0:n.error)||"Failed to delete user data")))}),setTimeout(()=>{s(new Error("Firebase data deletion timeout"))},1e4)}catch(n){console.error("Error in _clearFirebaseUserData:",n),s(n)}})},_resetGameState(){typeof r<"u"&&r.reset&&(r.reset(),console.log("GameState has been reset")),f("resetGameState")},_resetAccessibilitySettings(){document.body.classList.remove("cb-mode"),document.body.classList.remove("big-font"),console.log("アクセシビリティ設定がリセットされました")},_showLoadingMessage(e){const t=document.createElement("div");t.id="resetLoadingMessage",t.className="reset-loading-overlay";const s=document.createElement("div");s.className="loading-message-container";const n=document.createElement("div");n.className="loading-spinner";const i=document.createElement("div");return i.className="loading-text",i.textContent=e,s.appendChild(n),s.appendChild(i),t.appendChild(s),document.body.appendChild(t),t},_hideLoadingMessage(e){e&&e.parentNode&&e.parentNode.removeChild(e)},render(){this.update(0)}};function an(e){return String.fromCharCode(e.charCodeAt(0)-96)}function vt(e){return e.trim().replace(/\s+/g,"").replace(/[\u30a1-\u30f6]/g,an)}function on(e){const t=new Set;return e.kunyomi&&e.kunyomi.split(" ").forEach(s=>{s&&t.add(vt(s.trim()))}),e.onyomi&&e.onyomi.split(" ").forEach(s=>{s&&t.add(vt(s.trim()))}),[...t]}const zt={canvas:null,ctx:null,inputEl:null,_keydownHandler:null,_clickHandler:null,kanjiIds:[],currentIndex:0,currentKanji:null,message:"",enter(e){var t;if(this.canvas=e&&typeof e.getContext=="function"?e:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.kanjiIds=ue.popBatch(5).filter(s=>s!=null),this.kanjiIds.length===0){f("changeScreen","stageSelect");return}this.inputEl=document.getElementById("kanjiInput"),this.inputEl&&(this.inputEl.style.display="block",this.inputEl.value=""),this.currentIndex=0,this._loadCurrent(),this._keydownHandler=this._onKeydown.bind(this),(t=this.inputEl)==null||t.addEventListener("keydown",this._keydownHandler),this._clickHandler=s=>{const n=this.canvas.getBoundingClientRect(),i=s.clientX-n.left,a=s.clientY-n.top;i>=20&&i<=120&&a>=20&&a<=50&&(f("playSE","decide"),f("changeScreen","stageSelect"))},this.canvas.addEventListener("click",this._clickHandler)},_loadCurrent(){const e=this.kanjiIds[this.currentIndex++],t=he(e);this.currentKanji={...t,readings:on(t)},this.message=`「${t.kanji}」をよもう！`},_onKeydown(e){if(e.key!=="Enter"||(e.preventDefault(),!this.currentKanji))return;const t=vt(this.inputEl.value);this.currentKanji.readings.includes(t)?(f("playSE","correct"),this.message="正解！",ue.updateReview(this.currentKanji.id,5)):(f("playSE","wrong"),this.message=`不正解…正答: ${this.currentKanji.readings.join("、")}`,ue.updateReview(this.currentKanji.id,1)),setTimeout(()=>{this.currentIndex<this.kanjiIds.length?(this.inputEl.value="",this._loadCurrent()):(this.inputEl.style.display="none",f("changeScreen","stageSelect"))},1e3)},update(e){const{ctx:t,canvas:s}=this;if(!this.currentKanji)return;t.fillStyle="#1e3c72",t.fillRect(0,0,s.width,s.height),t.fillStyle="white",t.font='24px "UDデジタル教科書体",sans-serif',t.fillText("復習モード",20,50),Z(t,20,20,100,30,"ステージ選択");const n=s.width/2,i=s.height/2,a=180,o=180;t.strokeStyle="white",t.lineWidth=2,t.strokeRect(n-a/2,i-o/2,a,o),t.fillStyle="white",t.font="100px serif",t.textAlign="center",t.textBaseline="middle",t.fillText(this.currentKanji.kanji,n,i),t.font='20px "UDデジタル教科書体",sans-serif',t.textBaseline="top",t.fillText(this.message,n,i+o/2+10)},exit(){var e;(e=this.inputEl)==null||e.removeEventListener("keydown",this._keydownHandler),this.inputEl&&(this.inputEl.style.display="none"),this.canvas&&this._clickHandler&&this.canvas.removeEventListener("click",this._clickHandler),this.canvas=this.ctx=this.inputEl=null}};zt.render=function(){this.update(0)};const Vt={canvas:null,ctx:null,dexSet:null,allList:[],scroll:0,selectedKanjiId:null,_clickHandler:null,_keyHandler:null,sortMode:"default",showCollectedOnly:!1,filteredList:[],container:null,cardGrid:null,cardsPerPage:20,enter(e){this.dexSet=St(),this.canvas=e&&typeof e.getContext=="function"?e:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.allList=ne.map(t=>t.id);for(let t=7;t<=10;t++){const s=Re(t);if(s&&s.length>0){const n=s.map(i=>i.id).filter(i=>!this.allList.includes(i));this.allList.push(...n),console.log(`【漢字図鑑】${t}年生相当の漢字を追加: ${n.length}件`)}}this.scroll=0,this.selectedKanjiId=null,this.sortMode="default",this.showCollectedOnly=!1,this.updateFilteredList(),this.createDOMHeader(),this.createDOMContent(),this.renderKanjiCards(),this._keyHandler=t=>{if(this.selectedKanjiId&&t.key==="Escape"){this.selectedKanjiId=null,this.closeModal();return}t.key==="ArrowLeft"||t.key==="PageUp"?this.prevPage():(t.key==="ArrowRight"||t.key==="PageDown")&&this.nextPage()},window.addEventListener("keydown",this._keyHandler)},createDOMHeader(){this.container&&this.container.remove(),this.container=document.createElement("div"),this.container.id="kanjiDexContainer",this.container.className="kanji-dex-container",this.container.style.border="none",this.container.style.outline="none";const e=document.createElement("div");e.className="kanji-collection-stats";const t=document.createElement("div");t.className="kanji-stats-text";const s=Math.round(this.dexSet.size/this.allList.length*100);t.textContent=`漢字収集率: ${this.dexSet.size}/${this.allList.length} (${s}%)`;const n=document.createElement("div");n.className="kanji-progress-bar";const i=document.createElement("div");i.className="kanji-progress-fill",i.style.width=`${s}%`,n.appendChild(i),e.appendChild(t),e.appendChild(n);const a=document.createElement("div");a.className="kanji-dex-navigation",a.style.border="none",a.style.outline="none";const o=document.createElement("div");o.className="nav-controls-left";const l=document.createElement("button");l.textContent="📚 ステージ選択へ",l.addEventListener("click",()=>{f("playSE","decide"),f("changeScreen","stageSelect")}),o.appendChild(l);const c=document.createElement("div");c.className="nav-controls-center";const h=document.createElement("button");h.textContent="📊 学年順",h.className=this.sortMode==="grade"?"sort-active":"",h.addEventListener("click",()=>{this.sortList("grade"),this.updateNavigationButtons(),this.renderKanjiCards(),f("playSE","decide")});const g=document.createElement("button");g.textContent="✏️ 画数順",g.className=this.sortMode==="strokes"?"sort-active":"",g.addEventListener("click",()=>{this.sortList("strokes"),this.updateNavigationButtons(),this.renderKanjiCards(),f("playSE","decide")});const d=document.createElement("button");d.textContent="⭐ 習熟度順",d.className=this.sortMode==="mastery"?"sort-active":"",d.addEventListener("click",()=>{this.sortList("mastery"),this.updateNavigationButtons(),this.renderKanjiCards(),f("playSE","decide")}),c.appendChild(h),c.appendChild(g),c.appendChild(d);const m=document.createElement("div");m.className="nav-controls-right";const y=document.createElement("label");y.className="kanji-toggle-switch";const p=document.createElement("input");p.type="checkbox",p.checked=this.showCollectedOnly,p.addEventListener("change",()=>{this.toggleFilter(),this.updateNavigationButtons(),this.renderKanjiCards(),f("playSE","decide")});const k=document.createElement("span");k.className="slider";const w=document.createElement("span");w.className="toggle-label",w.textContent="収集済のみ",y.appendChild(p),y.appendChild(k),y.appendChild(w);const E=document.createElement("button");E.textContent="⬅️ 前のページ",E.addEventListener("click",()=>{this.prevPage()});const b=document.createElement("span");b.className="page-info";const T=document.createElement("button");T.textContent="次のページ ➡️",T.addEventListener("click",()=>{this.nextPage()}),m.appendChild(y),m.appendChild(E),m.appendChild(b),m.appendChild(T),a.appendChild(o),a.appendChild(c),a.appendChild(m),this.container.appendChild(e),this.container.appendChild(a),document.body.appendChild(this.container),this.updateNavigationButtons()},createDOMContent(){this.cardGrid=document.createElement("div"),this.cardGrid.id="kanjiCardGrid",this.cardGrid.className="kanji-card-grid",this.cardGrid.style.border="none",this.cardGrid.style.outline="none",this.container.appendChild(this.cardGrid)},renderKanjiCards(){this.cardGrid&&(this.cardGrid.innerHTML="");const e=this.scroll,t=Math.min(e+this.cardsPerPage,this.filteredList.length);for(let s=e;s<t;s++){const n=this.filteredList[s],i=he(n),a=this._createKanjiCard(i);this.cardGrid.appendChild(a)}},_createKanjiCard(e){const t=this.dexSet.has(e.id),s=document.createElement("div");s.className="kanji-card",t||s.classList.add("locked"),s.style.border="1px solid #8B4513",s.style.boxShadow="3px 3px 5px rgba(0, 0, 0, 0.3)";const n=document.createElement("h2");n.className="kanji-character",n.textContent=t?e.kanji:"？",s.appendChild(n);const i=document.createElement("div");i.className="kanji-info";const a=document.createElement("p");a.className="kanji-grade";const o=e.grade||"?";if(a.textContent=`${o}年生`,i.appendChild(a),t){const l=document.createElement("p");l.className="kanji-reading";const c=[];e.onyomi&&c.push(`音: ${e.onyomi}`),e.kunyomi&&c.push(`訓: ${e.kunyomi}`),l.textContent=c.join(" "),i.appendChild(l);const h=document.createElement("p");h.className="kanji-strokes",h.textContent=`${e.strokes}画`,i.appendChild(h);const g=document.createElement("div");g.className="kanji-mastery";const d=e.correctCount||0,m=e.incorrectCount||0,y=d+m;if(y>0){const p=d/y,k=Math.round(p*100);let w=1;p>=.9?w=3:p>=.7&&(w=2);for(let b=0;b<w;b++){const T=document.createElement("span");T.className="mastery-star",T.textContent="⭐",g.appendChild(T)}const E=document.createElement("span");E.className="mastery-accuracy",E.textContent=`${k}%`,g.appendChild(E)}else g.textContent="未挑戦";i.appendChild(g)}else{const l=document.createElement("p");l.className="kanji-locked-message",l.textContent="未収集",i.appendChild(l)}return s.appendChild(i),t&&s.addEventListener("click",()=>{this.selectedKanjiId=e.id,this.showModal(e.id),f("playSE","decide")}),s},showModal(e){const t=he(e);if(!t)return;const s=document.createElement("div");s.className="kanji-modal",s.id="kanjiModal";const n=document.createElement("div");n.className="modal-content";const i=document.createElement("button");i.className="modal-close",i.textContent="×",i.addEventListener("click",()=>{this.closeModal()}),n.appendChild(i);const a=document.createElement("h1");a.className="modal-kanji",a.textContent=t.kanji,n.appendChild(a);const o=document.createElement("div");o.className="kanji-detail-info";const l=document.createElement("div");if(l.className="kanji-basic-info",t.onyomi){const b=document.createElement("p");b.innerHTML=`<strong>音読み:</strong> ${t.onyomi}`,l.appendChild(b)}if(t.kunyomi){const b=document.createElement("p");b.innerHTML=`<strong>訓読み:</strong> ${t.kunyomi}`,l.appendChild(b)}if(t.meaning){const b=document.createElement("p");b.innerHTML=`<strong>意味:</strong> ${t.meaning}`,l.appendChild(b)}const c=document.createElement("p");c.innerHTML=`<strong>学年:</strong> ${t.grade||"?"}年 <strong>画数:</strong> ${t.strokes}画`,l.appendChild(c),o.appendChild(l);const h=document.createElement("div");h.className="kanji-stats-section";const g=document.createElement("h3");g.textContent="学習記録",h.appendChild(g);const d=t.correctCount||0,m=t.incorrectCount||0,y=d+m,p=y>0?Math.round(d/y*100):0;let k="初心者",w="#8B4513";p>=90?(k="マスター",w="#DAA520"):p>=70?(k="上級者",w="#CD853F"):p>=50&&(k="中級者",w="#D2B48C");const E=document.createElement("p");if(E.className="mastery-level",E.innerHTML=`<strong>習熟度:</strong> <span style="color:${w}">${k}</span>`,h.appendChild(E),y>0){const b=document.createElement("div");b.className="stats-details";const T=document.createElement("p");T.innerHTML=`<strong>挑戦回数:</strong> ${y}回`,b.appendChild(T);const A=document.createElement("p");A.innerHTML=`<strong>正答率:</strong> ${p}%`,b.appendChild(A);const G=document.createElement("div");G.className="accuracy-graph-container";const F=document.createElement("div");F.className="accuracy-graph";const $=document.createElement("div");$.className="correct-bar",$.style.width=`${p}%`,$.textContent=`正解: ${d}`,F.appendChild($);const I=document.createElement("div");I.className="incorrect-bar",I.style.width=`${100-p}%`,I.textContent=`不正解: ${m}`,F.appendChild(I),G.appendChild(F),b.appendChild(G),h.appendChild(b)}else{const b=document.createElement("p");b.textContent="まだ挑戦記録がありません",h.appendChild(b)}o.appendChild(h),n.appendChild(o),s.appendChild(n),document.body.appendChild(s),s.addEventListener("click",b=>{b.target===s&&this.closeModal()})},closeModal(){const e=document.getElementById("kanjiModal");e&&e.remove(),this.selectedKanjiId=null,f("playSE","cancel")},prevPage(){this.scroll<=0||(this.scroll=Math.max(0,this.scroll-this.cardsPerPage),this.updateNavigationButtons(),this.renderKanjiCards(),f("playSE","decide"))},nextPage(){const e=Math.max(0,this.filteredList.length-this.cardsPerPage);this.scroll>=e||(this.scroll=Math.min(e,this.scroll+this.cardsPerPage),this.updateNavigationButtons(),this.renderKanjiCards(),f("playSE","decide"))},updateNavigationButtons(){var o,l,c;if(!this.container)return;const e=this.container.querySelector(".page-info");if(e){const h=Math.floor(this.scroll/this.cardsPerPage)+1,g=Math.ceil(this.filteredList.length/this.cardsPerPage);e.textContent=`${h} / ${g}`}const t=this.container.querySelector(".nav-controls-right button:first-of-type"),s=this.container.querySelector(".nav-controls-right button:last-of-type");if(t&&(t.disabled=this.scroll<=0),s){const h=Math.max(0,this.filteredList.length-this.cardsPerPage);s.disabled=this.scroll>=h}const n=this.container.querySelectorAll(".nav-controls-center button");n.forEach(h=>h.classList.remove("sort-active")),this.sortMode==="grade"?(o=n[0])==null||o.classList.add("sort-active"):this.sortMode==="strokes"?(l=n[1])==null||l.classList.add("sort-active"):this.sortMode==="mastery"&&((c=n[2])==null||c.classList.add("sort-active"));const i=this.container.querySelector(".kanji-stats-text"),a=this.container.querySelector(".kanji-progress-fill");if(i&&a){const h=Math.round(this.dexSet.size/this.allList.length*100);this.showCollectedOnly?i.textContent=`表示中: ${this.filteredList.length} / 収集済: ${this.dexSet.size} (${h}%)`:i.textContent=`漢字収集率: ${this.dexSet.size}/${this.allList.length} (${h}%)`,a.style.width=`${h}%`}},update(e){const{ctx:t,canvas:s}=this;t.fillStyle="#2c1810",t.fillRect(0,0,s.width,s.height),t.fillStyle="rgba(139, 69, 19, 0.1)";for(let n=0;n<10;n++)for(let i=0;i<10;i++)(n+i)%2===0&&t.fillRect(n*80,i*60,40,30)},exit(){this.container&&(this.container.remove(),this.container=null),this.closeModal(),this._keyHandler&&window.removeEventListener("keydown",this._keyHandler),this.canvas=this.ctx=null,this.selectedKanjiId=null},sortList(e){switch(this.sortMode=e,e){case"grade":this.allList.sort((t,s)=>{const n=he(t),i=he(s),a=n.grade||999,o=i.grade||999;return a-o});break;case"strokes":this.allList.sort((t,s)=>{const n=he(t),i=he(s),a=n.strokes||999,o=i.strokes||999;return a-o});break;case"mastery":this.allList.sort((t,s)=>{const n=he(t),i=he(s),a=n.correctCount||0,o=n.incorrectCount||0,l=a+o,c=l>0?a/l:0,h=i.correctCount||0,g=i.incorrectCount||0,d=h+g;return(d>0?h/d:0)-c});break;default:this.allList=ne.map(t=>t.id);break}this.scroll=0,this.updateFilteredList()},updateFilteredList(){this.showCollectedOnly?this.filteredList=this.allList.filter(e=>this.dexSet.has(e)):this.filteredList=[...this.allList]},toggleFilter(){this.showCollectedOnly=!this.showCollectedOnly,this.scroll=0,this.updateFilteredList()}};Vt.render=function(){this.update(0)};const Qe={1:"grade1-hokkaido",2:"grade2-touhoku",3:"grade3-kantou",4:"grade4-chuubu",5:"grade5-kinki",6:"grade6-chuugoku"},et={1:"北海道",2:"東北",3:"関東",4:"中部",5:"近畿",6:"中国"},Zt=new IntersectionObserver(e=>{e.forEach(t=>{if(t.isIntersecting){const s=t.target.querySelector("img");s.src=s.dataset.thumb,Zt.unobserve(t.target)}})},{rootMargin:"200px"});function ln(e){const t=document.createElement("div");t.classList.add("monster-card"),e.collected||t.classList.add("locked"),t.addEventListener("click",()=>{if(e.collected){rn(e),Xs(e.id);const l=t.querySelector(".new-badge");l&&l.remove()}});const s=document.createElement("img"),i=`/assets/images/monsters/thumb/${Qe[e.grade]||Qe[1]}/${e.id}.webp`;s.dataset.thumb=i,s.alt=e.name,t.appendChild(s);const a=document.createElement("p");a.textContent=e.collected?e.name:"？？？",a.classList.add("monster-name"),t.appendChild(a);const o=document.createElement("p");if(o.textContent=e.collected?e.prefecture||et[e.grade]||"不明":"？？？",o.classList.add("monster-prefecture"),t.appendChild(o),Ys(e.id)){const l=document.createElement("div");l.classList.add("new-badge"),l.textContent="NEW!",t.appendChild(l)}return Zt.observe(t),t}function rn(e){const t=document.createElement("div");t.classList.add("monster-modal");const s=document.createElement("div");s.classList.add("modal-content");const n=document.createElement("button");n.classList.add("modal-close"),n.textContent="×",n.onclick=()=>t.remove();const i=document.createElement("img"),a=Qe[e.grade]||Qe[1];i.src=`/assets/images/monsters/thumb/${a}/${e.id}.webp`,i.alt=e.name,i.classList.add("modal-monster-image");const o=document.createElement("div");o.classList.add("monster-info"),o.innerHTML=`
    <h2>${e.name}</h2>
    <p><strong>学年:</strong> ${e.grade}年生</p>
    <p><strong>地方:</strong> ${et[e.grade]||"不明"}</p>
    <p><strong>生息地:</strong> ${e.prefecture||et[e.grade]||"不明"}</p>
    <p><strong>読み:</strong> ${e.reading||"不明"}</p>
    <p><strong>意味:</strong> ${e.meaning||"詳細情報なし"}</p>
  `,s.appendChild(n),s.appendChild(i),s.appendChild(o),t.appendChild(s),t.onclick=l=>{l.target===t&&t.remove()},document.body.appendChild(t),f("playSE","decide")}const cn={canvas:null,dexSet:null,seenSet:null,allMonsterIds:[],filteredMonsterIds:[],itemsPerPage:15,currentPage:0,totalPages:0,currentRegionFilter:"all",currentSortOrder:"id",enter(e){this.canvas=e||document.getElementById("gameCanvas"),this.canvas.style.display="none",this.dexSet=st(),this.seenSet=bt(),this.allMonsterIds=$t(),this.applyFiltersAndSort(),this.currentPage=0,this.renderPage()},calculateRegionCompletion(){const e={};for(let t=1;t<=6;t++){const s=this.allMonsterIds.filter(i=>{const a=re(i);return a&&a.grade===t}),n=s.filter(i=>this.dexSet.has(i));e[t]={total:s.length,collected:n.length,isComplete:s.length>0&&n.length===s.length}}return e},applyFiltersAndSort(){let e=this.allMonsterIds;this.currentRegionFilter!=="all"&&(e=this.allMonsterIds.filter(t=>{const s=re(t);return s&&s.grade===this.currentRegionFilter})),this.currentSortOrder==="name"?e.sort((t,s)=>{const n=re(t),i=re(s);return!n||!i?0:n.name.localeCompare(i.name,"ja")}):e.sort((t,s)=>t.localeCompare(s)),this.filteredMonsterIds=e,this.totalPages=Math.ceil(this.filteredMonsterIds.length/this.itemsPerPage)},renderPage(){const e=document.getElementById("monsterContainer");if(!e)return;e.innerHTML="",e.style.display="grid";const t=this.calculateRegionCompletion(),s=document.createElement("div");s.className="collection-stats";const n=this.dexSet.size,i=this.allMonsterIds.length,a=i>0?Math.round(n/i*100):0,o=document.createElement("div");o.className="stats-text",o.textContent=`収集率: ${a}% (${n} / ${i})`;const l=document.createElement("div");l.className="progress-bar";const c=document.createElement("div");c.className="progress-fill",c.style.width=`${a}%`,l.appendChild(c),s.appendChild(o),s.appendChild(l),e.appendChild(s);const h=document.createElement("div");h.className="dex-navigation";const g=document.createElement("button");g.textContent="ステージ選択へ",g.onclick=()=>f("changeScreen","stageSelect");const d=document.createElement("select");d.className="region-filter";let m='<option value="all">すべて表示</option>';for(let I=1;I<=6;I++){const N=et[I],Y=t[I].isComplete?" 👑":"";m+=`<option value="${I}">${N}${Y}</option>`}d.innerHTML=m,d.value=this.currentRegionFilter,d.onchange=I=>{this.currentRegionFilter=I.target.value==="all"?"all":parseInt(I.target.value),this.applyFiltersAndSort(),this.currentPage=0,this.renderPage(),f("playSE","decide")};const y=document.createElement("button");y.textContent="図鑑番号順",y.className=this.currentSortOrder==="id"?"sort-active":"",y.onclick=()=>{this.currentSortOrder="id",this.applyFiltersAndSort(),this.currentPage=0,this.renderPage(),f("playSE","decide")};const p=document.createElement("button");p.textContent="五十音順",p.className=this.currentSortOrder==="name"?"sort-active":"",p.onclick=()=>{this.currentSortOrder="name",this.applyFiltersAndSort(),this.currentPage=0,this.renderPage(),f("playSE","decide")};const k=document.createElement("button");k.textContent="前のページ",k.disabled=this.currentPage===0,k.onclick=()=>this.changePage(this.currentPage-1);const w=document.createElement("span");w.className="page-info",w.textContent=`${this.currentPage+1} / ${this.totalPages} ページ`;const E=document.createElement("button");E.textContent="次のページ",E.disabled=this.currentPage>=this.totalPages-1,E.onclick=()=>this.changePage(this.currentPage+1);const b=document.createElement("div");b.className="nav-controls-left",b.appendChild(g),b.appendChild(d);const T=document.createElement("div");T.className="nav-controls-center",T.appendChild(y),T.appendChild(p);const A=document.createElement("div");A.className="nav-controls-right",A.appendChild(k),A.appendChild(w),A.appendChild(E),h.appendChild(b),h.appendChild(T),h.appendChild(A),e.appendChild(h);const G=this.currentPage*this.itemsPerPage,F=G+this.itemsPerPage;this.filteredMonsterIds.slice(G,F).forEach(I=>{const N=re(I);if(N){N.collected=this.dexSet.has(I);const P=ln(N);e.appendChild(P)}})},changePage(e){e>=0&&e<this.totalPages&&(this.currentPage=e,this.renderPage(),f("playSE","decide"))},exit(){const e=document.getElementById("monsterContainer");e&&(e.style.display="none",e.innerHTML="");const t=document.querySelector(".monster-modal");t&&t.remove(),this.canvas&&(this.canvas.style.display="")},update(e){},render(){}},gt={x:300,y:480,width:200,height:50,text:"ステージ選択へ"},qt={canvas:null,ctx:null,_clickHandler:null,_mousemoveHandler:null,mouseX:0,mouseY:0,animationTime:0,resultData:null,async enter(e,t){this.resultData=t||{correct:r.correctKanjiList||[],wrong:r.wrongKanjiList||[],time:u.timeRemaining||0,playerHp:r.playerStats.hp||0};try{await Ge()}catch(s){console.error("実績チェック中にエラーが発生しました:",s)}if(f("playBGM","victory"),us(),r.playerStats.stagesCleared++,u.mistakesThisStage===0?(r.justClearedPerfectly=!0,console.log("🏆 パーフェクトクリア達成！")):r.justClearedPerfectly=!1,this.canvas=e||document.getElementById("gameCanvas"),!this.canvas){console.error("キャンバス要素が見つかりません");return}this.ctx=this.canvas.getContext("2d"),f("playSE","victory"),this.animationTime=0,this.registerHandlers()},update(e){if(!this.ctx||!this.canvas)return;const{ctx:t,canvas:s}=this;this.animationTime+=16,t.clearRect(0,0,s.width,s.height),this.drawParchmentBackground(t,s.width,s.height),this.drawDecorativeTitle(t,s.width/2,120),r.justClearedPerfectly&&this.drawPerfectClearCrown(t,s.width/2+200,80),this.drawResultPanel(t,s.width/2-150,200,300,180);const n=C(this.mouseX,this.mouseY,gt);this.drawRichButton(t,gt,n),r.wrongKanjiList&&r.wrongKanjiList.length>0&&this.drawMistakeScrollPanel(t,50,420,250,150)},drawParchmentBackground(e,t,s){e.save();const n=e.createLinearGradient(0,0,t,s);n.addColorStop(0,"#F5DEB3"),n.addColorStop(.3,"#F0E68C"),n.addColorStop(.7,"#DDD8B8"),n.addColorStop(1,"#D2B48C"),e.fillStyle=n,e.fillRect(0,0,t,s),e.fillStyle="rgba(139, 69, 19, 0.05)";for(let i=0;i<200;i++){const a=Math.random()*t,o=Math.random()*s,l=Math.random()*3+1;e.beginPath(),e.arc(a,o,l,0,Math.PI*2),e.fill()}e.fillStyle="rgba(160, 82, 45, 0.08)";for(let i=0;i<50;i++){const a=Math.random()*t,o=Math.random()*s,l=Math.random()*20+10;e.beginPath(),e.arc(a,o,l,0,Math.PI*2),e.fill()}e.strokeStyle="rgba(139, 69, 19, 0.3)",e.lineWidth=8,e.strokeRect(10,10,t-20,s-20),e.strokeStyle="rgba(160, 82, 45, 0.2)",e.lineWidth=4,e.strokeRect(15,15,t-30,s-30),e.restore()},drawDecorativeTitle(e,t,s){e.save();const n=400,i=60,a=e.createLinearGradient(t-n/2,s-i/2,t+n/2,s+i/2);a.addColorStop(0,"#DAA520"),a.addColorStop(.5,"#FFD700"),a.addColorStop(1,"#B8860B"),e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(t-n/2+5,s-i/2+5,n,i),e.fillStyle=a,e.fillRect(t-n/2,s-i/2,n,i),e.strokeStyle="#8B4513",e.lineWidth=3,e.strokeRect(t-n/2,s-i/2,n,i),e.font='bold 42px "UDデジタル教科書体", serif',e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillText("ステージクリア！",t+3,s+3);const o=e.createLinearGradient(t,s-20,t,s+20);o.addColorStop(0,"#FFFACD"),o.addColorStop(.5,"#FFD700"),o.addColorStop(1,"#DAA520"),e.fillStyle=o,e.fillText("ステージクリア！",t,s),e.strokeStyle="#8B4513",e.lineWidth=2,e.strokeText("ステージクリア！",t,s),e.font='24px "UDデジタル教科書体", sans-serif',e.fillStyle="#8B4513",e.fillText("おめでとうございます！",t,s+50),e.restore()},drawPerfectClearCrown(e,t,s){e.save();const n=1+.1*Math.sin(this.animationTime*.005),i=this.animationTime*.002;e.translate(t,s),e.rotate(i),e.scale(n,n),e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.moveTo(2,12),e.lineTo(-18,-8),e.lineTo(-8,-18),e.lineTo(2,-8),e.lineTo(12,-18),e.lineTo(22,-8),e.closePath(),e.fill();const a=e.createLinearGradient(0,-20,0,10);a.addColorStop(0,"#FFD700"),a.addColorStop(.5,"#FFA500"),a.addColorStop(1,"#DAA520"),e.fillStyle=a,e.beginPath(),e.moveTo(0,10),e.lineTo(-20,-10),e.lineTo(-10,-20),e.lineTo(0,-10),e.lineTo(10,-20),e.lineTo(20,-10),e.closePath(),e.fill(),e.strokeStyle="#B8860B",e.lineWidth=2,e.stroke(),e.fillStyle="#FF1493",e.beginPath(),e.arc(0,-5,4,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.7)",e.beginPath(),e.arc(-1,-7,2,0,Math.PI*2),e.fill(),e.restore(),e.save(),e.font='bold 20px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.fillStyle="#FF6347",e.fillText("PERFECT!",t,s+40),e.restore()},drawResultPanel(e,t,s,n,i){e.save(),e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(t+5,s+5,n,i);const a=e.createLinearGradient(t,s,t,s+i);a.addColorStop(0,"#DEB887"),a.addColorStop(.5,"#D2B48C"),a.addColorStop(1,"#BC9A6A"),e.fillStyle=a,e.fillRect(t,s,n,i),e.strokeStyle="#8B4513",e.lineWidth=3,e.strokeRect(t,s,n,i),e.strokeStyle="#A0522D",e.lineWidth=1,e.strokeRect(t+5,s+5,n-10,i-10),e.font='bold 24px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.fillStyle="#8B4513",e.fillText("戦績",t+n/2,s+30);const o=[`正解数: ${r.correctKanjiList?r.correctKanjiList.length:0}`,`間違い: ${r.wrongKanjiList?r.wrongKanjiList.length:0}`,`現在レベル: ${r.playerStats.level}`,`総ステージクリア: ${r.playerStats.stagesCleared}`];e.font='18px "UDデジタル教科書体", sans-serif',e.textAlign="left",e.fillStyle="#654321",o.forEach((l,c)=>{e.fillText(l,t+20,s+70+c*25)}),r.justClearedPerfectly&&(e.font='bold 16px "UDデジタル教科書体", sans-serif',e.fillStyle="#FF6347",e.textAlign="center",e.fillText("✨ パーフェクトクリア ✨",t+n/2,s+i-15)),e.restore()},drawRichButton(e,t,s){e.save();const{x:n,y:i,width:a,height:o,text:l}=t,c=s?1.05:1,h=a*c,g=o*c,d=n+(a-h)/2,m=i+(o-g)/2;e.fillStyle="rgba(0, 0, 0, 0.4)",e.fillRect(d+4,m+4,h,g);const y=e.createLinearGradient(d,m,d,m+g);s?(y.addColorStop(0,"#32CD32"),y.addColorStop(.5,"#228B22"),y.addColorStop(1,"#006400")):(y.addColorStop(0,"#228B22"),y.addColorStop(.5,"#006400"),y.addColorStop(1,"#004000")),e.fillStyle=y,e.fillRect(d,m,h,g),e.strokeStyle=s?"#FFD700":"#8B4513",e.lineWidth=s?3:2,e.strokeRect(d,m,h,g);const p=e.createLinearGradient(d,m,d,m+g*.3);p.addColorStop(0,"rgba(255, 255, 255, 0.3)"),p.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=p,e.fillRect(d,m,h,g*.3),e.font='bold 20px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillText(l,d+h/2+2,m+g/2+2),e.fillStyle=s?"#FFFACD":"white",e.fillText(l,d+h/2,m+g/2),e.restore()},drawMistakeScrollPanel(e,t,s,n,i){if(!r.wrongKanjiList||r.wrongKanjiList.length===0)return;e.save(),e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(t+3,s+3,n,i);const a=e.createLinearGradient(t,s,t+n,s);a.addColorStop(0,"#F5E6D3"),a.addColorStop(.5,"#E6D3C1"),a.addColorStop(1,"#D3C1A8"),e.fillStyle=a,e.fillRect(t,s,n,i),e.strokeStyle="#8B4513",e.lineWidth=2,e.strokeRect(t,s,n,i),e.fillStyle="#A0522D",e.fillRect(t,s,n,8),e.fillRect(t,s+i-8,n,8),e.font='bold 16px "UDデジタル教科書体", sans-serif',e.textAlign="left",e.fillStyle="#8B4513",e.fillText("復習が必要な漢字:",t+10,s+25),e.font='14px "UDデジタル教科書体", sans-serif',e.fillStyle="#654321";const o=Math.min(r.wrongKanjiList.length,4);for(let l=0;l<o;l++){const c=r.wrongKanjiList[l],h=`${c.text||c}（${c.meaning||""}）`;e.fillText(h,t+15,s+50+l*20)}r.wrongKanjiList.length>4&&(e.fillStyle="#A0522D",e.fillText(`...他${r.wrongKanjiList.length-4}個`,t+15,s+130)),e.restore()},exit(){this.canvas&&this.unregisterHandlers(),this.canvas=null,this.ctx=null,this.resultData=null},registerHandlers(){this.canvas&&(this._clickHandler=this.handleClick.bind(this),this._mousemoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mousemoveHandler))},unregisterHandlers(){this.canvas&&(this._clickHandler&&(this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)),this._mousemoveHandler&&this.canvas.removeEventListener("mousemove",this._mousemoveHandler),this._clickHandler=null,this._mousemoveHandler=null)},handleMouseMove(e){if(!this.canvas)return;const t=this.canvas.getBoundingClientRect(),s=this.canvas.width/t.width,n=this.canvas.height/t.height;this.mouseX=(e.clientX-t.left)*s,this.mouseY=(e.clientY-t.top)*n},handleClick(e){if(!this.canvas)return;e.preventDefault();let t,s;e.changedTouches?(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY):(t=e.clientX,s=e.clientY);const n=this.canvas.getBoundingClientRect(),i=this.canvas.width/n.width,a=this.canvas.height/n.height,o=(t-n.left)*i,l=(s-n.top)*a;C(o,l,gt)&&(f("playSE","decide"),f("changeScreen","stageSelect"))}};qt.render=function(){this.update(0)};const ut={x:250,y:420,width:140,height:50,text:"リトライ"},ft={x:410,y:420,width:140,height:50,text:"タイトルへ"},hn={canvas:null,ctx:null,_clickHandler:null,_mousemoveHandler:null,mouseX:0,mouseY:0,animationTime:0,enter(){if(f("playBGM","gameover"),this.canvas=document.getElementById("gameCanvas"),!this.canvas){console.error("キャンバス要素が見つかりません");return}this.ctx=this.canvas.getContext("2d"),f("playSE","gameover"),this.animationTime=0,this.registerHandlers()},update(e){if(!this.ctx||!this.canvas)return;const{ctx:t,canvas:s}=this;this.animationTime+=16,t.clearRect(0,0,s.width,s.height),this.drawStormyBackground(t,s.width,s.height),this.drawCrackedTitle(t,s.width/2,120),this.drawWeatheredResultPanel(t,s.width/2-150,220,300,160);const n=C(this.mouseX,this.mouseY,ut),i=C(this.mouseX,this.mouseY,ft);this.drawSomberButton(t,ut,n,"retry"),this.drawSomberButton(t,ft,i,"title"),this.drawDespairEffects(t,s.width,s.height)},drawStormyBackground(e,t,s){e.save();const n=e.createLinearGradient(0,0,0,s);n.addColorStop(0,"#2C3E50"),n.addColorStop(.3,"#34495E"),n.addColorStop(.7,"#1C2833"),n.addColorStop(1,"#17202A"),e.fillStyle=n,e.fillRect(0,0,t,s);const i=this.animationTime*.001%(t+100);e.fillStyle="rgba(44, 62, 80, 0.3)";for(let a=0;a<5;a++){const o=(i+a*200-100)%(t+200)-100,l=50+a*30,c=40+a*10;e.beginPath(),e.arc(o,l,c,0,Math.PI*2),e.arc(o+30,l,c*.8,0,Math.PI*2),e.arc(o+60,l,c*.6,0,Math.PI*2),e.fill()}e.fillStyle="rgba(85, 85, 85, 0.4)";for(let a=0;a<300;a++){const o=Math.random()*t,l=Math.random()*s,c=Math.random()*2+.5;e.beginPath(),e.arc(o,l,c,0,Math.PI*2),e.fill()}e.strokeStyle="rgba(169, 169, 169, 0.3)",e.lineWidth=1;for(let a=0;a<8;a++){e.beginPath();const o=Math.random()*t,l=Math.random()*s;let c=o,h=l;e.moveTo(c,h);for(let g=0;g<5;g++)c+=(Math.random()-.5)*100,h+=(Math.random()-.5)*100,e.lineTo(c,h);e.stroke()}e.strokeStyle="rgba(105, 105, 105, 0.5)",e.lineWidth=6,e.strokeRect(8,8,t-16,s-16),e.strokeStyle="rgba(128, 128, 128, 0.3)",e.lineWidth=3,e.strokeRect(12,12,t-24,s-24),e.restore()},drawCrackedTitle(e,t,s){e.save(),e.font='bold 48px "UDデジタル教科書体", serif',e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillText("ゲームオーバー",t+4,s+4);const n=e.createLinearGradient(t-150,s-25,t+150,s+25);n.addColorStop(0,"#8B0000"),n.addColorStop(.5,"#DC143C"),n.addColorStop(1,"#B22222"),e.fillStyle=n,e.fillText("ゲームオーバー",t,s),e.strokeStyle="#2F4F4F",e.lineWidth=2,e.strokeText("ゲームオーバー",t,s),e.strokeStyle="rgba(105, 105, 105, 0.6)",e.lineWidth=1,e.beginPath(),e.moveTo(t-120,s-10),e.lineTo(t-80,s+5),e.lineTo(t-40,s-8),e.moveTo(t+20,s+8),e.lineTo(t+60,s-5),e.lineTo(t+100,s+10),e.stroke(),e.font='24px "UDデジタル教科書体", sans-serif',e.fillStyle="#696969",e.fillText("チャレンジ失敗...",t,s+50),e.fillStyle="rgba(169, 169, 169, 0.4)";for(let i=0;i<6;i++){const a=Math.PI*2*i/6,o=80+Math.sin(this.animationTime*.003+i)*10,l=t+Math.cos(a)*o,c=s+Math.sin(a)*o,h=3+Math.random()*2;e.beginPath(),e.arc(l,c,h,0,Math.PI*2),e.fill()}e.restore()},drawWeatheredResultPanel(e,t,s,n,i){e.save(),e.fillStyle="rgba(0, 0, 0, 0.6)",e.fillRect(t+6,s+6,n,i);const a=e.createLinearGradient(t,s,t,s+i);a.addColorStop(0,"#708090"),a.addColorStop(.3,"#696969"),a.addColorStop(.7,"#556B2F"),a.addColorStop(1,"#2F4F4F"),e.fillStyle=a,e.fillRect(t,s,n,i),e.strokeStyle="#2F2F2F",e.lineWidth=4,e.strokeRect(t,s,n,i),e.strokeStyle="#A9A9A9",e.lineWidth=1,e.strokeRect(t+8,s+8,n-16,i-16),e.strokeStyle="rgba(169, 169, 169, 0.5)",e.lineWidth=2,e.beginPath(),e.moveTo(t+20,s+i*.3),e.lineTo(t+n-30,s+i*.7),e.moveTo(t+n*.7,s+15),e.lineTo(t+n*.3,s+i-20),e.stroke(),e.font='bold 22px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.fillStyle="#F5F5DC",e.fillText("戦績",t+n/2,s+35);const o=[`正解した漢字: ${r.correctKanjiList.length}個`,`間違えた漢字: ${r.wrongKanjiList.length}個`,`現在レベル: ${r.playerStats.level}`,`挑戦回数: ${r.playerStats.totalAttempts||1}`];e.font='16px "UDデジタル教科書体", sans-serif',e.textAlign="left",e.fillStyle="#DCDCDC",o.forEach((l,c)=>{e.fillText(l,t+20,s+70+c*22)}),e.font='italic 14px "UDデジタル教科書体", sans-serif',e.fillStyle="#CD5C5C",e.textAlign="center",e.fillText("次こそは勝利を掴もう...",t+n/2,s+i-15),e.restore()},drawSomberButton(e,t,s,n){e.save();const{x:i,y:a,width:o,height:l,text:c}=t,h=s?1.05:1,g=o*h,d=l*h,m=i+(o-g)/2,y=a+(l-d)/2;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(m+5,y+5,g,d);const p=e.createLinearGradient(m,y,m,y+d);n==="retry"?s?(p.addColorStop(0,"#4682B4"),p.addColorStop(.5,"#2F4F4F"),p.addColorStop(1,"#191970")):(p.addColorStop(0,"#2F4F4F"),p.addColorStop(.5,"#191970"),p.addColorStop(1,"#0F0F23")):s?(p.addColorStop(0,"#A0522D"),p.addColorStop(.5,"#8B4513"),p.addColorStop(1,"#654321")):(p.addColorStop(0,"#8B4513"),p.addColorStop(.5,"#654321"),p.addColorStop(1,"#2F1B14")),e.fillStyle=p,e.fillRect(m,y,g,d),e.strokeStyle=s?"#696969":"#2F2F2F",e.lineWidth=s?3:2,e.strokeRect(m,y,g,d),s||(e.strokeStyle="rgba(169, 169, 169, 0.3)",e.lineWidth=1,e.beginPath(),e.moveTo(m+10,y+d*.3),e.lineTo(m+g-10,y+d*.7),e.stroke());const k=e.createLinearGradient(m,y,m,y+d*.3);k.addColorStop(0,"rgba(255, 255, 255, 0.1)"),k.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=k,e.fillRect(m,y,g,d*.3),e.font='bold 18px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillText(c,m+g/2+2,y+d/2+2),e.fillStyle=s?"#F5F5DC":"#DCDCDC",e.fillText(c,m+g/2,y+d/2),e.restore()},drawDespairEffects(e,t,s){e.save(),e.fillStyle="rgba(169, 169, 169, 0.3)";for(let i=0;i<20;i++){const a=(this.animationTime*.02+i*40)%t,o=(this.animationTime*.05+i*30)%s,l=1+Math.random()*2;e.beginPath(),e.arc(a,o,l,0,Math.PI*2),e.fill()}const n=e.createRadialGradient(t/2,s/2,0,t/2,s/2,Math.max(t,s)*.7);n.addColorStop(0,"rgba(0, 0, 0, 0)"),n.addColorStop(1,"rgba(0, 0, 0, 0.4)"),e.fillStyle=n,e.fillRect(0,0,t,s),e.restore()},exit(){this.canvas&&this.unregisterHandlers(),this.canvas=null,this.ctx=null},registerHandlers(){this.canvas&&(this._clickHandler=this.handleClick.bind(this),this._mousemoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mousemoveHandler))},unregisterHandlers(){this.canvas&&(this._clickHandler&&(this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)),this._mousemoveHandler&&this.canvas.removeEventListener("mousemove",this._mousemoveHandler),this._clickHandler=null,this._mousemoveHandler=null)},handleMouseMove(e){if(!this.canvas)return;const t=this.canvas.getBoundingClientRect(),s=this.canvas.width/t.width,n=this.canvas.height/t.height;this.mouseX=(e.clientX-t.left)*s,this.mouseY=(e.clientY-t.top)*n},handleClick(e){if(!this.canvas)return;e.preventDefault();let t,s;e.changedTouches?(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY):(t=e.clientX,s=e.clientY);const n=this.canvas.getBoundingClientRect(),i=this.canvas.width/n.width,a=this.canvas.height/n.height,o=(t-n.left)*i,l=(s-n.top)*a;C(o,l,ut)&&(f("playSE","decide"),f("changeScreen",r.currentStageId)),C(o,l,ft)&&(f("playSE","decide"),f("changeScreen","title"))},render(){this.update(0)}},dn={canvas:null,ctx:null,finalScore:0,correctCount:0,wrongCount:0,ranking:[],enter(e,t){if(this.canvas=e||document.getElementById("gameCanvas"),!this.canvas){console.error("Canvas element not found!");return}if(this.ctx=this.canvas.getContext("2d"),!this.ctx){console.error("Canvas context not available!");return}const s=t||{correct:r.correctKanjiList||[],wrong:r.wrongKanjiList||[],time:0,playerHp:r.playerStats.hp};this.correctCount=s.correct.length,this.wrongCount=s.wrong.length;let n=this.correctCount*10,i=s.playerHp||0,a=0;r.gameMode==="challenge"&&s.time>0&&(a=s.time*2),this.finalScore=n+i+a;const o=this.canvas.width/2;this.retryButton={x:o-150,y:400,width:300,height:50,text:"もう一度プレイ"},this.titleButton={x:o-150,y:470,width:300,height:50,text:"タイトルへもどる"},this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.updateRanking()},update(e){this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.font="48px sans-serif",this.ctx.fillText("結果発表",this.canvas.width/2,80),this.ctx.font="32px sans-serif",this.ctx.fillText(`スコア: ${this.finalScore} 点`,this.canvas.width/2,150),this.ctx.font="24px sans-serif",this.ctx.fillText(`正解数: ${this.correctCount}`,this.canvas.width/2,200),this.ctx.fillText(`不正解数: ${this.wrongCount}`,this.canvas.width/2,230),this.ctx.font="28px sans-serif",this.ctx.fillText("ランキング",this.canvas.width/2,280),this.ranking.forEach((t,s)=>{this.ctx.font="22px sans-serif";const n=`${s+1}位: ${t.score}点 (${new Date(t.date).toLocaleDateString()})`;this.ctx.fillText(n,this.canvas.width/2,320+s*30)}),Z(this.ctx,this.retryButton.x,this.retryButton.y,this.retryButton.width,this.retryButton.height,this.retryButton.text),Z(this.ctx,this.titleButton.x,this.titleButton.y,this.titleButton.width,this.titleButton.height,this.titleButton.text)},exit(){this.canvas&&this._clickHandler&&this.canvas.removeEventListener("click",this._clickHandler)},handleClick(e){const t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,n=e.clientY-t.top;C(s,n,this.retryButton)&&f("changeScreen","stageSelect"),C(s,n,this.titleButton)&&f("changeScreen","title")},updateRanking(){const e=localStorage.getItem("kanjiBattleScores"),t=e?JSON.parse(e):[];t.push({score:this.finalScore,date:new Date().toISOString()}),t.sort((n,i)=>i.score-n.score);const s=t.slice(0,5);localStorage.setItem("kanjiBattleScores",JSON.stringify(s)),this.ranking=s},render(){this.update(0)}},gn={canvas:null,ctx:null,_clickHandler:null,hpUpgradeButton:null,attackUpgradeButton:null,backButton:null,enter(e){this.canvas=e&&typeof e.getContext=="function"?e:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const t=this.canvas.width/2;this.hpUpgradeButton={x:t-180,y:300,width:160,height:50,text:"HP+10 (SP:1)",cost:1,stat:"maxHp",increase:10},this.attackUpgradeButton={x:t+20,y:300,width:160,height:50,text:"攻撃+2 (SP:1)",cost:1,stat:"attack",increase:2},this.backButton={x:t-100,y:400,width:200,height:50,text:"メニューに戻る"},this.registerHandlers()},update(e){const{ctx:t,canvas:s}=this,n=r.playerStats;t.clearRect(0,0,s.width,s.height),t.fillStyle="black",t.fillRect(0,0,s.width,s.height),t.fillStyle="white",t.font='36px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.fillText("プレイヤーステータス",s.width/2,80),r.playerName&&(t.font='24px "UDデジタル教科書体", sans-serif',t.fillText(`${r.playerName}`,s.width/2,120)),t.font='20px "UDデジタル教科書体", sans-serif',t.textAlign="left";const i=s.width/2-120,a=160,o=30;t.fillText(`レベル: ${n.level}`,i,a),t.fillText(`HP: ${n.hp} / ${n.maxHp}`,i,a+o),t.fillText(`攻撃力: ${n.attack}`,i,a+o*2),t.fillStyle=n.skillPoints>0?"#FFD700":"white",t.font='22px "UDデジタル教科書体", sans-serif',t.fillText(`スキルポイント: ${n.skillPoints}`,i,a+o*3),n.skillPoints===0&&(t.fillStyle="#888888",t.font='16px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.fillText("レベルアップでスキルポイントを獲得できます",s.width/2,a+o*4.5)),this.drawUpgradeButton(this.hpUpgradeButton,n.skillPoints>=this.hpUpgradeButton.cost),this.drawUpgradeButton(this.attackUpgradeButton,n.skillPoints>=this.attackUpgradeButton.cost),t.fillStyle="white",Z(t,this.backButton.x,this.backButton.y,this.backButton.width,this.backButton.height,this.backButton.text,"#34495e")},drawUpgradeButton(e,t){const{ctx:s}=this,n=t?"#27ae60":"#95a5a6";v.buttonNormal&&t&&s.drawImage(v.buttonNormal,e.x,e.y,e.width,e.height),Z(s,e.x,e.y,e.width,e.height,e.text,n),t||(s.fillStyle="rgba(0, 0, 0, 0.3)",s.fillRect(e.x,e.y,e.width,e.height))},exit(){this.unregisterHandlers(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler)},unregisterHandlers(){this.canvas&&this._clickHandler&&this.canvas.removeEventListener("click",this._clickHandler)},handleClick(e){const t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,n=e.clientY-t.top,i=r.playerStats;if(C(s,n,this.hpUpgradeButton)&&i.skillPoints>=this.hpUpgradeButton.cost){this.upgradeStatus(this.hpUpgradeButton),f("playSE","correct");return}if(C(s,n,this.attackUpgradeButton)&&i.skillPoints>=this.attackUpgradeButton.cost){this.upgradeStatus(this.attackUpgradeButton),f("playSE","correct");return}if(C(s,n,this.backButton)){f("changeScreen","menu");return}},upgradeStatus(e){const t=r.playerStats;t.skillPoints-=e.cost,t.skillPointsUsed+=e.cost,t[e.stat]+=e.increase,e.stat==="maxHp"&&(t.hp+=e.increase),Ge().catch(s=>{console.error("実績チェック中にエラーが発生しました:",s)}),console.log(`${e.stat} を ${e.increase} 上昇させました。残りSP: ${t.skillPoints}`)}},U={back:{x:20,y:20,w:100,h:30,label:"メニューへ"},prevPage:{x:580,y:500,w:100,h:40,label:"前のページ"},nextPage:{x:690,y:500,w:100,h:40,label:"次のページ"}},Jt={canvas:null,ctx:null,achievements:[],scroll:0,itemsPerPage:8,_clickHandler:null,_keyHandler:null,async enter(e){this.canvas=e&&typeof e.getContext=="function"?e:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),await this.loadAchievements(),this.scroll=0,this._clickHandler=t=>{const s=this.canvas.getBoundingClientRect(),n=t.clientX-s.left,i=t.clientY-s.top;if(C(n,i,U.back)){f("playSE","decide"),f("changeScreen","menu");return}if(C(n,i,U.prevPage)){this.scroll=Math.max(0,this.scroll-this.itemsPerPage),f("playSE","decide");return}if(C(n,i,U.nextPage)){const a=Math.max(0,this.achievements.length-this.itemsPerPage);this.scroll=Math.min(a,this.scroll+this.itemsPerPage),f("playSE","decide");return}},this.canvas.addEventListener("click",this._clickHandler),this._keyHandler=t=>{if(t.key==="ArrowUp")this.scroll=Math.max(0,this.scroll-this.itemsPerPage);else if(t.key==="ArrowDown"){const s=Math.max(0,this.achievements.length-this.itemsPerPage);this.scroll=Math.min(s,this.scroll+this.itemsPerPage)}},window.addEventListener("keydown",this._keyHandler)},async loadAchievements(){try{const e=await fetch("/src/data/achievements.json");if(!e.ok)throw new Error(`実績データの読み込みに失敗: ${e.statusText}`);this.achievements=await e.json(),console.log(`📋 実績データを読み込みました: ${this.achievements.length}件`)}catch(e){console.error("❌ 実績データの読み込みエラー:",e),this.achievements=[]}},update(e){const{ctx:t,canvas:s}=this;t.fillStyle="#1a1a2e",t.fillRect(0,0,s.width,s.height),Z(t,U.back.x,U.back.y,U.back.w,U.back.h,U.back.label),this.achievements.length>this.itemsPerPage&&(Z(t,U.prevPage.x,U.prevPage.y,U.prevPage.w,U.prevPage.h,U.prevPage.label),Z(t,U.nextPage.x,U.nextPage.y,U.nextPage.w,U.nextPage.h,U.nextPage.label)),t.fillStyle="white",t.font='28px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.fillText("実績一覧",s.width/2,70);const n=r.unlockedAchievements.size,i=this.achievements.length,a=i>0?Math.round(n/i*100):0;if(t.font='18px "UDデジタル教科書体", sans-serif',t.textAlign="right",t.fillStyle="#FFD700",t.fillText(`🏆 ${n}/${i} (${a}%)`,s.width-20,40),this.drawAchievementsList(),this.achievements.length>this.itemsPerPage){const o=Math.floor(this.scroll/this.itemsPerPage)+1,l=Math.ceil(this.achievements.length/this.itemsPerPage);t.fillStyle="white",t.font='16px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.fillText(`${o} / ${l}`,s.width/2,525)}},drawAchievementsList(){const{ctx:e}=this,t=110,s=45,n=680,i=40;e.textAlign="left",e.textBaseline="middle";for(let a=0;a<this.itemsPerPage;a++){const o=this.scroll+a;if(o>=this.achievements.length)break;const l=this.achievements[o],c=t+a*s,h=Ft(l.id);if(h){const g=e.createLinearGradient(50,c-i/2,50+n,c+i/2);g.addColorStop(0,"rgba(255, 215, 0, 0.1)"),g.addColorStop(.5,"rgba(255, 215, 0, 0.2)"),g.addColorStop(1,"rgba(255, 215, 0, 0.1)"),e.fillStyle=g}else e.fillStyle="rgba(100, 100, 100, 0.1)";e.fillRect(50,c-i/2,n,i),e.strokeStyle=h?"#FFD700":"#555",e.lineWidth=1,e.strokeRect(50,c-i/2,n,i),h?this.drawUnlockedAchievement(l,c):this.drawLockedAchievement(l,c)}},drawUnlockedAchievement(e,t){const{ctx:s}=this;s.fillStyle="#FFD700",s.font="24px serif",s.fillText("🏆",60,t),s.fillStyle="#FFD700",s.font='bold 18px "UDデジタル教科書体", sans-serif',s.fillText(e.title,95,t-8),s.fillStyle="white",s.font='14px "UDデジタル教科書体", sans-serif',s.fillText(e.description,95,t+12),s.fillStyle="#00FF00",s.font='12px "UDデジタル教科書体", sans-serif',s.textAlign="right",s.fillText("✓ 解除済み",720,t),s.textAlign="left"},drawLockedAchievement(e,t){const{ctx:s}=this;s.fillStyle="#666",s.font="24px serif",s.fillText("🔒",60,t),s.fillStyle="#666",s.font='18px "UDデジタル教科書体", sans-serif',s.fillText("？？？",95,t-8),s.fillStyle="#555",s.font='14px "UDデジタル教科書体", sans-serif',s.fillText("未解除の実績です",95,t+12),this.shouldShowHint(e)&&(s.fillStyle="#888",s.font='12px "UDデジタル教科書体", sans-serif',s.textAlign="right",s.fillText(this.getConditionHint(e),720,t),s.textAlign="left")},shouldShowHint(e){const{condition:t}=e,s=r.playerStats;switch(t.type){case"enemiesDefeated":return s.enemiesDefeated>0;case"levelReached":return s.level>1;case"stagesCleared":return s.stagesCleared>0;default:return!1}},getConditionHint(e){var n,i;const{condition:t}=e,s=r.playerStats;switch(t.type){case"enemiesDefeated":return`敵撃破 ${s.enemiesDefeated}/${t.value}`;case"levelReached":return`レベル ${s.level}/${t.value}`;case"stagesCleared":return`ステージ ${s.stagesCleared}/${t.value}`;case"kanjiCollected":return`漢字 ${((n=r.kanjiDex)==null?void 0:n.size)||0}/${t.value}`;case"monstersCollected":return`モンスター ${((i=r.monsterDex)==null?void 0:i.size)||0}/${t.value}`;default:return"条件を満たすと解除"}},exit(){this.canvas&&this._clickHandler&&this.canvas.removeEventListener("click",this._clickHandler),this._keyHandler&&window.removeEventListener("keydown",this._keyHandler),this.canvas=this.ctx=null,this.achievements=[]}};Jt.render=function(){this.update(0)};const un={enter(e){this.canvas=e||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const t=this.canvas.width/2;if(this.confirmButton={x:t-100,y:400,width:200,height:50,text:"けってい"},this.nameInputElement=document.getElementById("playerNameInputField"),this.nameInputElement){this.nameInputElement.style.display="block",this.nameInputElement.value="",this.nameInputElement.maxLength=10;const s=this.canvas.getBoundingClientRect();this.nameInputElement.style.left=`${s.left+t-this.nameInputElement.offsetWidth/2}px`,this.nameInputElement.style.top=`${s.top+300}px`,this.nameInputElement.focus()}this.registerHandlers()},update(e){const t=this.canvas.width,s=this.canvas.height,n=this.ctx;n.clearRect(0,0,t,s),n.fillStyle="#1e3c72",n.fillRect(0,0,t,s),n.fillStyle="white",n.font='32px "UDデジタル教科書体",sans-serif',n.textAlign="center",n.fillText("なまえを にゅうりょく してください",t/2,150),n.font='20px "UDデジタル教科書体",sans-serif',n.fillText("(10もじまで)",t/2,200),n.strokeStyle="white",n.lineWidth=2,n.strokeRect(t/2-150,280,300,40),v.buttonNormal&&n.drawImage(v.buttonNormal,this.confirmButton.x,this.confirmButton.y,this.confirmButton.width,this.confirmButton.height),Z(n,this.confirmButton.x,this.confirmButton.y,this.confirmButton.width,this.confirmButton.height,this.confirmButton.text)},exit(){this.unregisterHandlers(),this.nameInputElement&&(this.nameInputElement.style.display="none",this.nameInputElement.onkeydown=null),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this._keyHandler=this.handleKeydown.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.nameInputElement&&(this.nameInputElement.onkeydown=this._keyHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)},handleKeydown(e){e.key==="Enter"&&(this.submitNameAndSave(),e.preventDefault())},handleClick(e){e.preventDefault();let t,s;e.changedTouches?(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY):(t=e.clientX,s=e.clientY);const n=this.canvas.getBoundingClientRect(),i=this.canvas.width/n.width,a=this.canvas.height/n.height,o=(t-n.left)*i,l=(s-n.top)*a;C(o,l,this.confirmButton)&&(f("playSE","decide"),this.submitNameAndSave())},async submitNameAndSave(){if(!this.nameInputElement)return;const e=this.nameInputElement.value.trim();if(e===""||e==="ななしのごんべえ"||e==="ゲスト"||e==="新規プレイヤー"){alert("有効な なまえを いれてください。"),this.nameInputElement.value="",this.nameInputElement.focus();return}Lt(e);const t=tt();if(t&&t.uid)try{const s=await xt(t.uid,e);s&&console.log("New player profile created/updated in Firestore:",s)}catch(s){console.error("Firebase保存エラー:",s)}r.pendingGameMode&&(r.gameMode=r.pendingGameMode,r.pendingGameMode=null),r.currentGrade=0,f("changeScreen","regionSelect")},render(){this.update(0)}},fn={canvas:null,ctx:null,progress:0,stageId:null,async enter(e){try{if(console.log("🔄 stageLoadingState.enter() 実行",{canvas:e,stageId:r.currentStageId}),this.canvas=e||document.getElementById("gameCanvas"),this.canvas||(console.error("キャンバス要素が見つかりません。DOMから取得を試みます。"),this.canvas=document.getElementById("gameCanvas")),!this.canvas)throw new Error("キャンバス要素が見つかりません");if(this.ctx=this.canvas.getContext("2d"),this.progress=0,this.stageId=r.currentStageId,!this.stageId){console.error("ステージIDが未設定のため、ローディングを中止します。"),f("changeScreen","stageSelect");return}const t=kt(this.stageId);console.log(`ステージ[${this.stageId}]の敵: ${t.length}体`,t);const s=[Cs(this.stageId)];for(const g of t){const d=Es(g).catch(m=>(console.warn(`敵[${g.id}]の画像読み込みに失敗しましたが、続行します:`,m),null));s.push(d)}const n=s.length;let i=0;const a=()=>{i++,this.progress=i/n,this.update(0)},o=s.map(g=>g.then(d=>(a(),d))),l=await Promise.allSettled(o),c=l.filter(g=>g.status==="fulfilled").length,h=l.filter(g=>g.status==="rejected").length;console.log(`アセット読み込み結果: 成功=${c}, 失敗=${h}`),console.log(`ステージ[${this.stageId}]のアセット読み込み完了。バトル画面へ遷移します。`),r.currentStageId=this.stageId,f("changeScreen","battle",this.canvas)}catch(t){console.error(`[${this.stageId}]のアセット読み込み中にエラー:`,t),alert("ステージの準備に失敗しました。ステージ選択に戻ります。"),f("changeScreen","stageSelect")}},update(e){const{ctx:t,canvas:s}=this;if(!t)return;t.clearRect(0,0,s.width,s.height),t.fillStyle="black",t.fillRect(0,0,s.width,s.height);const n=600,i=30,a=(s.width-n)/2,o=(s.height-i)/2;t.fillStyle="#555",t.fillRect(a,o,n,i),t.fillStyle="#4caf50",t.fillRect(a,o,n*this.progress,i),t.strokeStyle="#fff",t.strokeRect(a,o,n,i),t.fillStyle="#fff",t.font='16px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="top",t.fillText(`${Math.floor(this.progress*100)}%`,s.width/2,o+i+8),t.fillText("ステージ準備中...",s.width/2,o-20)},exit(){console.log("🚪 stageLoadingState.exit() 実行"),this.ctx=null,this.canvas=null}},mn={enter(e){this.canvas=e||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const t=this.canvas.width,s=this.canvas.height;this.japanButton={x:50,y:150,width:t/2-75,height:s-250},this.worldButton={x:t/2+25,y:150,width:t/2-75,height:s-250},this.registerHandlers()},update(e){const t=this.canvas.width,s=this.canvas.height,n=this.ctx;n.clearRect(0,0,t,s);const i=n.createLinearGradient(0,0,0,s);i.addColorStop(0,"#2c3e50"),i.addColorStop(.5,"#34495e"),i.addColorStop(1,"#2c3e50"),n.fillStyle=i,n.fillRect(0,0,t,s),n.fillStyle="#f1c40f",n.font='bold 32px "UDデジタル教科書体", sans-serif',n.textAlign="center",n.textBaseline="top",n.fillText("学習コース選択",t/2,50),this._drawCourseArea(n,this.japanButton,"小学生の漢字（日本編）",v.japanMap),this._drawCourseArea(n,this.worldButton,"中学生の漢字（世界編）",v.worldMap),n.fillStyle="#7f8c8d",n.font='16px "UDデジタル教科書体", sans-serif',n.textAlign="center",n.textBaseline="bottom",n.fillText("※ 画面をタップして選択してください",t/2,s-30)},_drawCourseArea(e,t,s,n){if(e.fillStyle="rgba(255, 255, 255, 0.1)",e.fillRect(t.x,t.y,t.width,t.height),e.strokeStyle="#f39c12",e.lineWidth=3,e.strokeRect(t.x,t.y,t.width,t.height),e.fillStyle="#ecf0f1",e.font='bold 24px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.textBaseline="top",e.fillText(s,t.x+t.width/2,t.y+20),n){const i=Math.min(t.width-40,n.width),a=Math.min(t.height-100,n.height),o=t.x+(t.width-i)/2,l=t.y+70;e.drawImage(n,o,l,i,a)}},exit(){this.unregisterHandlers(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)},handleClick(e){e.preventDefault();let t,s;e.changedTouches?(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY):(t=e.clientX,s=e.clientY);const n=this.canvas.getBoundingClientRect(),i=this.canvas.width/n.width,a=this.canvas.height/n.height,o=(t-n.left)*i,l=(s-n.top)*a;if(C(o,l,this.japanButton)){f("playSE","decide"),f("changeScreen","regionSelect");return}if(C(o,l,this.worldButton)){f("playSE","decide"),f("changeScreen","continentSelect");return}},render(){this.update(0)}},mt=[{name:"アジア",kanken_level:"4",x:550,y:250,color:"#7ED321",region:"アジア"},{name:"ヨーロッパ",kanken_level:"3",x:450,y:230,color:"#4169e1",region:"ヨーロッパ"},{name:"アメリカ大陸",kanken_level:"準2",x:200,y:250,color:"#F5A623",region:"アメリカ大陸"},{name:"アフリカ",kanken_level:"2",x:420,y:350,color:"#ff7f50",region:"アフリカ大陸"}],Ce={x:10,y:540,width:120,height:40,text:"戻る"},pn={canvas:null,ctx:null,animationTime:0,hoveredMarker:null,isZooming:!1,zoomProgress:0,zoomTarget:null,zoomStartTime:0,zoomDuration:800,camera:{x:0,y:0,scale:1,targetX:0,targetY:0,targetScale:1},enter(e){this.canvas=e||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.animationTime=0,this.hoveredMarker=null,this.isZooming=!1,this.zoomProgress=0,this.zoomTarget=null,this.camera={x:0,y:0,scale:1,targetX:0,targetY:0,targetScale:1},this._clickHandler=this.handleClick.bind(this),this._mouseMoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mouseMoveHandler)},startZoomAnimation(e){this.isZooming=!0,this.zoomProgress=0,this.zoomTarget=e,this.zoomStartTime=this.animationTime;const t=this.canvas.width/2,s=this.canvas.height/2;let n=2.2;e.name==="アジア・オセアニア"?n=2:e.name==="アメリカ大陸"&&(n=2.5),this.camera.targetX=t-e.x*n,this.camera.targetY=s-e.y*n,this.camera.targetScale=n,f("playSE","decide")},updateZoomAnimation(e){if(!this.isZooming)return;const t=this.animationTime-this.zoomStartTime;this.zoomProgress=Math.min(t/this.zoomDuration,1);const s=this.zoomProgress<.5?4*this.zoomProgress*this.zoomProgress*this.zoomProgress:1-Math.pow(-2*this.zoomProgress+2,3)/2,n=.15;this.camera.x=this.camera.x+(this.camera.targetX-this.camera.x)*s*n,this.camera.y=this.camera.y+(this.camera.targetY-this.camera.y)*s*n,this.camera.scale=this.camera.scale+(this.camera.targetScale-this.camera.scale)*s*n,this.zoomProgress>=1&&(this.camera.x=this.camera.targetX,this.camera.y=this.camera.targetY,this.camera.scale=this.camera.targetScale,this.isZooming=!1,setTimeout(()=>{console.log(`大陸選択遷移: 大陸=${this.zoomTarget.name}, 漢検レベル=${this.zoomTarget.kanken_level}`);const i=String(this.zoomTarget.kanken_level);console.log(`遷移時の漢検レベル(文字列化後): ${i}, 型=${typeof i}`);const a={continent:this.zoomTarget.name,region:this.zoomTarget.region||this.zoomTarget.name,kanken_level:i};console.log("遷移時のprops:",a),window.switchScreen("worldStageSelect",a)},200))},update(e){this.animationTime+=e,this.updateZoomAnimation(e),this.ctx.save(),this.ctx.translate(this.camera.x,this.camera.y),this.ctx.scale(this.camera.scale,this.camera.scale),this.ctx.fillStyle="#1E3A8A",this.ctx.fillRect(-this.camera.x/this.camera.scale,-this.camera.y/this.camera.scale,this.canvas.width/this.camera.scale,this.canvas.height/this.camera.scale),this.drawWorldMap(),this.drawTitle(),this.drawContinentMarkers(),this.ctx.restore(),this.isZooming||Z(this.ctx,Ce.x,Ce.y,Ce.width,Ce.height,Ce.text),this.hoveredMarker&&!this.isZooming&&this.drawMarkerTooltip(this.hoveredMarker)},drawWorldMap(){const e=v.worldMap;if(e){const n=this.canvas.width-100,i=this.canvas.height-200;this.ctx.drawImage(e,50,100,n,i),this.ctx.save(),this.ctx.globalAlpha=.3,this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.ctx.fillRect(55,105,n,i),this.ctx.restore()}else console.warn("世界地図画像が見つかりません。シンプルな代替地図を表示します。"),this.drawFallbackWorldMap()},drawFallbackWorldMap(){const s=this.canvas.width-100,n=this.canvas.height-200;this.ctx.fillStyle="#4682B4",this.ctx.fillRect(50,100,s,n),this.ctx.fillStyle="#228B22",this.ctx.strokeStyle="#006400",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.ellipse(50+s*.7,100+n*.4,s*.25,n*.2,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(50+s*.5,100+n*.3,s*.1,n*.15,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(50+s*.5,100+n*.6,s*.15,n*.2,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(50+s*.25,100+n*.3,s*.15,n*.2,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(50+s*.3,100+n*.7,s*.1,n*.15,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.strokeStyle="#2F4F4F",this.ctx.lineWidth=3,this.ctx.strokeRect(50,100,s,n)},drawTitle(){const e=this.canvas.width/2;if(v.woodenSign)this.ctx.drawImage(v.woodenSign,e-200,10,400,80);else{this.ctx.fillStyle="#8B4513",this.ctx.fillRect(e-200,20,400,60),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=2;for(let t=0;t<5;t++)this.ctx.beginPath(),this.ctx.moveTo(e-190,30+t*10),this.ctx.lineTo(e+190,30+t*10),this.ctx.stroke();this.ctx.strokeStyle="#4A4A4A",this.ctx.lineWidth=3,this.ctx.strokeRect(e-200,20,400,60)}this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,this.ctx.textAlign="center",this.ctx.font="bold 28px serif",this.ctx.strokeText("挑戦する大陸を選ぼう",e,55),this.ctx.fillText("挑戦する大陸を選ぼう",e,55)},drawContinentMarkers(){mt.forEach(e=>{const t=this.hoveredMarker===e;let n=1+Math.sin(this.animationTime*.003)*.1;t&&(n=1.4+Math.sin(this.animationTime*.01)*.1);const i=t?5:3;if(this.ctx.fillStyle=`rgba(0, 0, 0, ${t?.4:.3})`,this.ctx.beginPath(),this.ctx.ellipse(e.x+i,e.y+i,25*n,25*n,0,0,2*Math.PI),this.ctx.fill(),t){const o=40*n,l=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,o);l.addColorStop(0,`${e.color}40`),l.addColorStop(.7,`${e.color}20`),l.addColorStop(1,"transparent"),this.ctx.fillStyle=l,this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,o,o,0,0,2*Math.PI),this.ctx.fill()}this.ctx.fillStyle=t?this.lightenColor(e.color,30):e.color,this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,25*n,25*n,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,18*n,18*n,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=t?this.lightenColor(e.color,30):e.color,this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,8*n,8*n,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,this.ctx.textAlign="center",this.ctx.font=`bold ${16*n}px sans-serif`;const a=typeof e.kanken_level=="number"?`${e.kanken_level}級`:`${e.kanken_level}`;if(this.ctx.strokeText(a,e.x,e.y+5),this.ctx.fillText(a,e.x,e.y+5),t){this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,35*n,35*n,0,0,2*Math.PI),this.ctx.stroke();for(let o=0;o<12;o++){const l=(this.animationTime*.003+o*Math.PI/6)%(2*Math.PI),c=45+Math.sin(this.animationTime*.005+o)*5,h=e.x+Math.cos(l)*c,g=e.y+Math.sin(l)*c,d=.5+.5*Math.sin(this.animationTime*.008+o);this.ctx.fillStyle=`rgba(255, 215, 0, ${d})`,this.ctx.beginPath(),this.ctx.ellipse(h,g,4,4,0,0,2*Math.PI),this.ctx.fill()}}})},lightenColor(e,t){const s=parseInt(e.replace("#",""),16),n=Math.round(2.55*t),i=(s>>16)+n,a=(s>>8&255)+n,o=(s&255)+n;return"#"+(16777216+(i<255?i<1?0:i:255)*65536+(a<255?a<1?0:a:255)*256+(o<255?o<1?0:o:255)).toString(16).slice(1)},drawMarkerTooltip(e){const t=e.x*this.camera.scale+this.camera.x,s=e.y*this.camera.scale+this.camera.y,n=t+40,i=s-50,a=200,o=90,l=this.ctx.createLinearGradient(n,i,n,i+o);l.addColorStop(0,"rgba(0, 0, 0, 0.95)"),l.addColorStop(1,"rgba(20, 20, 20, 0.95)"),this.ctx.fillStyle=l,this.ctx.fillRect(n,i,a,o),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(n,i,a,o),this.ctx.strokeStyle="rgba(255, 215, 0, 0.5)",this.ctx.lineWidth=1,this.ctx.strokeRect(n+2,i+2,a-4,o-4),this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.font="bold 16px sans-serif",this.ctx.fillText(`${e.name}`,n+10,i+25),this.ctx.font="14px sans-serif",this.ctx.fillStyle="#FFD700";const c=typeof e.kanken_level=="number"?`漢検 ${e.kanken_level}級 相当`:`漢検 ${e.kanken_level} 相当`;this.ctx.fillText(c,n+10,i+50),this.ctx.fillStyle="#CCCCCC",this.ctx.font="12px sans-serif",this.ctx.fillText("クリックして挑戦する",n+10,i+70)},handleMouseMove(e){if(this.isZooming)return;const t=this.canvas.getBoundingClientRect(),s=this.canvas.width/t.width,n=this.canvas.height/t.height,i=(e.clientX-t.left)*s,a=(e.clientY-t.top)*n,o=(i-this.camera.x)/this.camera.scale,l=(a-this.camera.y)/this.camera.scale,c=this.hoveredMarker;this.hoveredMarker=null;for(const h of mt)if(Math.sqrt((o-h.x)**2+(l-h.y)**2)<=35){this.hoveredMarker=h,this.canvas.style.cursor="pointer",c!==h&&f("playSE","hover");break}this.hoveredMarker||(this.canvas.style.cursor="default")},exit(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler),this.canvas.removeEventListener("mousemove",this._mouseMoveHandler),this.canvas.style.cursor="default"},handleClick(e){if(this.isZooming)return;e.preventDefault();let t,s;e.changedTouches?(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY):(t=e.clientX,s=e.clientY);const n=this.canvas.getBoundingClientRect(),i=this.canvas.width/n.width,a=this.canvas.height/n.height,o=(t-n.left)*i,l=(s-n.top)*a,c=(o-this.camera.x)/this.camera.scale,h=(l-this.camera.y)/this.camera.scale;for(const g of mt)if(Math.sqrt((c-g.x)**2+(h-g.y)**2)<=35){this.startZoomAnimation(g);return}if(C(o,l,Ce)){f("playSE","decide"),f("changeScreen","courseSelect");return}},render(){this.update(0)}},yn=()=>{let e=document.getElementById("uiOverlay");return e||(e=document.createElement("div"),e.id="uiOverlay",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.pointerEvents="none",document.body.appendChild(e)),e},V={width:160,height:40,gap:20,y:540},Qt=V.width*3+V.gap*2,nt=(800-Qt)/2,me={x:nt,y:V.y,width:V.width,height:V.height,text:"もどる"},pe={x:nt+(V.width+V.gap)*1,y:V.y,width:V.width,height:V.height,text:"漢字図鑑"},ye={x:nt+(V.width+V.gap)*2,y:V.y,width:V.width,height:V.height,text:"モンスター"},ee=32,Ee=[{label:"4級",kanken_level:"4",grade:7},{label:"3級",kanken_level:"3",grade:8},{label:"準2級",kanken_level:"準2",grade:9},{label:"2級",kanken_level:"2",grade:10}],Sn={canvas:null,ctx:null,stages:[],stageButtons:[],_clickHandler:null,_mousemoveHandler:null,mouseX:0,mouseY:0,hoveredStage:null,selectedStage:null,animationTime:0,selectedTabLevel:4,selectedGrade:7,continentInfo:null,enter(e){if(f("playBGM","title"),this.canvas=e&&typeof e.getContext=="function"?e:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.continentInfo=(e==null?void 0:e.props)||{},console.log("受け取った大陸情報:",JSON.stringify(this.continentInfo)),this.selectedTabLevel="4",this.selectedGrade=7,this.continentInfo&&this.continentInfo.kanken_level){const t=String(this.continentInfo.kanken_level);if(console.log(`受け取った漢検レベル: ${t}, 型=${typeof t}`),t==="準2")this.selectedTabLevel="準2",this.selectedGrade=9,console.log("準2級を選択しました");else for(const s of Ee)if(String(s.kanken_level)===t){this.selectedTabLevel=s.kanken_level,this.selectedGrade=s.grade,console.log(`タブ選択: 漢検レベル=${this.selectedTabLevel}, grade=${this.selectedGrade}`);break}}this.updateStageList(),this._clickHandler=this.handleClick.bind(this),this._mousemoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mousemoveHandler),yn()},updateStageList(){console.log(`ステージリスト更新: grade=${this.selectedGrade}, continent=${this.continentInfo.continent}, region=${this.continentInfo.region}`),console.log("利用可能なすべてのステージ:"),W.forEach(l=>{l.grade===this.selectedGrade&&console.log(`- ${l.stageId}: grade=${l.grade}, region=${l.region}`)}),this.selectedTabLevel==="準2"?(console.log("準2級（アメリカ大陸）のステージをフィルタリング"),this.stages=W.filter(l=>l.grade===this.selectedGrade&&l.region==="アメリカ大陸")):this.selectedTabLevel==="4"?(console.log("4級（アジア）のステージをフィルタリング"),this.stages=W.filter(l=>l.grade===this.selectedGrade&&l.region==="アジア")):this.selectedTabLevel==="3"?(console.log("3級（ヨーロッパ）のステージをフィルタリング"),this.stages=W.filter(l=>l.grade===this.selectedGrade&&l.region==="ヨーロッパ")):this.selectedTabLevel==="2"?(console.log("2級（アフリカ大陸）のステージをフィルタリング"),this.stages=W.filter(l=>l.grade===this.selectedGrade&&l.region==="アフリカ大陸")):this.stages=W.filter(l=>l.grade===this.selectedGrade),console.log(`フィルタリング結果: ${this.stages.length}件のステージが見つかりました。`),this.stages.forEach(l=>console.log(`- ${l.stageId}: ${l.name}, grade=${l.grade}, region=${l.region}`)),this.stages.length===0&&console.warn(`警告: ${this.selectedGrade}年生のステージが見つかりません。`);const e=this.stages.length,t=110,s=this.canvas.width/2;let n,i,a;e>8?(n=36,i=5,a=14):e>5?(n=40,i=8,a=16):(n=50,i=15,a=20);const o=s-60;this.stageButtons=this.stages.map((l,c)=>({id:l.stageId,text:l.name,x:30,y:t+c*(n+i),width:o,height:n,fontSize:a,stage:l}))},isStageCleared(e){var n;const t=localStorage.getItem(`clear_${e}`),s=r.stageProgress&&((n=r.stageProgress[e])==null?void 0:n.cleared);return t||s},getNextStage(){for(const e of this.stages)if(!this.isStageCleared(e.stageId))return e;return null},handleMouseMove(e){const t=this.canvas.getBoundingClientRect(),s=this.canvas.width/t.width,n=this.canvas.height/t.height;if(this.mouseX=(e.clientX-t.left)*s,this.mouseY=(e.clientY-t.top)*n,this.hoveredStage=null,this.stageButtons){for(const i of this.stageButtons)if(C(this.mouseX,this.mouseY,i)){this.hoveredStage=i.stage;return}}for(const i of this.stages)if(i.pos){const{x:a,y:o}=i.pos;if(this.mouseX>=a&&this.mouseX<=a+ee&&this.mouseY>=o&&this.mouseY<=o+ee){this.hoveredStage=i;return}}},drawTooltip(e){if(!e)return;const t=this.ctx,s=this.mouseX+20,n=this.mouseY-80,i=200,a=100;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(s,n,i,a),t.strokeStyle="#fff",t.lineWidth=2,t.strokeRect(s,n,i,a),t.fillStyle="#fff",t.font="14px sans-serif",t.textAlign="left",t.textBaseline="top";let o=10;t.fillText(`ステージ: ${e.name}`,s+10,n+o),o+=20,e.recommendedLevel&&(t.fillText(`推奨Lv: ${e.recommendedLevel}`,s+10,n+o),o+=20);const l=typeof this.selectedTabLevel=="number"?`漢検 ${this.selectedTabLevel}級 相当`:`漢検 ${this.selectedTabLevel} 相当`;t.fillText(l,s+10,n+o),o+=20;const c=this.isStageCleared(e.stageId);t.fillStyle=c?"#4CAF50":"#FFC107",t.fillText(c?"クリア済み":"未クリア",s+10,n+o)},drawRichButton(e,t,s,n,i,a,o="#2980b9",l=!1,c=!1){e.save();const h=l?1.05:1,g=l?this.lightenColor(o,15):o,d=c?3:l?2:1;if(l){const E=t+n/2,b=s+i/2,T=n*h,A=i*h;t=E-T/2,s=b-A/2,n=T,i=A}const m=l?4:3,y=l?.4:.3;e.fillStyle=`rgba(0, 0, 0, ${y})`,e.fillRect(t+m,s+m,n,i);const p=e.createLinearGradient(t,s,t,s+i);p.addColorStop(0,this.lightenColor(g,20)),p.addColorStop(1,this.darkenColor(g,20)),e.fillStyle=p,e.fillRect(t,s,n,i),e.strokeStyle=c?"#FFFFFF":this.darkenColor(g,30),e.lineWidth=d,e.strokeRect(t,s,n,i);const k=e.createLinearGradient(t,s,t,s+i*.3),w=l?.4:.3;k.addColorStop(0,`rgba(255, 255, 255, ${w})`),k.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=k,e.fillRect(t,s,n,i*.3),l&&(e.strokeStyle="rgba(255, 255, 255, 0.6)",e.lineWidth=1,e.strokeRect(t+1,s+1,n-2,i-2)),e.fillStyle="white",e.font='18px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.textBaseline="middle",e.fillText(a,t+n/2,s+i/2),e.restore()},drawPanelBackground(e,t,s,n,i,a="default"){e.save();let o="rgba(0, 0, 0, 0.7)";if(a==="stone"?o="rgba(50, 50, 60, 0.8)":a==="paper"&&(o="rgba(245, 235, 215, 0.9)"),e.fillStyle=o,e.fillRect(t,s,n,i),e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=2,e.strokeRect(t,s,n,i),a==="stone"){e.strokeStyle="rgba(255, 255, 255, 0.2)",e.lineWidth=1;for(let l=1;l<3;l++)e.beginPath(),e.moveTo(t,s+i*l/3),e.lineTo(t+n,s+i*l/3),e.stroke()}e.restore()},lightenColor(e,t){const s=parseInt(e.replace("#",""),16),n=Math.round(2.55*t),i=(s>>16)+n,a=(s>>8&255)+n,o=(s&255)+n;return"#"+(16777216+(i<255?i<1?0:i:255)*65536+(a<255?a<1?0:a:255)*256+(o<255?o<1?0:o:255)).toString(16).slice(1)},darkenColor(e,t){const s=parseInt(e.replace("#",""),16),n=Math.round(2.55*t),i=(s>>16)-n,a=(s>>8&255)-n,o=(s&255)-n;return"#"+(16777216+(i>255?255:i<0?0:i)*65536+(a>255?255:a<0?0:a)*256+(o>255?255:o<0?0:o)).toString(16).slice(1)},update(e){const{ctx:t,canvas:s,stages:n}=this,i=s.width,a=s.height;t.clearRect(0,0,i,a),this.animationTime+=e||16;const o=t.createLinearGradient(0,0,0,a);o.addColorStop(0,"#1a365d"),o.addColorStop(1,"#2c5282"),t.fillStyle=o,t.fillRect(0,0,i,a);const l=i/2,c=60,h=i/2,g=a-120;let d=null;switch(String(this.selectedTabLevel)){case"4":d=v.stageSelect12;break;case"3":d=v.stageSelect13;break;case"準2":d=v.stageSelect14;break;case"2":d=v.stageSelect15;break;default:d=v.worldMap}console.log(`選択された背景画像: selectedTabLevel=${this.selectedTabLevel}, 画像=${d?"読み込み成功":"未読み込み"}`),d?t.drawImage(d,l,c,h,g):this.drawFallbackContinentMap(l,c,h,g);const m=10,y=70,p=i/2-20,k=a-140;this.drawPanelBackground(t,m,y,p,k,"stone");const w=Ee.length,E=i/w,b=50;t.textAlign="center",t.textBaseline="middle",t.font='bold 18px "UDデジタル教科書体", sans-serif',Ee.forEach((P,Y)=>{const K=Y*E,se=P.kanken_level===this.selectedTabLevel,S=t.createLinearGradient(K,0,K,b);se?(S.addColorStop(0,"#4299e1"),S.addColorStop(1,"#2b6cb0")):(S.addColorStop(0,"#4a5568"),S.addColorStop(1,"#2d3748")),t.fillStyle=S,t.fillRect(K,0,E,b),se&&(t.strokeStyle="#fff",t.lineWidth=2,t.strokeRect(K+1,1,E-2,b-2)),se&&(t.shadowColor="rgba(0,0,0,0.5)",t.shadowBlur=3,t.shadowOffsetX=1,t.shadowOffsetY=1),t.fillStyle="#fff",t.fillText(P.label,K+E/2,b/2),t.shadowColor="transparent",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0}),t.fillStyle="white",t.font='bold 26px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="top";const T=typeof this.selectedTabLevel=="number"?`漢検${this.selectedTabLevel}級`:`漢検${this.selectedTabLevel}`,A=t.measureText(`${this.continentInfo.continent||""} (${T})`).width,G=10,F=m+p/2-A/2-G,$=y+10,I=A+G*2,N=36;t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(F,$,I,N),t.strokeStyle="rgba(255, 255, 255, 0.5)",t.lineWidth=1,t.strokeRect(F,$,I,N),t.fillStyle="white",t.shadowColor="rgba(0,0,0,0.7)",t.shadowBlur=4,t.shadowOffsetX=2,t.shadowOffsetY=2,t.fillText(`${this.continentInfo.continent||""} (${T})`,m+p/2,y+15),t.shadowColor="transparent",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0,this.stageButtons&&this.stageButtons.length>0?this.stageButtons.forEach(P=>{const Y=P.stage,K=this.isStageCleared(Y.stageId),se=this.hoveredStage&&this.hoveredStage.stageId===Y.stageId;let S="#2980b9";K&&(S="#27ae60");const x=this.selectedStage&&this.selectedStage.stageId===Y.stageId;x&&(S="#FF8C00"),this.drawRichButton(t,P.x,P.y,P.width,P.height,P.text,S,se,x),t.textAlign="left",t.textBaseline="top",t.font="12px sans-serif",x&&(t.fillStyle="#FFFFFF",t.font="16px sans-serif",t.fillText("✓",P.x+10,P.y+5)),K&&(t.fillStyle="#FFD700",t.font="16px sans-serif",t.fillText("⭐",P.x+P.width-25,P.y+5)),Y.recommendedLevel&&(t.fillStyle="#fff",t.font="10px sans-serif",t.fillText(`推奨Lv.${Y.recommendedLevel}`,P.x+5,P.y+P.height-15))}):(t.fillStyle="#ccc",t.font="16px sans-serif",t.textAlign="center",t.fillText("この大陸・級のステージはまだありません",m+p/2,y+100)),n.forEach(P=>{if(P.pos){const{x:Y,y:K}=P.pos,se=this.isStageCleared(P.stageId),S=this.hoveredStage&&this.hoveredStage.stageId===P.stageId,x=this.selectedStage&&this.selectedStage.stageId===P.stageId;let B=v.markerPref,H=1,z=1;if(x){const _=Math.sin(this.animationTime*.01)*.5+.5;H=1+_*.3,z=.8+_*.2,t.save(),t.globalAlpha=z,t.filter="hue-rotate(120deg) saturate(2) brightness(1.3)"}else se?(B=v.markerCleared||v.markerPref,t.save(),t.globalAlpha=1,t.filter="hue-rotate(45deg) saturate(1.5) brightness(1.2)"):(t.save(),t.globalAlpha=.7);if(B){const _=ee*H,O=(_-ee)/2,Q=(_-ee)/2;t.drawImage(B,Y-O,K-Q,_,_)}else{t.fillStyle=se?"#FFD700":"#f00";const _=ee*H,O=(_-ee)/2,Q=(_-ee)/2;t.fillRect(Y-O,K-Q,_,_)}S&&(t.shadowColor="#FFD700",t.shadowBlur=15,t.fillStyle="#fff",t.font="12px sans-serif",t.textAlign="center",t.fillText(P.name,Y,K-20)),t.restore()}}),this._drawFooterBar(t,i,a),this.drawTooltip(this.hoveredStage)},handleClick(e){if(this.isZooming)return;e.preventDefault();let t,s;e.changedTouches?(t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY):(t=e.clientX,s=e.clientY);const n=this.canvas.getBoundingClientRect(),i=this.canvas.width/n.width,a=this.canvas.height/n.height,o=(t-n.left)*i,l=(s-n.top)*a,c=Ee.length,h=this.canvas.width/c;if(l<=50){const d=Math.floor(o/h);if(d>=0&&d<Ee.length){const m=Ee[d];this.selectedTabLevel=m.kanken_level,this.selectedGrade=m.grade,this.updateStageList(),f("playSE","decide");return}}for(const d of this.stageButtons)if(C(o,l,d)){f("playSE","decide"),this.selectedStage&&this.selectedStage.stageId===d.stage.stageId?(r.currentStageId=d.id,Ie(d.id),f("changeScreen","stageLoading")):this.selectedStage=d.stage;return}for(const d of this.stages)if(d.pos){const{x:m,y}=d.pos;if(o>=m-ee/2&&o<=m+ee/2&&l>=y-ee/2&&l<=y+ee/2){f("playSE","decide"),this.selectedStage&&this.selectedStage.stageId===d.stageId?(r.currentStageId=d.stageId,Ie(d.stageId),f("changeScreen","stageLoading")):this.selectedStage=d;return}}if(C(o,l,me)){f("playSE","decide"),f("changeScreen","continentSelect");return}if(C(o,l,pe)){f("playSE","decide"),f("changeScreen","kanjiDex");return}if(C(o,l,ye)){f("playSE","decide"),f("changeScreen","proverbMonsterDex");return}},drawFallbackContinentMap(e,t,s,n){const i=this.ctx;i.fillStyle="#4682B4",i.fillRect(e,t,s,n),i.fillStyle="#228B22",i.strokeStyle="#006400",i.lineWidth=2,this.continentInfo.continent==="アジア・オセアニア"?(i.beginPath(),i.ellipse(e+s*.5,t+n*.4,s*.4,n*.3,0,0,Math.PI*2),i.fill(),i.stroke(),i.beginPath(),i.ellipse(e+s*.6,t+n*.7,s*.15,n*.1,0,0,Math.PI*2),i.fill(),i.stroke()):this.continentInfo.continent==="ヨーロッパ・中東"?(i.beginPath(),i.ellipse(e+s*.4,t+n*.3,s*.3,n*.2,0,0,Math.PI*2),i.fill(),i.stroke(),i.beginPath(),i.ellipse(e+s*.6,t+n*.5,s*.2,n*.15,0,0,Math.PI*2),i.fill(),i.stroke()):this.continentInfo.continent==="アフリカ"?(i.beginPath(),i.ellipse(e+s*.5,t+n*.5,s*.3,n*.4,0,0,Math.PI*2),i.fill(),i.stroke()):this.continentInfo.continent==="アメリカ大陸"&&(i.beginPath(),i.ellipse(e+s*.4,t+n*.3,s*.25,n*.2,0,0,Math.PI*2),i.fill(),i.stroke(),i.beginPath(),i.ellipse(e+s*.5,t+n*.6,s*.2,n*.25,0,0,Math.PI*2),i.fill(),i.stroke())},_drawFooterBar(e,t,s){const n=nt-10,i=V.y-10,a=Qt+20,o=V.height+20;e.fillStyle="rgba(0, 0, 0, 0.6)",e.fillRect(n,i,a,o),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=1,e.strokeRect(n,i,a,o);const l=15,c=e.createLinearGradient(n,i,n,i+l);c.addColorStop(0,"rgba(255, 255, 255, 0.2)"),c.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=c,e.fillRect(n,i,a,l);const h=C(this.mouseX,this.mouseY,me),g=C(this.mouseX,this.mouseY,pe),d=C(this.mouseX,this.mouseY,ye);this.drawRichButton(e,me.x,me.y,me.width,me.height,me.text,h?"#4A90E2":"#ccc",h),this.drawRichButton(e,pe.x,pe.y,pe.width,pe.height,pe.text,g?"#4A90E2":"#ccc",g),this.drawRichButton(e,ye.x,ye.y,ye.width,ye.height,ye.text,d?"#4A90E2":"#ccc",d)}},vn="krb_proverb_monster_dex",es="krb_seen_proverb_monsters";function ts(){try{const e=localStorage.getItem(vn),t=e?JSON.parse(e):[];if(!Array.isArray(t))return new Set;const s=t.filter(n=>typeof n=="string");return new Set(s)}catch(e){return console.error("proverbMonsterDex: 図鑑のロードに失敗しました",e),new Set}}function Ct(){try{const e=localStorage.getItem(es),t=e?JSON.parse(e):[];if(!Array.isArray(t))return new Set;const s=t.filter(n=>typeof n=="string");return new Set(s)}catch(e){return console.error("proverbMonsterDex: 確認済みモンスターのロードに失敗しました",e),new Set}}function kn(e){try{localStorage.setItem(es,JSON.stringify([...e])),We.syncAll()}catch(t){console.error("proverbMonsterDex: 確認済みモンスターの保存に失敗しました",t)}}function xn(e){const t=Ct();t.has(e)||(t.add(e),kn(t))}function bn(e){const t=ts(),s=Ct();return t.has(e)&&!s.has(e)}const ss={7:"proverbs",8:"proverbs",9:"proverbs",10:"proverbs"},ns={7:"4級",8:"3級",9:"準2級",10:"2級"},is={7:"アジア",8:"ヨーロッパ",9:"アメリカ大陸",10:"アフリカ大陸"},as=new IntersectionObserver(e=>{e.forEach(t=>{if(t.isIntersecting){const s=t.target.querySelector("img");s.src=s.dataset.thumb,as.unobserve(t.target)}})},{rootMargin:"200px"});function wn(e){const t=document.createElement("div");t.classList.add("monster-card"),t.classList.add("proverb-monster-card"),e.collected||t.classList.add("locked"),t.addEventListener("click",()=>{if(e.collected){Cn(e),xn(e.id);const o=t.querySelector(".new-badge");o&&o.remove()}});const s=document.createElement("img");ss[e.grade];const n=`/assets/images/proverbs/thumb/${e.id}.webp`;s.dataset.thumb=n,s.alt=e.name,t.appendChild(s);const i=document.createElement("p");i.textContent=e.collected?e.name:"？？？",i.classList.add("monster-name"),t.appendChild(i);const a=document.createElement("p");if(a.textContent=e.collected?e.proverb||"不明":"？？？",a.classList.add("monster-proverb"),t.appendChild(a),bn(e.id)){const o=document.createElement("div");o.classList.add("new-badge"),o.textContent="NEW!",t.appendChild(o)}return as.observe(t),t}function Cn(e){const t=document.createElement("div");t.classList.add("monster-modal"),t.classList.add("proverb-monster-modal");const s=document.createElement("div");s.classList.add("modal-content");const n=document.createElement("button");n.classList.add("modal-close"),n.textContent="×",n.onclick=()=>t.remove();const i=document.createElement("img");ss[e.grade],i.src=`/assets/images/proverbs/full/${e.id}.webp`,i.alt=e.name,i.classList.add("modal-monster-image");const a=document.createElement("div");a.classList.add("monster-info"),a.innerHTML=`
    <h2>${e.name}</h2>
    <p><strong>漢検級:</strong> ${ns[e.grade]||"不明"}</p>
    <p><strong>地域:</strong> ${is[e.grade]||"不明"}</p>
    <p><strong>ことわざ:</strong> ${e.proverb||"不明"}</p>
    <p><strong>読み:</strong> ${e.reading||"不明"}</p>
    <p><strong>意味:</strong> ${e.meaning||"詳細情報なし"}</p>
    <p><strong>例文:</strong> ${e.example||"例文なし"}</p>
  `,s.appendChild(n),s.appendChild(i),s.appendChild(a),t.appendChild(s),t.onclick=o=>{o.target===t&&t.remove()},document.body.appendChild(t),f("playSE","decide")}const En={canvas:null,dexSet:null,seenSet:null,allMonsterIds:[],filteredMonsterIds:[],itemsPerPage:15,currentPage:0,totalPages:0,currentRegionFilter:"all",currentSortOrder:"id",enter(e){this.canvas=e||document.getElementById("gameCanvas"),this.canvas.style.display="none",this.dexSet=ts(),this.seenSet=Ct(),this.allMonsterIds=$t().filter(t=>t.startsWith("PRV-")),this.applyFiltersAndSort(),this.currentPage=0,this.renderPage()},calculateRegionCompletion(){const e={};for(let t=7;t<=10;t++){const s=this.allMonsterIds.filter(i=>{const a=re(i);return a&&a.grade===t}),n=s.filter(i=>this.dexSet.has(i));e[t]={total:s.length,collected:n.length,isComplete:s.length>0&&n.length===s.length}}return e},applyFiltersAndSort(){let e=this.allMonsterIds;this.currentRegionFilter!=="all"&&(e=this.allMonsterIds.filter(t=>{const s=re(t);return s&&s.grade===this.currentRegionFilter})),this.currentSortOrder==="name"?e.sort((t,s)=>{const n=re(t),i=re(s);return!n||!i?0:n.name.localeCompare(i.name,"ja")}):e.sort((t,s)=>t.localeCompare(s)),this.filteredMonsterIds=e,this.totalPages=Math.ceil(this.filteredMonsterIds.length/this.itemsPerPage)},renderPage(){let e=document.getElementById("proverbMonsterContainer");e||(e=document.createElement("div"),e.id="proverbMonsterContainer",e.className="monster-container proverb-monster-container",document.body.appendChild(e)),e.innerHTML="",e.style.display="grid";const t=this.calculateRegionCompletion(),s=document.createElement("div");s.className="collection-stats";const n=this.dexSet.size,i=this.allMonsterIds.length,a=i>0?Math.round(n/i*100):0,o=document.createElement("div");o.className="stats-text",o.textContent=`ことわざモンスター収集率: ${a}% (${n} / ${i})`;const l=document.createElement("div");l.className="progress-bar";const c=document.createElement("div");c.className="progress-fill",c.style.width=`${a}%`,l.appendChild(c),s.appendChild(o),s.appendChild(l),e.appendChild(s);const h=document.createElement("div");h.className="dex-navigation";const g=document.createElement("button");g.textContent="ステージ選択へ",g.onclick=()=>f("changeScreen","worldStageSelect");const d=document.createElement("select");d.className="region-filter";let m='<option value="all">すべて表示</option>';for(let I=7;I<=10;I++){const N=is[I],P=ns[I],K=t[I].isComplete?" 👑":"";m+=`<option value="${I}">${N}（${P}）${K}</option>`}d.innerHTML=m,d.value=this.currentRegionFilter,d.onchange=I=>{this.currentRegionFilter=I.target.value==="all"?"all":parseInt(I.target.value),this.applyFiltersAndSort(),this.currentPage=0,this.renderPage(),f("playSE","decide")};const y=document.createElement("button");y.textContent="図鑑番号順",y.className=this.currentSortOrder==="id"?"sort-active":"",y.onclick=()=>{this.currentSortOrder="id",this.applyFiltersAndSort(),this.currentPage=0,this.renderPage(),f("playSE","decide")};const p=document.createElement("button");p.textContent="五十音順",p.className=this.currentSortOrder==="name"?"sort-active":"",p.onclick=()=>{this.currentSortOrder="name",this.applyFiltersAndSort(),this.currentPage=0,this.renderPage(),f("playSE","decide")};const k=document.createElement("button");k.textContent="前のページ",k.disabled=this.currentPage===0,k.onclick=()=>this.changePage(this.currentPage-1);const w=document.createElement("span");w.className="page-info",w.textContent=`${this.currentPage+1} / ${this.totalPages} ページ`;const E=document.createElement("button");E.textContent="次のページ",E.disabled=this.currentPage>=this.totalPages-1,E.onclick=()=>this.changePage(this.currentPage+1);const b=document.createElement("div");b.className="nav-controls-left",b.appendChild(g),b.appendChild(d);const T=document.createElement("div");T.className="nav-controls-center",T.appendChild(y),T.appendChild(p);const A=document.createElement("div");A.className="nav-controls-right",A.appendChild(k),A.appendChild(w),A.appendChild(E),h.appendChild(b),h.appendChild(T),h.appendChild(A),e.appendChild(h);const G=this.currentPage*this.itemsPerPage,F=G+this.itemsPerPage;this.filteredMonsterIds.slice(G,F).forEach(I=>{const N=re(I);if(N){N.collected=this.dexSet.has(I);const P=wn(N);e.appendChild(P)}})},changePage(e){e>=0&&e<this.totalPages&&(this.currentPage=e,this.renderPage(),f("playSE","decide"))},exit(){const e=document.getElementById("proverbMonsterContainer");e&&(e.style.display="none",e.innerHTML="");const t=document.querySelector(".proverb-monster-modal");t&&t.remove(),this.canvas&&(this.canvas.style.display="")},update(e){},render(){}};async function Tn(){const{stageData:e}=await Ms(),t={title:tn,playerNameInput:un,menu:sn,status:gn,achievements:Jt,gradeSelect:qs,regionSelect:Js,prefSelect:Qs,stageSelect:Kt,settings:nn,reviewStage:zt,kanjiDex:Vt,monsterDex:cn,resultWin:qt,result:dn,gameOver:hn,stageLoading:fn,courseSelect:mn,continentSelect:pn,worldStageSelect:Sn,proverbMonsterDex:En,battle:Pt("default")};e.forEach(i=>{t[i.stageId]=Pt(i.stageId)});const s=new Hs("title",t);function n(i,a){if(console.log(`画面遷移: ${i}, props=`,a),["title","menu","stageSelect","stageLoading","battle","worldStageSelect","continentSelect","courseSelect"].includes(i)){console.log(`安全な画面[${i}]への遷移を許可`),s.change(i,a);return}if(e.some(l=>l.stageId===i)){console.warn(`ステージID[${i}]への直接遷移を検出。battleに変更します。`),r.currentStageId=i,s.change("battle",a);return}s.change(i,a)}return ie("changeScreen",n),window.switchScreen=n,s}const Se=[],je=document.getElementById("gameCanvas");je.width=800;je.height=600;const In=je.getContext("2d"),Me=new yt;document.body.addEventListener("pointerdown",()=>{f("playBGM","title")},{once:!0});let At=performance.now();function os(e){const t=e-At;At=e,r.playerStats.playtimeSeconds+=t/1e3,ks(t),xs(),Bn(In),requestAnimationFrame(os)}function Bn(e){if(Se.length===0)return;const t=je.height-150,s=400,n=80,i=(je.width-s)/2;Se.forEach((a,o)=>{const l=t-o*(n+10);e.save(),e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=10,e.shadowOffsetX=0,e.shadowOffsetY=4;const c=e.createLinearGradient(i,l,i,l+n);c.addColorStop(0,"#FFD700"),c.addColorStop(1,"#FFA500"),e.fillStyle=c,e.fillRect(i,l,s,n),e.shadowColor="transparent",e.strokeStyle="#B8860B",e.lineWidth=3,e.strokeRect(i,l,s,n),e.fillStyle="rgba(255, 255, 255, 0.2)",e.fillRect(i+10,l+10,60,n-20),e.fillStyle="#000",e.textAlign="left",e.textBaseline="middle",e.font='bold 24px "UDデジタル教科書体", sans-serif',e.fillText("🏆",i+25,l+n/2-10),e.font='bold 18px "UDデジタル教科書体", sans-serif',e.fillText("実績解除！",i+80,l+25),e.font='16px "UDデジタル教科書体", sans-serif',e.fillStyle="#333";let h=a.title;h.length>20&&(h=h.substring(0,20)+"..."),e.fillText(h,i+80,l+50);const g=["✨","⭐","💫"];for(let d=0;d<3;d++){const m=i+s-60+d*20,y=l+20+Math.sin(Date.now()/500+d)*10;e.font="20px sans-serif",e.fillStyle="#FFF",e.fillText(g[d],m,y)}e.restore()})}(async function(){if(console.log("🔧 Init start"),await ws(),window.fsm=await Tn(),!As())return;const t=await Fs();console.log("UID:",t==null?void 0:t.uid),await Ls();try{await Ge(),console.log("✅ ゲーム起動時の実績チェック完了")}catch(s){console.error("❌ ゲーム起動時の実績チェックでエラー:",s)}if(!r.playerName||["ゲスト","ななしのごんべえ","新規プレイヤー"].includes(r.playerName)){const s=prompt("プレイヤー名を入力してください（10文字以内）","");if(s){const n=s.trim().slice(0,10);Lt(n),t&&t.uid&&await xt(t.uid,n)}}r.currentStageId="hokkaido_area1",We.initialize(),console.log("✅ Init done → Start loop"),requestAnimationFrame(os)})();ie("playSE",e=>Me.playSE(e));ie("playBGM",(e,t=!0)=>Me.playBGM(e,t));ie("setBGMVolume",e=>Me.setBGMVolume(e));ie("setSEVolume",e=>Me.setSEVolume(e));ie("getBGMVolume",e=>e(Me.getBGMVolume()));ie("getSEVolume",e=>e(Me.getSEVolume()));ie("achievementUnlocked",e=>{console.log(`🎉 実績解除通知: ${e.title}`),Se.push({title:e.title,description:e.description,timestamp:Date.now()}),setTimeout(()=>{const t=Se.findIndex(s=>s.timestamp===Date.now()-3500);t!==-1&&Se.splice(t,1),Se.length>0&&Se.shift()},3500)});ie("addToReview",e=>{ue.add(e)});
